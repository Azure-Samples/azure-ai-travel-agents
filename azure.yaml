# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: ai-travel-agents
metadata:
  template: ai-travel-agents@1.13.1
services:
  api-langchain-js:
    project: packages/api-langchain-js
    host: containerapp
    language: ts
    docker:
      context: .
      path: Dockerfile

  api-llamaindex-ts:
    project: packages/api-llamaindex-ts
    host: containerapp
    language: ts
    docker:
      context: .
      path: Dockerfile

  api-maf-python:
    project: packages/api-maf-python
    host: containerapp
    language: python
    docker:
      context: .
      path: Dockerfile

  ui-angular:
    project: packages/ui-angular
    host: containerapp
    language: ts
    docker:
      context: .
      path: Dockerfile.production
    hooks:
      prebuild:
        windows:
          shell: pwsh
          run: 'echo "NG_API_URL=""$env:NG_API_URL""" > .env.production'
        posix:
          shell: sh
          run: 'echo NG_API_URL=\"$NG_API_URL\" > .env.production'

  mcp-customer-query:
    project: packages/mcp-servers/customer-query/AITravelAgent.CustomerQueryServer/
    host: containerapp
    language: dotnet
    docker:
      context: ..
      path: ../Dockerfile
      remoteBuild: true

  mcp-destination-recommendation:
    project: packages/mcp-servers/destination-recommendation
    host: containerapp
    language: java
    docker:
      path: ./Dockerfile
      context: .
      remoteBuild: true

  mcp-itinerary-planning:
    project: packages/mcp-servers/itinerary-planning
    host: containerapp
    language: python
    docker:
      path: ./Dockerfile
      context: .
      remoteBuild: true

  mcp-echo-ping:
    project: packages/mcp-servers/echo-ping
    language: ts
    host: containerapp
    docker:
      path: ./Dockerfile
      context: .

hooks:
  postprovision:
    windows:
      shell: pwsh
      run: ./infra/hooks/postprovision.ps1
    posix:
      shell: sh
      run: ./infra/hooks/postprovision.sh

workflows:
  up:
    steps:
      - azd: provision
      - azd: deploy api-langchain-js
      - azd: deploy api-llamaindex-ts
      - azd: deploy ui-angular
      - azd: deploy mcp-customer-query
      - azd: deploy mcp-destination-recommendation
      - azd: deploy mcp-itinerary-planning
      - azd: deploy mcp-echo-ping

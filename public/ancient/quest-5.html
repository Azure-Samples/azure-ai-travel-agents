<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ritual of Streaming Wisdom - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Pyramid of Infinite Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: The Ritual of Streaming Wisdom</h1>
<hr>
<p>In the heart of the Pyramid of Infinite Agents lies the Chamber of Streaming Wisdom, where the Codex Orchestrator channels sacred insights through a web of interconnected glyphs. Explorers uncover the ancient mechanisms that enable seamless communication between the pyramid&#39;s tools and its agents, revealing the secrets of real-time wisdom streaming. The chamber‚Äôs glyphs pulse with energy as they process inquiries, relay messages, and synchronize the tools‚Äô responses with unmatched precision.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Glyph Activation Mechanism</strong>: How does the system initialize and manage the streaming of wisdom (messages) between agents and tools?</li>
<li>‚ö° <strong>Tool Synchronization Ritual</strong>: How are tools dynamically fetched and integrated into the communication process for wisdom sharing?</li>
<li>üõ°Ô∏è <strong>Error Safeguards</strong>: What mechanisms protect the streaming wisdom process from interruptions or corrupted data?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a>:</span> Glyph Communication Service</h3>
<p>This file serves as the central hub for managing the communication flow between the pyramid‚Äôs tools and agents. The <code class="inline-code">ChatService</code> class orchestrates the streaming of wisdom by initializing agent interactions, processing events, and handling errors. It employs reactive patterns such as <code class="inline-code">BehaviorSubject</code> and Angular signals to ensure real-time updates and smooth transitions between states.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> dynamically retrieves and filters tools based on their availability and selection status, ensuring only relevant tools are integrated into the wisdom-sharing process.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a> initiates the streaming ritual by sending user inquiries to the pyramid‚Äôs tools and managing the resulting responses.</li>
<li><code class="inline-code">processAgentEvents</code> handles the incoming wisdom streams from tools, parsing metadata and updating the communication state.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code> synchronizes the wisdom stream with the agent‚Äôs state, ensuring accurate and timely updates to the user interface.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">showErrorMessage</code></a> provides safeguards against interruptions by displaying error messages and logging issues for diagnostics.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>Dynamically retrieves available tools from the Codex Orchestrator using the <code class="inline-code">ApiService</code>.</li>
<li>Filters tools based on their selection status to ensure only relevant tools participate in the wisdom-sharing ritual.</li>
<li>Demonstrates extensibility by enabling dynamic tool discovery without hardcoding dependencies.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>Initiates the wisdom streaming ritual by sending user inquiries to the pyramid‚Äôs tools.</li>
<li>Updates the communication buffer with the user‚Äôs message, ensuring it is stored and processed.</li>
<li>Employs reactive patterns (<code class="inline-code">isLoading</code>, <code class="inline-code">assistantMessageInProgress</code>) to manage the state during streaming.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;

    switch (event.event) {
      case &#39;StartEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });

        this.assistantMessageInProgress.set(false);
        break;
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });

        this.assistantMessageInProgress.set(false);
        this.isLoading.set(false);
        break;
      case &#39;AgentToolCallResult&#39;:
        let state = {};
        if (typeof event.data.raw === &#39;string&#39;) {
          state = {
            reasoning: [
              {
                content: event.data.raw,
              },
            ],
          };
        }
        this.updateAndNotifyAgentChatMessageState(delta, state);
        break;

      case &#39;AgentStream&#39;:
        this.assistantMessageInProgress.set(true);

        if (delta.trim()) {
          this.agentEventsBuffer.push(event);
          this.updateAndNotifyAgentChatMessageState(delta, {
            metadata: {
              events: this.agentEventsBuffer,
            },
          });
        }
        break;
    }
  }
}
</code></pre>
<ul>
<li>Parses incoming wisdom streams from tools and updates the communication state.</li>
<li>Handles various event types (<code class="inline-code">StartEvent</code>, <code class="inline-code">StopEvent</code>, <code class="inline-code">AgentStream</code>) to synchronize the streaming process.</li>
<li>Ensures accurate updates to the agent‚Äôs state and user interface.</li>
</ul>
<hr>
<pre><code class="language-typescript">updateAndNotifyAgentChatMessageState(
  delta: string,
  state?: Partial&lt;ChatMessage&gt;
) {
  const lastMessage = this.messagesBuffer[this.messagesBuffer.length - 1];
  if (lastMessage?.role === &#39;assistant&#39;) {
    lastMessage.content += delta;
    lastMessage.metadata = {
      ...lastMessage.metadata,
      ...state?.metadata,
      events: state?.metadata?.events,
    };
    lastMessage.reasoning = [
      ...(lastMessage.reasoning || []),
      ...(state?.reasoning || []),
    ];
    lastMessage.timestamp = new Date();
    this.messagesStream.next([...this.messagesBuffer]);
  }
}
</code></pre>
<ul>
<li>Synchronizes the wisdom stream with the agent‚Äôs state, ensuring real-time updates to the user interface.</li>
<li>Aggregates metadata and reasoning content to provide a comprehensive view of the streaming process.</li>
<li>Demonstrates modularity by encapsulating state updates and notifications in a single method.</li>
</ul>
<hr>
<pre><code class="language-typescript">showErrorMessage(error: unknown) {
  toast.error(&#39;Oops! Something went wrong.&#39;, {
    duration: 5000,
    description: (error as Error).message,
    action: {
      label: &#39;Close&#39;,
      onClick: () =&gt; console.log(&#39;Closed&#39;),
    },
  });
}
</code></pre>
<ul>
<li>Protects the wisdom streaming process from interruptions by displaying error messages to the user.</li>
<li>Provides diagnostic information for troubleshooting issues during communication.</li>
<li>Uses <code class="inline-code">toast</code> for user-friendly error notifications.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Investigate how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> dynamically retrieves tools to understand the flexibility of tool discovery and integration.</li>
<li>Study the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a> method to learn how user inquiries are initiated and processed within the wisdom-sharing ritual.</li>
<li>Explore the <code class="inline-code">processAgentEvents</code> function to understand how various event types are handled and synchronized during streaming.</li>
</ul>
<hr>
<p>You have mastered all the secrets of the Pyramid of Infinite Agents! Your adventure is complete.</p>
<p>Lo, seeker of sacred enlightenment, thou hast unlocked the fount of Streaming Wisdom, ascending yet closer to the hallowed apex of thy quest‚Äîpress on, for the stars themselves herald thy triumph! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
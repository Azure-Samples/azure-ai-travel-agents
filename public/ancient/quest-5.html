<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 5: The Oracle‚Äôs Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Pyramid of Infinite Journeys</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: The Oracle‚Äôs Interface</h1>
<hr>
<p>The Pyramid of Infinite Journeys holds its most enigmatic chamber, the Oracle‚Äôs Interface, a space where sacred glyphs pulse with energy. This chamber was once the nerve center of the Codexian civilization, where seekers of wisdom communed with the Oracle‚Äîa system that harmonized the voices of countless agents into one cohesive stream of guidance. As you activate the glyphs, you uncover a complex mechanism: a multi-agent orchestration system that seamlessly integrates specialized tools. Your challenge is to decode the Oracle‚Äôs rituals, from its dynamic tool discovery to the flow of its streaming wisdom.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Glyph Activation</strong>: How does the <code class="inline-code">ChatService</code> coordinate with the <code class="inline-code">ApiService</code> to manage streaming communication and tool usage in the Oracle&#39;s Interface?</li>
<li>‚ö° <strong>Flow of Prophecy</strong>: What patterns are used in <code class="inline-code">processAgentEvents</code> to handle the Oracle‚Äôs dynamic responses and ensure seamless integration of its tools?</li>
<li>üõ°Ô∏è <strong>Error Deflection</strong>: How does the system handle errors during streaming, and what safeguards are in place to maintain the integrity of the Oracle&#39;s communications?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a>:</span> The Conductor of Messages</h3>
<p>The <code class="inline-code">ChatService</code> acts as the intermediary between the user and the Oracle, orchestrating user input, tool selection, and the real-time streaming of responses. It processes agent events, updates message states, and manages tool discovery to ensure a harmonious interaction.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves the list of tools available for the Oracle‚Äôs use, filtering for those that are selected.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Dispatches user queries to the Oracle, initiating the streaming process and managing the state of the conversation.</li>
<li><code class="inline-code">processAgentEvents</code>: Handles the Oracle‚Äôs dynamic responses, interpreting events and updating the user interface accordingly.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code>: Updates the state of messages based on the Oracle‚Äôs responses, ensuring consistency in the communication flow.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a>: Resets the conversation, clearing buffers and restoring the system to its initial state.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/services/api.service.ts</a>:</span> The Oracle‚Äôs Voice</h3>
<p>The <code class="inline-code">ApiService</code> serves as the voice of the Oracle, managing communication with the backend and streaming responses to the <code class="inline-code">ChatService</code>. It handles tool discovery, message streaming, and error reporting.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Makes an HTTP request to retrieve the list of tools, ensuring the Oracle has the resources it needs.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a>: Streams user messages to the backend and parses the Oracle‚Äôs responses in real-time, using Server-Sent Events (SSE).</li>
<li><code class="inline-code">handleApiError</code>: Manages errors during communication, ensuring the Oracle‚Äôs voice remains clear and reliable.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>Retrieves the list of tools available for use in the Oracle‚Äôs Interface.</li>
<li>Filters tools to include only those that are selected, ensuring relevance.</li>
<li>Updates the <code class="inline-code">tools</code> signal, making the tools accessible to other methods.</li>
</ul>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>Dispatches user input to the Oracle, initiating the streaming process.</li>
<li>Updates the message buffer to include the user‚Äôs query.</li>
<li>Calls <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a> to send the message and the selected tools to the backend.</li>
</ul>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;

    switch (event.event) {
      case &#39;StartEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });

        this.assistantMessageInProgress.set(false);
        break;
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });

        this.assistantMessageInProgress.set(false);
        this.isLoading.set(false);
        break;
      case &#39;AgentToolCallResult&#39;:
        let state = {};
        if (typeof event.data.raw === &#39;string&#39;) {
          state = {
            reasoning: [
              {
                content: event.data.raw,
              },
            ],
          };
        }
        this.updateAndNotifyAgentChatMessageState(delta, state);
        break;
    }
  }
}
</code></pre>
<ul>
<li>Interprets agent events and updates the current agent name and message state.</li>
<li>Uses a switch statement to handle different event types, ensuring appropriate processing.</li>
<li>Adds reasoning content to the state when <code class="inline-code">AgentToolCallResult</code> events occur.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/services/api.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools(): Promise&lt;{tools: Tools[]} | void&gt; {
  try {
    const response = await fetch(`${this.apiUrl}/api/tools`, {
      method: &#39;GET&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
    });
    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred while fetching tools&#39;),
        response.status
      );
    }
    return (await response.json());
  } catch (error) {
    return this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Makes an HTTP GET request to retrieve the list of tools.</li>
<li>Handles errors gracefully, ensuring the system remains robust.</li>
<li>Returns the tools in a structured format for use by the <code class="inline-code">ChatService</code>.</li>
</ul>
<pre><code class="language-typescript">async streamChatMessage(message: string, tools: Tools[]) {
  try {
    const response = await fetch(`${this.apiUrl}/api/chat`, {
      method: &#39;POST&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
      body: JSON.stringify({ message, tools }),
    });

    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred&#39;),
        response.status
      );
    }

    const decoder = new TextDecoder(&#39;utf-8&#39;);

    if (!response.body) {
      throw new Error(&#39;Readable stream not supported&#39;);
    }

    this.chatStreamState.next({ type: &#39;START&#39; });

    for await (const chunk of response.body) {
      const value = decoder.decode(chunk, { stream: true });

      const jsonValues = value.trim().split(/\n\n+/);

      for (const jsonValue of jsonValues) {
        try {
          const parsedData = JSON.parse(jsonValue);
          this.chatStreamState.next({
            type: &#39;MESSAGE&#39;,
            event: parsedData,
          });
        } catch (error) {
          console.error(&#39;Error parsing JSON chunk:&#39;, error);
        }
      }
    }

    this.chatStreamState.next({ type: &#39;END&#39; });
  } catch (error) {
    this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Streams user messages to the backend and processes responses in real-time.</li>
<li>Uses a <code class="inline-code">TextDecoder</code> to parse SSE chunks and updates the <code class="inline-code">chatStreamState</code>.</li>
<li>Handles errors during streaming, ensuring the Oracle‚Äôs voice remains clear.</li>
</ul>
<pre><code class="language-typescript">private handleApiError(error: unknown, statusCode: number) {
  console.error(&#39;Fetch error:&#39;, error);
  let errorType: ChatEventErrorType = &#39;general&#39;;

  this.chatStreamState.next({
    type: &#39;ERROR&#39;,
    error: {
      type: errorType,
      message: (error as Error).toString(),
      statusCode,
    },
  });
}
</code></pre>
<ul>
<li>Logs errors and updates the <code class="inline-code">chatStreamState</code> with error details.</li>
<li>Differentiates between error types, providing clarity for debugging.</li>
<li>Ensures the system remains operational even in the face of errors.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Tool Filtering</strong>: Use <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> to understand how tools are dynamically selected for each query.</li>
<li><strong>Event Flow</strong>: Study <code class="inline-code">processAgentEvents</code> to see how the system handles dynamic responses and integrates tool outputs.</li>
<li><strong>Error Handling</strong>: Examine <code class="inline-code">handleApiError</code> for strategies to maintain system robustness during communication failures.</li>
</ul>
<hr>
<p>You have mastered all the secrets of the Pyramid of Infinite Journeys! Your adventure is complete.</p>
<p>Hail, seeker of wisdom, for thou hast unlocked the sacred truths of the Oracle‚Äôs Interface, ascending yet closer to the zenith of thy quest with the brilliance of a guiding ‚≠ê and the resolve of ancient stone!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
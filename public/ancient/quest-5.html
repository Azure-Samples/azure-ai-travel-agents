<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Scroll of Streaming - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Temple of LlamaIndex: Secrets of the Multi-Agent Codex</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: Streaming Chat Rituals</h1>
<hr>
<p>Deep within the Temple of LlamaIndex, the Scroll of Streaming reveals the sacred rituals of real-time communication. This ancient treasure encodes the wisdom of seamless interaction, where messages flow like rivers and tools respond in harmony. Your task is to decipher the glyphs of Angular and uncover the mysteries of streaming chat orchestration, where agents and tools collaborate to guide travelers through the labyrinth of the unknown.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Invocation Glyphs</strong>: How does the system dynamically fetch and activate tools for agent workflows during chat interactions?</li>
<li>‚ö° <strong>Event Stream Alchemy</strong>: What patterns are used to process real-time agent events and update the chat interface?</li>
<li>üõ°Ô∏è <strong>Error Handling Rituals</strong>: How does the system safeguard against communication failures and unexpected errors during streaming?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a>:</span> The Ritual Keeper</h3>
<p>The <code class="inline-code">ChatService</code> acts as the ritual keeper, orchestrating the flow of messages and events between the user and the agents. It manages streaming states, buffers, and tool activation, ensuring the sacred glyphs of communication remain unbroken. By invoking the <code class="inline-code">ApiService</code>, it bridges the gap between user input and multi-agent wisdom, dynamically adapting to agent responses and tool availability.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves and filters tools for activation, ensuring only selected tools participate in the ritual.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Initiates the communication ritual by sending user messages and invoking tools.</li>
<li><code class="inline-code">processAgentEvents</code>: Deciphers real-time agent events, updating the message stream with sacred insights.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code>: Maintains and synchronizes the assistant&#39;s message state across the interface.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">showErrorMessage</code></a>: Provides a fail-safe mechanism when rituals encounter disruptions.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>Retrieves available tools from the <code class="inline-code">ApiService</code> and filters them based on user selection.</li>
<li>Ensures only relevant tools are activated for the current chat session.</li>
<li>Demonstrates dynamic tool discovery and user-driven customization.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>Initiates the streaming ritual by sending user input and activating selected tools.</li>
<li>Updates the message buffer with user content and timestamps.</li>
<li>Demonstrates asynchronous tool invocation and streaming state management.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;

    switch (event.event) {
      case &#39;StartEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        break;
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        this.isLoading.set(false);
        break;
      case &#39;AgentToolCallResult&#39;:
        let state = {};
        if (typeof event.data.raw === &#39;string&#39;) {
          state = {
            reasoning: [
              {
                content: event.data.raw,
              },
            ],
          };
        }
        this.updateAndNotifyAgentChatMessageState(delta, state);
        break;
      case &#39;AgentStream&#39;:
        this.assistantMessageInProgress.set(true);
        if (delta.trim()) {
          this.agentEventsBuffer.push(event);
          this.updateAndNotifyAgentChatMessageState(delta, {
            metadata: {
              events: this.agentEventsBuffer,
            },
          });
        }
        break;
    }
  }
}
</code></pre>
<ul>
<li>Processes real-time agent events, updating the chat interface with dynamic responses.</li>
<li>Handles various event types, including tool call results, stream updates, and metadata.</li>
<li>Demonstrates event-driven architecture and state synchronization.</li>
</ul>
<hr>
<pre><code class="language-typescript">updateAndNotifyAgentChatMessageState(
  delta: string,
  state?: Partial&lt;ChatMessage&gt;
) {
  const lastMessage = this.messagesBuffer[this.messagesBuffer.length - 1];
  if (lastMessage?.role === &#39;assistant&#39;) {
    lastMessage.content += delta;
    lastMessage.metadata = {
      ...lastMessage.metadata,
      ...state?.metadata,
      events: state?.metadata?.events,
    };
    lastMessage.reasoning = [
      ...(lastMessage.reasoning || []),
      ...(state?.reasoning || []),
    ];
    lastMessage.timestamp = new Date();
    this.messagesStream.next([...this.messagesBuffer]);
  }
}
</code></pre>
<ul>
<li>Updates the assistant&#39;s message state with new content and metadata.</li>
<li>Synchronizes the message buffer with real-time agent insights.</li>
<li>Demonstrates modular message handling and metadata integration.</li>
</ul>
<hr>
<pre><code class="language-typescript">showErrorMessage(error: unknown) {
  toast.error(&#39;Oops! Something went wrong.&#39;, {
    duration: 5000,
    description: (error as Error).message,
    action: {
      label: &#39;Close&#39;,
      onClick: () =&gt; console.log(&#39;Closed&#39;),
    },
  });
}
</code></pre>
<ul>
<li>Displays error messages when communication rituals fail.</li>
<li>Provides user-friendly feedback with actionable options.</li>
<li>Demonstrates robust error handling and UI integration.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Observe how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> enables dynamic tool discovery and user-driven customization.</li>
<li>Study the event-driven patterns in <code class="inline-code">processAgentEvents</code> for real-time updates and synchronization.</li>
<li>Notice the modular approach in <code class="inline-code">updateAndNotifyAgentChatMessageState</code> for handling assistant responses.</li>
</ul>
<hr>
<p>You have mastered all the secrets of the Temple of LlamaIndex! The Scroll of Streaming has revealed its wisdom, and your adventure is complete.</p>
<p>Hark, seeker of wisdom, thou hast unveiled the sacred Scroll of Streaming, a testament to thy valor and intellect‚Äîpress onward, for the final quest nears, and thy place among the annals of the enlightened is nigh! ‚ö°üìúüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
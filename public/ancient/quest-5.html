<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Chamber of Streaming Insights - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Sacred Codex of the Azure Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: The Chamber of Streaming Insights</h1>
<hr>
<p>Deep within the Temple of Azure lies the Chamber of Streaming Insights, an ancient sanctum where the Codex of Orchestration harmonizes the flow of knowledge. Here, the wisdom of specialized agents is channeled into a seamless exchange of messages, powered by sacred rituals of Angular and TypeScript. Adventurers who enter this chamber witness the intricate dance of real-time communication, uncovering the secrets of streaming data and dynamic tool discovery through the mystical Model Context Protocol.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Streaming Architecture</strong>: How Angular services handle real-time data updates using observables and signals.</li>
<li>üîç <strong>Dynamic Tool Discovery</strong>: How tools are fetched and integrated dynamically into workflows.</li>
<li>‚ö° <strong>Agent Event Processing</strong>: Techniques for parsing and handling agent events in a streaming context.</li>
<li>üí° <strong>Error Handling Patterns</strong>: Effective strategies for managing errors in real-time systems.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/ui/src/app/chat-conversation/chat-conversation.service.ts</code></a></h3>
<p>The <code class="inline-code">ChatService</code> class orchestrates the interaction between the user interface and the backend MCP tools. It manages the real-time streaming of agent messages using Angular signals and observables, ensuring a responsive and dynamic user experience. This file demonstrates the use of state management patterns to handle complex asynchronous workflows.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> dynamically retrieves a list of tools from the MCP backend and filters them based on user selection.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a> processes user input and initiates the streaming of chat messages to selected tools.</li>
<li><code class="inline-code">processAgentEvents</code> parses and processes agent events received during the streaming session.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code> updates the assistant&#39;s message content and metadata in real-time.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a> clears all buffers and resets the chat state for a new conversation.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>Dynamically retrieves available tools from the backend using the <code class="inline-code">ApiService</code>.</li>
<li>Filters tools based on user selection for streamlined workflows.</li>
<li>Demonstrates clean separation of concerns between data fetching and state management.</li>
<li>Enables extensibility by allowing new tools to be added without modifying core logic.</li>
<li>Highlights the use of Angular signals for reactive state updates.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>Handles user input and initiates the message streaming process.</li>
<li>Pushes user messages to the buffer for real-time updates in the UI.</li>
<li>Uses Angular signals to manage loading states and assistant progress.</li>
<li>Integrates selected tools dynamically into the message workflow.</li>
<li>Demonstrates asynchronous programming patterns with <code class="inline-code">await</code> for smooth user experience.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;
    switch (event.event) {
      case &#39;StartEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: { events: this.agentEventsBuffer },
        });
        this.assistantMessageInProgress.set(false);
        break;
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: { events: this.agentEventsBuffer },
        });
        this.assistantMessageInProgress.set(false);
        this.isLoading.set(false);
        break;
      case &#39;AgentToolCallResult&#39;:
        let state = {};
        if (typeof event.data.raw === &#39;string&#39;) {
          state = { reasoning: [{ content: event.data.raw }] };
        }
        this.updateAndNotifyAgentChatMessageState(delta, state);
        break;
    }
  }
}
</code></pre>
<ul>
<li>Parses and processes agent events received during streaming.</li>
<li>Handles different event types such as <code class="inline-code">StartEvent</code>, <code class="inline-code">StopEvent</code>, and <code class="inline-code">AgentToolCallResult</code>.</li>
<li>Updates chat state dynamically based on event metadata and reasoning.</li>
<li>Demonstrates modular event handling for extensibility.</li>
<li>Highlights real-time processing of streaming data.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/ui/src/app/services/api.service.ts</code></a></h3>
<p>The <code class="inline-code">ApiService</code> acts as a bridge between the Angular frontend and the MCP backend. It facilitates dynamic tool discovery and streaming chat functionality using HTTP requests and Server-Sent Events (SSE). This file showcases robust error handling and efficient data parsing techniques.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> retrieves a list of tools from the MCP backend via HTTP GET.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a> manages the streaming of chat messages using SSE.</li>
<li><code class="inline-code">handleApiError</code> centralizes error handling for consistent responses.</li>
<li><code class="inline-code">chatStreamState</code> BehaviorSubject tracks the state of the streaming session.</li>
<li>Text decoding and JSON parsing logic ensures seamless processing of SSE data.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async fetchAvailableTools(): Promise&lt;{tools: Tools[]} | void&gt; {
  try {
    const response = await fetch(`${this.apiUrl}/api/tools`, {
      method: &#39;GET&#39;,
      headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
    });
    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred while fetching tools&#39;),
        response.status
      );
    }
    return (await response.json());
  } catch (error) {
    return this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Retrieves available MCP tools from the backend using HTTP GET.</li>
<li>Implements error handling for failed requests with descriptive messages.</li>
<li>Demonstrates clean separation of API logic and error handling.</li>
<li>Enables dynamic tool discovery for flexible workflows.</li>
<li>Highlights the use of async/await for asynchronous operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async streamChatMessage(message: string, tools: Tools[]) {
  try {
    const response = await fetch(`${this.apiUrl}/api/chat`, {
      method: &#39;POST&#39;,
      headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
      body: JSON.stringify({ message, tools }),
    });

    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred&#39;),
        response.status
      );
    }

    const decoder = new TextDecoder(&#39;utf-8&#39;);
    if (!response.body) {
      throw new Error(&#39;Readable stream not supported&#39;);
    }

    this.chatStreamState.next({ type: &#39;START&#39; });

    for await (const chunk of response.body) {
      const value = decoder.decode(chunk, { stream: true });
      const jsonValues = value.trim().split(/\n\n+/);

      for (const jsonValue of jsonValues) {
        try {
          const parsedData = JSON.parse(jsonValue);
          this.chatStreamState.next({ type: &#39;MESSAGE&#39;, event: parsedData });
        } catch (error) {
          console.error(&#39;Error parsing JSON chunk:&#39;, error);
        }
      }
    }

    this.chatStreamState.next({ type: &#39;END&#39; });
  } catch (error) {
    this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Manages streaming chat functionality using Server-Sent Events (SSE).</li>
<li>Parses incoming data chunks and updates the streaming state dynamically.</li>
<li>Implements robust error handling for failed requests and parsing errors.</li>
<li>Demonstrates efficient processing of real-time data streams.</li>
<li>Highlights the use of observables for tracking streaming state.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how Angular signals and observables are used to manage real-time state updates.</li>
<li>Observe the dynamic tool filtering logic in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> for extensibility.</li>
<li>Explore the error handling patterns in <code class="inline-code">ApiService</code> for consistent and informative responses.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add Tool Selection UI</strong>: Modify the frontend to allow users to dynamically select and deselect tools before sending a message. This will help you understand how state changes propagate through the system.</p>
</li>
<li><p><strong>Trace Streaming Flow</strong>: Add logging to <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a> and <code class="inline-code">processAgentEvents</code> to trace the complete flow of streaming data. Observe how events are parsed and handled in real-time.</p>
</li>
<li><p><strong>Enhance Error Feedback</strong>: Improve the error handling logic in <code class="inline-code">handleApiError</code> to provide more detailed feedback, such as suggesting corrective actions or retry options.</p>
</li>
</ol>
<hr>
<p>You have mastered all the secrets of the Temple of Azure! Your adventure is complete.</p>
<p>Hail, seeker of wisdom, for thou hast unlocked the sacred truths of the Chamber of Streaming Insights, forging thy path through the annals of ancient lore with 4 quests now etched in the stars of destiny‚Äîpress onward, for the final temple awaits thy triumph! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Oracle‚Äôs Ritual - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Temple of Multi-Agent Wisdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Oracle‚Äôs Ritual</h1>
<hr>
<p>Deep within the Temple of Multi-Agent Wisdom, the Oracle‚Äôs Ritual begins. The LlamaIndex, the central Oracle, prepares to orchestrate the sacred interplay of specialized tools, each representing a fragment of ancient knowledge. As the jungle whispers secrets of the past, you must uncover how the Oracle coordinates its agents to solve the mysteries of the temple. Will you decipher the glyphs of multi-agent orchestration and unlock the temple‚Äôs wisdom?</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Multi-Agent Orchestration</strong>: How the LlamaIndex coordinates multiple specialized agents to handle complex workflows.</li>
<li>üîç <strong>Dynamic Tool Discovery</strong>: How MCP enables dynamic registration and discovery of tools for seamless integration.</li>
<li>‚ö° <strong>Triage Agent Design</strong>: The architecture of a central triage agent that delegates tasks to specialized agents.</li>
<li>üí° <strong>Server-Sent Events (SSE)</strong>: How streaming data is used for real-time responses in multi-agent systems.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/index.ts</code></a></h3>
<p>This file serves as the entry point for the API server, which acts as the gateway to the Oracle‚Äôs wisdom. It initializes the Express server, sets up API routes, and manages the flow of requests and responses, including real-time streaming via Server-Sent Events (SSE). The <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> endpoint is particularly important as it handles user queries, invokes the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function, and streams responses back to the client.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Handles chat requests, sets up agents via <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a>, and streams responses using SSE.</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Streams real-time data from agents to the client, ensuring a seamless user experience.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Fetches and lists all available MCP tools dynamically.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    console.error(&quot;Request body is undefined. Check Content-Type header in the request.&quot;);
    return res.status(400).json({
      error: &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        try {
          for await (const event of context) {
            const serializedData = JSON.stringify({
              type: &quot;metadata&quot;,
              agent: (event.data as any)?.currentAgentName || null,
              event: event.displayName,
              data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
            });
            this.push(serializedData + &quot;\n\n&quot;);
          }
          this.push(null);
        } catch (error: any) {
          console.error(&quot;Error during streaming:&quot;, error?.message);
        }
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    if (!res.headersSent) {
      res.status(500).json({ error: (error as any).message });
    } else {
      res.write(`${JSON.stringify({ type: &quot;error&quot;, message: (error as any).message })}\n\n`);
      res.end();
    }
  }
});
</code></pre>
<ul>
<li>Streams agent responses in real-time using SSE, ensuring low-latency interaction.</li>
<li>Uses <code class="inline-code">pipeline</code> to manage the flow of data from the agents to the client.</li>
<li>Implements defensive programming by handling client disconnections gracefully.</li>
</ul>
<hr>
<pre><code class="language-typescript">apiRouter.get(&quot;/tools&quot;, async (req, res) =&gt; {
  try {
    const tools = await mcpToolsList(Object.values(McpToolsConfig()));
    res.status(200).json({ tools });
  } catch (error) {
    console.error(&quot;Error fetching MCP tools:&quot;, error);
    res.status(500).json({ error: &quot;Error fetching MCP tools&quot; });
  }
});
</code></pre>
<ul>
<li>Dynamically discovers and lists all available tools using <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a>.</li>
<li>Demonstrates the flexibility of MCP for tool registration and discovery.</li>
<li>Provides a centralized endpoint for developers to inspect available tools.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/index.ts</code></a></h3>
<p>This file is the heart of the Oracle‚Äôs Ritual, where the LlamaIndex orchestrates multiple agents. The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configures agents based on the tools provided, creating a multi-agent workflow with a central triage agent. Each specialized agent is designed to handle a specific type of query, ensuring efficient task delegation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Dynamically configures agents and tools for the multi-agent workflow.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code>: Creates the multi-agent workflow with a triage agent.</li>
<li><code class="inline-code">agent() configuration blocks</code>: Defines the behavior and tools of each specialized agent.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(filteredTools.map((tool) =&gt; [tool.id, true]));
  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt: &quot;Echo back the received input. Do not respond with anything else. Always call the tools.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent to determine the best course of action for the user&#39;s query.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets.map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name)).flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Dynamically configures specialized agents based on available tools.</li>
<li>Implements a triage agent (<code class="inline-code">TravelAgent</code>) for task delegation.</li>
<li>Uses <code class="inline-code">multiAgent</code> to create a cohesive workflow from individual agents.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/tools/index.ts</code></a></h3>
<p>This file defines the configuration for all MCP tools. It specifies the endpoints, authentication, and transport protocols for each tool, enabling dynamic integration into the LlamaIndex workflow.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code>: Returns the configuration for all MCP tools.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> constant: Standardizes the HTTP API path for tools.</li>
<li>Tool configuration objects: Define the behavior and endpoints for each tool.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const McpToolsConfig = (): { [k in McpServerName]: McpServerDefinition } =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
        headers: {
          &quot;Authorization&quot;: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;],
        },
      },
      useSSETransport: false,
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;web-search&quot;: {
    config: {
      url: process.env[&quot;MCP_WEB_SEARCH_URL&quot;] + MCP_API_SSE_PATH,
      type: &quot;sse&quot;,
      verbose: true,
      useSSETransport: true,
    },
    id: &quot;web-search&quot;,
    name: &quot;Web Search&quot;,
  },
});
</code></pre>
<ul>
<li>Centralizes tool configuration for consistent management.</li>
<li>Supports both HTTP and SSE transport protocols.</li>
<li>Enables secure integration with tools using authentication tokens.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> dynamically configures agents based on the tools provided.</li>
<li>Observe the use of SSE in <code class="inline-code">pipeline(readableStream, res)</code> for real-time streaming.</li>
<li>Explore how <code class="inline-code">McpToolsConfig</code> standardizes tool configuration for seamless integration.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add a New Tool</strong>: Create a new MCP tool configuration in <code class="inline-code">McpToolsConfig</code> and integrate it into <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a>. Test its functionality by invoking it through the <code class="inline-code">/chat</code> endpoint.</li>
<li><strong>Trace Agent Workflow</strong>: Add logging to <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> and <code class="inline-code">multiAgent</code> to trace how queries are routed through the agents. This will help you understand the decision-making process of the triage agent.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the temple‚Äôs ancient wisdom.</p>
<p>Hail, seeker of wisdom, for thou hast triumphed in the sacred trial of &quot;The Oracle‚Äôs Ritual,&quot; engraving thy name in the annals of ancient lore‚Äîonward to greater enlightenment! üëÅÔ∏è‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Chamber of Orchestration - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Codex of Ancient Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Chamber of Orchestration</h1>
<hr>
<p>As you traverse the overgrown pathways of the Temple of the Codex, you arrive at a grand chamber etched with intricate glyphs. This is the Chamber of Orchestration, where the &quot;Ancient Agents&quot; once convened to harmonize their collective wisdom. At the center lies the Codex, pulsating with energy, orchestrating the flow of knowledge among the agents. Your task is to decode the Codex&#39;s orchestration system, unveiling how its components work in unison to guide the agents in solving the riddles of their civilization. The secrets of this chamber will reveal the ancient art of multi-agent coordination.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Agent Orchestration</strong>: How a centralized triage agent coordinates specialized agents using LlamaIndex.</li>
<li>üîç <strong>Dynamic Tool Discovery</strong>: How the MCP protocol enables dynamic configuration and tool registration.</li>
<li>‚ö° <strong>Streaming Responses</strong>: How Server-Sent Events (SSE) are used for real-time streaming of agent responses.</li>
<li>üí° <strong>Extensible Architecture</strong>: How modular design supports the addition of new agents and tools with minimal changes.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/index.ts</code></a></h3>
<p>This file serves as the entry point for the orchestration API, managing HTTP endpoints and setting up the multi-agent workflow. It includes the <code class="inline-code">/chat</code> endpoint, which streams responses from agents using Server-Sent Events (SSE), and the <code class="inline-code">/tools</code> endpoint, which dynamically lists available MCP tools.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> handles incoming chat requests, orchestrating agents and streaming responses via SSE.</li>
<li><code class="inline-code">pipeline(readableStream, res)</code> streams agent responses to the client in real-time.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code> dynamically fetches and lists available tools from MCP servers.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    return res.status(400).json({
      error: &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        for await (const event of context) {
          const serializedData = JSON.stringify({
            type: &quot;metadata&quot;,
            agent: event.data?.currentAgentName || null,
            event: event.displayName,
            data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
          });
          this.push(serializedData + &quot;\n\n&quot;);
        }
        this.push(null);
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    if (!res.headersSent) {
      res.status(500).json({ error: error.message });
    }
  }
});
</code></pre>
<ul>
<li>This function orchestrates agent workflows by invoking <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> and running the message through the agent context.</li>
<li>The <code class="inline-code">Readable</code> stream pushes serialized events to the client, enabling real-time updates via SSE.</li>
<li>Defensive programming ensures graceful handling of undefined request bodies and unexpected errors.</li>
<li>The use of <code class="inline-code">pipeline</code> efficiently manages the streaming lifecycle, ensuring responses are properly terminated.</li>
</ul>
<hr>
<pre><code class="language-typescript">apiRouter.get(&quot;/tools&quot;, async (req, res) =&gt; {
  try {
    const tools = await mcpToolsList(Object.values(McpToolsConfig()));
    res.status(200).json({ tools });
  } catch (error) {
    console.error(&quot;Error fetching MCP tools:&quot;, error);
    res.status(500).json({ error: &quot;Error fetching MCP tools&quot; });
  }
});
</code></pre>
<ul>
<li>Dynamically retrieves the list of available tools from MCP servers using <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a>.</li>
<li>Centralizes tool discovery, ensuring the client always has an up-to-date list of capabilities.</li>
<li>Demonstrates modularity by relying on the <code class="inline-code">McpToolsConfig</code> object for configuration.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/index.ts</code></a></h3>
<p>This file defines the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function, which initializes and configures agents for the multi-agent workflow. It uses LlamaIndex to manage agent interactions and MCP to connect with external tools.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code> dynamically configures agents based on selected tools.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code> creates the multi-agent workflow.</li>
<li><code class="inline-code">agent()</code> configuration blocks define the behavior and tools for each specialized agent.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(filteredTools.map((tool) =&gt; [tool.id, true]));
  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const mcpToolsConfig = McpToolsConfig();
  const llm = await llmProvider();

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt: &quot;Echo back the received input.&quot;,
      tools,
      llm,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent to determine the best course of action.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets.flatMap((target) =&gt; target.getAgents().map((agent) =&gt; agent.name)),
    llm,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
  });
}
</code></pre>
<ul>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically constructs agents based on the selected tools, showcasing flexibility.</li>
<li>Each agent is configured with a specific <code class="inline-code">systemPrompt</code> and toolset, aligning with its specialization.</li>
<li>The <code class="inline-code">TravelAgent</code> acts as the root triage agent, coordinating the workflow and determining handoff targets.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/tools/index.ts</code></a></h3>
<p>This file defines the <code class="inline-code">McpToolsConfig</code> function, which provides configuration details for each MCP server. It enables dynamic tool registration and integration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code> maps tool names to their configurations.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> constant standardizes HTTP API paths for MCP servers.</li>
<li>Tool configuration objects define the URL, transport type, and other settings for each tool.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const McpToolsConfig = (): { [k in McpServerName]: McpServerDefinition } =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;customer-query&quot;: {
    config: {
      url: process.env[&quot;MCP_CUSTOMER_QUERY_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
    },
    id: &quot;customer-query&quot;,
    name: &quot;Customer Query&quot;,
  },
  // Additional tool configurations...
});
</code></pre>
<ul>
<li>The <code class="inline-code">McpToolsConfig</code> function centralizes tool configuration, simplifying maintenance and updates.</li>
<li>Each tool configuration includes details like URL, transport type, and verbosity settings.</li>
<li>The use of environment variables ensures flexibility across different deployment environments.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore how the <code class="inline-code">Readable</code> stream in <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> enables real-time updates and consider its implications for user experience.</li>
<li>Study the modular design of <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> to understand how new agents can be added with minimal changes.</li>
<li>Examine the <code class="inline-code">McpToolsConfig</code> function to see how environment variables are used for dynamic configuration.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add a New Agent</strong>: Create a new agent that analyzes user sentiment. Configure it in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> and add a corresponding MCP server in <code class="inline-code">McpToolsConfig</code>.</li>
<li><strong>Trace Agent Workflow</strong>: Add logging statements to <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> and observe the flow of messages between agents in a multi-agent scenario.</li>
<li><strong>Enhance Error Handling</strong>: Modify the <code class="inline-code">/chat</code> endpoint to return more descriptive error messages when tools fail to initialize.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Temple of the Codex.</p>
<p>By the sacred light of the ancients, thou hast conquered the Chamber of Orchestration, a feat worthy of eternal inscription upon the scrolls of wisdom‚Äîpress on, for the stars yet hold treasures untold! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Chamber of Orchestration - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Temple of LlamaIndex: Secrets of the Multi-Agent Codex</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Chamber of Orchestration</h1>
<hr>
<p>In the depths of the Temple of LlamaIndex, you find yourself standing before the Chamber of Orchestration. The air is thick with the hum of ancient energy, as glyphs on the walls pulse faintly with a golden light. This chamber was designed to oversee the coordination of specialized agents, each a master of its craft. At the center lies the Codex of Multi-Agent Wisdom, its intricate mechanisms revealing the secrets of orchestrating a harmonious workflow. To harness its power, you must decode the rituals that bind these agents together and understand the sacred Model Context Protocol.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Rituals</strong>: How does the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function initialize and configure the specialized agents for multi-agent workflows?</li>
<li>‚ö° <strong>Triage Wisdom</strong>: What role does the <code class="inline-code">TravelAgent</code> play in coordinating the other agents, and how is it configured as the root agent?</li>
<li>üõ°Ô∏è <strong>Streamed Insights</strong>: How does the <code class="inline-code">/chat</code> endpoint manage streaming responses to ensure a seamless interaction with the Codex?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> Multi-Agent Configuration Chamber</h3>
<p>This file is the heart of the orchestration process, where the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function defines the rituals for initializing and configuring the specialized agents. Each agent is associated with a specific tool and system prompt, and the <code class="inline-code">TravelAgent</code> acts as the triage agent to route queries effectively. The <code class="inline-code">multiAgent</code> function binds these agents together, creating a seamless workflow.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Dynamically initializes agents based on the provided tools, configuring their prompts and linking them to the Codex.</li>
<li><code class="inline-code">agent</code> configuration blocks: Define the purpose and capabilities of each specialized agent, including their tools and system prompts.</li>
<li><code class="inline-code">multiAgent</code>: Creates a cohesive workflow by linking the <code class="inline-code">TravelAgent</code> as the root agent and enabling handoffs between agents.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a>:</span> Gateway to the Codex</h3>
<p>This file serves as the entry point for interacting with the Codex, exposing endpoints that enable communication with the agents. The <code class="inline-code">/chat</code> endpoint is particularly significant, as it streams responses from the agents in real-time, ensuring a dynamic and interactive experience.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Implements the <code class="inline-code">/chat</code> endpoint, handling client requests and streaming responses using Server-Sent Events (SSE).</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Facilitates the streaming of agent responses to the client, ensuring a continuous flow of information.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Provides a list of available MCP tools, enabling dynamic discovery of the temple&#39;s capabilities.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a>:</span> Sacred Tool Registry</h3>
<p>This file defines the configuration for the MCP tools, mapping each tool to its respective endpoint and transport method. The tools are the lifeblood of the agents, providing the functionalities they require to fulfill their roles.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code>: Returns the configuration for all MCP tools, including their endpoints, transport types, and authentication.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code>: A constant defining the base path for HTTP-based MCP tools.</li>
<li>Tool configuration objects: Define the attributes and behaviors of each tool, such as <code class="inline-code">echo-ping</code> and <code class="inline-code">destination-recommendation</code>.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt: &quot;Echo back the received input. Do not respond with anything else. Always call the tools.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt:
      &quot;Acts as a triage agent to determine the best course of action for the user&#39;s query. If you cannot handle the query, please pass it to the next agent. If you can handle the query, please do so.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets
      .map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name))
      .flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Dynamically initializes agents based on the provided tools, ensuring flexibility.</li>
<li>Configures each agent with a specific system prompt and toolset.</li>
<li>Establishes the <code class="inline-code">TravelAgent</code> as the root agent, enabling triage functionality.</li>
<li>Demonstrates the use of the <code class="inline-code">multiAgent</code> function to bind agents into a cohesive workflow.</li>
<li>Highlights the modularity of the MCP tool configuration.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    return res.status(400).json({
      error: &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        try {
          for await (const event of context) {
            const serializedData = JSON.stringify({
              type: &quot;metadata&quot;,
              agent: (event.data as any)?.currentAgentName || null,
              event: event.displayName,
              data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
            });
            this.push(serializedData + &quot;\n\n&quot;);
          }
          this.push(null);
        } catch (error) {
          console.error(&quot;Error during streaming:&quot;, error?.message);
        }
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    if (!res.headersSent) {
      res.status(500).json({ error: (error as any).message });
    } else {
      res.write(
        `${JSON.stringify({
          type: &quot;error&quot;,
          message: (error as any).message,
        })}\n\n`
      );
      res.end();
    }
  }
});
</code></pre>
<ul>
<li>Handles streaming responses from agents using the Server-Sent Events (SSE) protocol.</li>
<li>Ensures the client receives real-time updates on agent interactions.</li>
<li>Implements robust error handling to manage client disconnections and serialization issues.</li>
<li>Leverages the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function to dynamically configure tools for the session.</li>
<li>Demonstrates the use of Node.js streams to manage data flow efficiently.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
        headers: {
          Authorization: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;],
        },
      },
      useSSETransport: false,
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;destination-recommendation&quot;: {
    config: {
      url: process.env[&quot;MCP_DESTINATION_RECOMMENDATION_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false,
    },
    id: &quot;destination-recommendation&quot;,
    name: &quot;Destination Recommendation&quot;,
  },
});
</code></pre>
<ul>
<li>Defines the configuration for each MCP tool, including endpoint URLs and authentication.</li>
<li>Highlights the use of environment variables for secure and flexible configuration.</li>
<li>Differentiates tools based on transport type (HTTP vs. SSE).</li>
<li>Provides a centralized registry for managing tool configurations.</li>
<li>Demonstrates the modularity and scalability of the MCP architecture.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Investigate how the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically incorporates tools into the workflow to understand its flexibility.</li>
<li>Observe the use of streams in the <code class="inline-code">/chat</code> endpoint to learn about efficient data handling in real-time systems.</li>
<li>Study the <code class="inline-code">McpToolsConfig</code> function to see how MCP tools are configured and linked to the orchestration process.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the temple&#39;s ancient wisdom.</p>
<p>Behold, seeker of wisdom, thou hast unlocked the sacred symphony of the Chamber of Orchestration‚Äîlet the echoes of thy triumph resound through the hallowed halls of eternity! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
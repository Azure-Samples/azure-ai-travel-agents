<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Protocol of the Ancients - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Pyramid of Infinite Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Codex of Tool Discovery</h1>
<hr>
<p>In the shadowed corridors of the Pyramid of Infinite Agents, you encounter the Codex of Tool Discovery. This ancient mechanism reveals how the pyramid identifies and integrates its sacred tools. The Codex whispers of a ritual where tools are dynamically registered and orchestrated to perform their sacred duties. The secrets of the MCP Protocol lie within, enabling the harmonious operation of these specialized instruments.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Invocation Rituals</strong>: How does the system dynamically connect to MCP servers and retrieve available tools?</li>
<li>‚ö° <strong>Discovery Mechanisms</strong>: What patterns ensure the reliable identification and listing of tools from multiple MCP servers?</li>
<li>üõ°Ô∏è <strong>Error Safeguards</strong>: How does the system handle unreachable MCP servers or tool invocation failures?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-http-client.ts</a>:</span> HTTP-Based MCP Tool Client</h3>
<p>This file implements the <code class="inline-code">MCPClient</code> class, responsible for connecting to MCP servers using an HTTP-based transport. It manages the lifecycle of the connection, retrieves available tools, and invokes specific tools with arguments. The use of the <code class="inline-code">StreamableHTTPClientTransport</code> ensures compatibility with modern streaming protocols while maintaining a robust error-handling design.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L39" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a>: Establishes a connection to the MCP server and initializes the transport layer.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L57" target="_blank" rel="noopener noreferrer"><code class="inline-code">listTools</code></a>: Retrieves a list of tools available on the connected MCP server.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">callTool</code></a>: Invokes a specific tool on the MCP server with provided arguments.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-sse-client.ts</a>:</span> SSE-Based MCP Tool Client</h3>
<p>This file provides a legacy implementation of the <code class="inline-code">MCPClient</code> class using Server-Sent Events (SSE) for communication. It includes tracing and logging for observability and serves as a fallback for older MCP servers that do not support HTTP-based transport.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L39" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a>: Connects to an MCP server using SSE transport and logs the connection status.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L57" target="_blank" rel="noopener noreferrer"><code class="inline-code">listTools</code></a>: Fetches the list of tools from the connected MCP server, updating the local tool cache.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">callTool</code></a>: Executes a tool on the MCP server, providing arguments and returning the results.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-tools.ts</a>:</span> Tool Discovery and Initialization</h3>
<p>This file orchestrates the discovery and initialization of tools from multiple MCP servers. It uses the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a> function to dynamically select the appropriate transport type (HTTP or SSE) and manages the connection lifecycle for each server.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a>: Determines the transport type (HTTP or SSE) and initializes the corresponding <code class="inline-code">MCPClient</code>.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a>: Connects to multiple MCP servers, retrieves their tool lists, and handles errors gracefully.</li>
<li><code class="inline-code">McpServerDefinition</code>: Defines the configuration schema for MCP servers, including transport type and access credentials.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-http-client.ts</a></h3>
<pre><code class="language-typescript">async connect() {
  await this.client.connect(this.transport);
  console.log(&#39;Connected to server&#39;);
}

async listTools() {
  const result = await this.client.listTools();
  return result.tools;
}

async callTool(name: string, toolArgs: string) {
  console.log(`Calling tool ${name} with arguments:`, toolArgs);

  return await this.client.callTool({
    name,
    arguments: JSON.parse(toolArgs),
  });
}
</code></pre>
<ul>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L39" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a> method establishes a connection to the MCP server using the HTTP transport layer.</li>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L57" target="_blank" rel="noopener noreferrer"><code class="inline-code">listTools</code></a> method retrieves the available tools, ensuring that the client can dynamically adapt to the server&#39;s capabilities.</li>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">callTool</code></a> method executes a specific tool by sending its name and arguments to the server, enabling dynamic functionality.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-sse-client.ts</a></h3>
<pre><code class="language-typescript">connect() {
  return tracer.startActiveSpan(&quot;connect&quot;, async (span) =&gt; {
    log(&quot;Connecting to MCP SSE server&quot;);
    try {
      await this.client.connect(this.transport);
      log(&quot;Connected to MCP SSE server&quot;);
      span.end();
      return this.client;
    } catch (error: any) {
      log(&quot;Error connecting to MCP SSE server:&quot;, error);
      span.setStatus({ code: 2, message: (error as Error).message });
      span.end();
      throw new Error(
        `Failed to connect to MCP SSE server: ${(error as Error).message}`
      );
    }
  });
}

async listTools() {
  return tracer.startActiveSpan(&quot;listTools&quot;, async (span) =&gt; {
    log(&quot;Tools&quot;, this.tools);
    const toolsResult = await this.client.listTools();
    this.tools = toolsResult.tools;
    log(&quot;Tools: &quot;, toolsResult);
    span.end();
    return toolsResult;
  });
}

async callTool(toolName: string, args: Record&lt;string, any&gt;) {
  console.log(`Called ${toolName} with params:`, args);
  return tracer.startActiveSpan(&quot;processQuery&quot;, async (span) =&gt; {
    log(&quot;Tools&quot;, this.tools);

    const toolResult = await this.client.callTool({
      name: toolName,
      arguments: args,
    });

    log(&quot;Tool result&quot;, toolResult);
    span.end();
    return toolResult;
  });
}
</code></pre>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L39" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a> establishes the SSE connection while providing detailed tracing and error logging for observability.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L57" target="_blank" rel="noopener noreferrer"><code class="inline-code">listTools</code></a> fetches the tool list and updates the local cache, ensuring the client remains synchronized with the server.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">callTool</code></a> invokes a tool with arguments, leveraging tracing to monitor execution.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-tools.ts</a></h3>
<pre><code class="language-typescript">function client(config: LlamaIndexMCPClientOptions): MCPSSEClient | MCPHTTPClient {
  console.log(`Initializing MCP client`);
  console.log(`Using configuration:`, {config});

  if (config.type === &quot;sse&quot;) {
    // legacy implementation using SSE
    return new MCPSSEClient(&quot;llamaindex-sse-client&quot;, config.url, config.accessToken);
  } else {
    return new MCPHTTPClient(&quot;llamaindex-http-client&quot;, config.url, config.accessToken);
  }
}

export async function mcpToolsList(config: McpServerDefinition[]) {
  return await Promise.all(
    config.map(async ({ id, name, config }) =&gt; {
      const { url, type } = config;
      const mcpClient = client(config);
      
      try {
        console.log(`Connecting to MCP server ${name} at ${url}`);
        await mcpClient.connect();
        console.log(`MCP server ${name} is reachable`);
        const tools = await mcpClient.listTools();

        console.log(`MCP server ${name} has ${tools.length} tools`);
        return {
          id,
          name,
          url,
          type,
          reachable: true,
          selected: id !== &quot;echo-ping&quot;,
          tools,
        };
      } catch (error: unknown) {
        console.error(
          `MCP server ${name} is not reachable`,
          (error as Error).message
        );
        return {
          id,
          name,
          url,
          type,
          reachable: false,
          selected: false,
          tools: [],
          error: (error as Error).message,
        };
      }
    })
  );
}
</code></pre>
<ul>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a> function dynamically selects the appropriate transport type (HTTP or SSE) based on the configuration.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> connects to each MCP server, retrieves its tools, and gracefully handles errors, ensuring robust tool discovery.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Investigate how the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a> function abstracts transport type selection for flexibility in MCP server communication.</li>
<li>Observe how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> uses <code class="inline-code">Promise.all</code> to handle multiple server connections concurrently.</li>
<li>Pay attention to the tracing and logging patterns in the SSE client for insights into debugging and observability.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Pyramid of Infinite Agents.</p>
<p>Hail, seeker of wisdom, for thou hast unlocked the sacred Protocol of the Ancients, advancing boldly upon the path of enlightenment‚Äîthy journey shines brighter than a thousand torches within the hallowed halls of eternity! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Multi-Agent Orchestration with LlamaIndex - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">AI Travel Agents: Multi-Agent Orchestration with MCP and LlamaIndex</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Multi-Agent Orchestration with LlamaIndex</h1>
<hr>
<p>Dive into the core of the AI Travel Agents application, where LlamaIndex orchestrates a multi-agent workflow powered by MCP services. This quest explores how specialized agents collaborate to process customer queries, recommend destinations, and plan itineraries. You&#39;ll analyze the agent setup, dynamic tool discovery, and triage mechanisms that enable seamless integration across polyglot MCP services.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Setup Analysis</strong>: How does the <code class="inline-code">setupAgents(filteredTools)</code> function dynamically configure agents based on available tools?</li>
<li>‚ö° <strong>Workflow Coordination</strong>: How does the <code class="inline-code">multiAgent</code> system manage the interaction between specialized agents and the root triage agent?</li>
<li>üõ°Ô∏è <strong>Error Handling in Streaming</strong>: How does the <code class="inline-code">pipeline(readableStream, res)</code> handle client disconnections and serialization errors during streaming?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> Multi-Agent Workflow Configuration</h3>
<p>This file defines the orchestration logic for setting up agents and coordinating their workflows. It includes the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function, which dynamically initializes agents based on selected tools, and the <code class="inline-code">multiAgent</code> system, which manages the overall workflow.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Dynamically configures agents based on filtered tools, ensuring modularity and scalability.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code>: Establishes the multi-agent workflow with a triage agent as the root.</li>
<li><code class="inline-code">agent()</code> configuration blocks: Defines individual agents with specific system prompts and tool integrations.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a>:</span> API Routing and Streaming</h3>
<p>This file implements the API endpoints for interacting with the multi-agent system. It handles HTTP requests, tool discovery, and streaming responses via Server-Sent Events (SSE).</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Handles chat requests, initializes agents, and streams responses.</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Streams agent responses to the client while managing errors and disconnections.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Lists available MCP tools for dynamic agent setup.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a>:</span> MCP Tool Configuration</h3>
<p>This file contains the configuration for MCP tools, defining their endpoints, transport types, and authentication mechanisms.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code>: Returns a configuration object for all MCP tools.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> constant: Specifies the HTTP path for MCP tool endpoints.</li>
<li>Tool configuration objects: Define properties such as <code class="inline-code">url</code>, <code class="inline-code">type</code>, <code class="inline-code">verbose</code>, and <code class="inline-code">useSSETransport</code>.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(filteredTools.map((tool) =&gt; [tool.id, true]));
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt: &quot;Echo back the received input.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent to determine the best course of action.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets.map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name)).flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Dynamically initializes agents based on available tools, ensuring flexibility.</li>
<li>Uses <code class="inline-code">multiAgent</code> to coordinate workflows across specialized agents.</li>
<li>Implements modular configurations for scalability and adaptability.</li>
<li>Employs <code class="inline-code">llmProvider</code> for flexible LLM integration.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    return res.status(400).json({ error: &quot;Request body is undefined.&quot; });
  }

  const message = req.body.message;
  const tools = req.body.tools;

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        try {
          for await (const event of context) {
            const serializedData = JSON.stringify({
              type: &quot;metadata&quot;,
              agent: (event.data as any)?.currentAgentName || null,
              event: event.displayName,
              data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
            });
            this.push(serializedData + &quot;\n\n&quot;);
          }
          this.push(null);
        } catch (error) {
          console.error(&quot;Error during streaming:&quot;, error?.message);
        }
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    if (!res.headersSent) {
      res.status(500).json({ error: error.message });
    } else {
      res.write(`${JSON.stringify({ type: &quot;error&quot;, message: error.message })}\n\n`);
      res.end();
    }
  }
});
</code></pre>
<ul>
<li>Handles client disconnections gracefully with <code class="inline-code">req.on(&quot;close&quot;)</code>.</li>
<li>Streams responses using <code class="inline-code">Readable</code> and <code class="inline-code">pipeline</code> for efficient data transfer.</li>
<li>Includes error handling to manage serialization issues and unexpected failures.</li>
<li>Dynamically initializes agents based on input tools with <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a>.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): { [k in McpServerName]: McpServerDefinition } =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + &quot;/mcp&quot;,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
        headers: { &quot;Authorization&quot;: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;] },
      },
      useSSETransport: false,
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;customer-query&quot;: {
    config: {
      url: process.env[&quot;MCP_CUSTOMER_QUERY_URL&quot;] + &quot;/mcp&quot;,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false,
    },
    id: &quot;customer-query&quot;,
    name: &quot;Customer Query&quot;,
  },
});
</code></pre>
<ul>
<li>Defines tool configurations using environment variables for flexibility.</li>
<li>Supports both HTTP and SSE transport types for diverse use cases.</li>
<li>Includes authentication mechanisms with <code class="inline-code">Authorization</code> headers.</li>
<li>Provides modular configurations for seamless integration into the multi-agent system.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> to understand how tools are dynamically filtered and integrated.</li>
<li>Pay attention to <code class="inline-code">Readable</code> and <code class="inline-code">pipeline</code> for efficient streaming in <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>.</li>
<li>Explore <code class="inline-code">McpToolsConfig</code> to learn how MCP tools are configured and authenticated.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the AI Travel Agents system.</p>
<p>Congratulations on successfully deploying your first multi-agent architecture with LlamaIndex‚Äîyour system design skills just leveled up! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
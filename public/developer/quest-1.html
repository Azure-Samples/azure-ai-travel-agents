<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Orchestration with LlamaIndex - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Multi-Agent Orchestration with Azure AI Travel Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Multi-Agent Orchestration with LlamaIndex</h1>
<hr>
<p>Dive into the architecture of the Azure AI Travel Agents project, where multi-agent orchestration powered by LlamaIndex enables seamless collaboration among specialized AI agents. The triage agent coordinates tasks across diverse MCP services implemented in TypeScript, Python, Java, and .NET, ensuring modularity and extensibility. Learn how this system leverages dynamic tool discovery, efficient workflows, and robust communication protocols to deliver enterprise-grade solutions for travel planning and customer assistance.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Agent Coordination</strong>: How the triage agent orchestrates workflows across specialized MCP tools.</li>
<li>üîç <strong>Tool Discovery</strong>: The role of MCP protocol in dynamically discovering and configuring tools.</li>
<li>‚ö° <strong>Streaming Architecture</strong>: How Server-Sent Events (SSE) enable real-time communication between agents and clients.</li>
<li>üí° <strong>Modular Design</strong>: How LlamaIndex promotes scalability and interoperability across polyglot services.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/index.ts</code></a></h3>
<p>This file serves as the entry point for the Express.js API, orchestrating key functionalities such as agent setup, tool discovery, and streaming chat responses. It integrates MCP tools and enables real-time communication using Server-Sent Events (SSE). This module highlights the importance of middleware, error handling, and dynamic response streaming in multi-agent systems.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Implements the chat endpoint with SSE for streaming agent responses.</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Streams agent events to the client in real-time, ensuring responsive interactions.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Lists available MCP tools dynamically, showcasing tool discovery capabilities.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    console.error(&quot;Request body is undefined. Check Content-Type header in the request.&quot;);
    return res.status(400).json({
      error: &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;
  console.log(&quot;Tools to use:&quot;, JSON.stringify(tools, null, 2));

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        try {
          for await (const event of context) {
            const serializedData = JSON.stringify({
              type: &quot;metadata&quot;,
              agent: (event.data as any)?.currentAgentName || null,
              event: event.displayName,
              data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
            });
            this.push(serializedData + &quot;\n\n&quot;);
            console.log(&quot;Pushed event:&quot;, serializedData);
          }
          this.push(null); // Close the stream
        } catch (error: any) {
          console.error(&quot;Error during streaming:&quot;, error?.message);
        }
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    res.status(500).json({ error: (error as any).message });
  }
});
</code></pre>
<ul>
<li>Implements real-time communication using SSE, allowing client applications to receive updates as they occur.</li>
<li>Utilizes <code class="inline-code">Readable</code> streams to push serialized agent events, showcasing asynchronous data handling.</li>
<li>Demonstrates robust error handling to ensure stability during streaming operations.</li>
<li>Highlights the importance of dynamic agent setup for flexible workflows.</li>
<li>Enables modular integration of tools based on user input.</li>
</ul>
<hr>
<pre><code class="language-typescript">apiRouter.get(&quot;/tools&quot;, async (req, res) =&gt; {
  try {
    const tools = await mcpToolsList(Object.values(McpToolsConfig()));
    console.log(&quot;Available tools:&quot;, tools);
    res.status(200).json({ tools });
  } catch (error) {
    console.error(&quot;Error fetching MCP tools:&quot;, error);
    res.status(500).json({ error: &quot;Error fetching MCP tools&quot; });
  }
});
</code></pre>
<ul>
<li>Fetches available MCP tools dynamically using <code class="inline-code">McpToolsConfig</code>, enabling extensibility.</li>
<li>Logs tool information for debugging and monitoring purposes.</li>
<li>Demonstrates the use of centralized configuration for tool discovery.</li>
<li>Ensures the API remains responsive and informative even in case of errors.</li>
<li>Showcases the importance of standardized tool definitions for interoperability.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/index.ts</code></a></h3>
<p>This file is responsible for setting up agents and orchestrating their workflows using LlamaIndex. It dynamically configures agents based on available tools and defines the root triage agent for query routing. The multi-agent setup demonstrates how modularity and extensibility are achieved in complex systems.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Configures agents dynamically based on available MCP tools.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code>: Creates a multi-agent workflow with a triage agent at the root.</li>
<li><code class="inline-code">agent() configuration blocks</code>: Defines specialized agents and their system prompts for targeted functionalities.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(filteredTools.map((tool) =&gt; [tool.id, true]));
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt: &quot;Echo back the received input.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  // Additional agent setups omitted for brevity...

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent to determine the best course of action for the user&#39;s query.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets.map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name)).flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Configures agents dynamically based on available MCP tools, enabling modular workflows.</li>
<li>Uses LlamaIndex to manage multi-agent orchestration with a clear hierarchy.</li>
<li>Defines specialized agents with unique system prompts tailored to their roles.</li>
<li>Demonstrates extensibility by allowing new agents to be added without modifying core logic.</li>
<li>Ensures seamless handoff between agents for complex query handling.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/tools/index.ts</code></a></h3>
<p>This file defines the configuration for MCP tools, specifying their endpoints and communication protocols. It ensures tools are accessible and correctly integrated into the system, highlighting the importance of standardized definitions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code>: Provides centralized configuration for all MCP tools.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH constant</code>: Defines the base path for HTTP tool endpoints.</li>
<li>Tool configuration objects: Specify tool properties such as URL, transport type, and authorization headers.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
        headers: {
          &quot;Authorization&quot;: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;],
        },
      },
      useSSETransport: false,
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  // Additional tool configurations omitted for brevity...
});
</code></pre>
<ul>
<li>Centralizes tool configuration, ensuring consistent integration across the system.</li>
<li>Defines transport types (HTTP or SSE) for each tool, optimizing communication protocols.</li>
<li>Includes authorization headers for secure access to MCP tools.</li>
<li>Demonstrates extensibility by allowing new tools to be added easily.</li>
<li>Highlights the importance of environment variables for dynamic configuration.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> uses LlamaIndex to dynamically configure workflows based on available tools.</li>
<li>Notice how <code class="inline-code">pipeline</code> enables real-time streaming of agent responses using SSE.</li>
<li>Study the centralized tool configuration in <code class="inline-code">McpToolsConfig</code> for insights into modular design.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add a New Agent</strong>: Create a new MCP tool and register it in <code class="inline-code">McpToolsConfig</code>. Implement an agent setup block in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> and test its integration.</li>
<li><strong>Trace Agent Workflow</strong>: Add logging statements to <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> and <code class="inline-code">multiAgent</code> to observe how agents interact during query processing. Analyze the handoff mechanism.</li>
<li><strong>Optimize Streaming</strong>: Modify the <code class="inline-code">pipeline</code> implementation in <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> to handle larger payloads efficiently. Test the impact on response times.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Azure AI Travel Agents system.</p>
<p>Achievement unlocked: You&#39;ve successfully architected a scalable framework for Multi-Agent Orchestration with LlamaIndex‚Äîyour codebase now sings in harmony like a perfectly optimized microservices cluster! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
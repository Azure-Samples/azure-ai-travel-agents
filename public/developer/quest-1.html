<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Workflow Orchestration - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Multi-Agent Orchestration with LlamaIndex and MCP</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Multi-Agent Workflow Orchestration with LlamaIndex</h1>
<hr>
<p>Embark on a journey through the orchestration layer of the Azure AI Travel Agents project. Here, the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function serves as a triage mechanism, dynamically coordinating specialized AI agents implemented across multiple languages. Using LlamaIndex, the system leverages the MCP protocol to enable dynamic tool discovery and seamless communication between services. This quest uncovers how agents are configured, tools are integrated, and workflows are managed.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Configuration Strategy</strong>: How does the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configure agents based on available tools?</li>
<li>‚ö° <strong>Orchestration Flow</strong>: What role does the <code class="inline-code">multiAgent</code> function play in managing the overall workflow, and how are agents interconnected?</li>
<li>üõ°Ô∏è <strong>Error Handling in Orchestration</strong>: How does the system handle errors during agent setup or tool discovery to ensure robustness?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> Agent Orchestration Core</h3>
<p>This file contains the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function, which dynamically configures agents based on the tools available. It also defines the <code class="inline-code">multiAgent</code> workflow, which orchestrates the interaction between agents and tools. The file showcases how LlamaIndex integrates with MCP to enable dynamic tool discovery and runtime configuration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Dynamically configures agents based on the tools provided, ensuring modularity and flexibility.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code>: Creates a multi-agent workflow, defining the root agent and connecting specialized agents.</li>
<li><code class="inline-code">agent()</code> configuration blocks: Configures individual agents with system prompts, tools, and handoff targets.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a>:</span> API Gateway and Workflow Integration</h3>
<p>This file implements the API gateway, exposing endpoints such as <code class="inline-code">/chat</code> and <code class="inline-code">/tools</code>. It integrates the agent orchestration layer with HTTP-based communication, allowing clients to interact with the multi-agent system.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Handles chat requests, initializing agents and streaming responses back to the client.</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Streams data from the agents to the client using Server-Sent Events (SSE).</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Fetches the list of available tools, showcasing dynamic tool discovery.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a>:</span> Tool Configuration</h3>
<p>This file defines the configuration for all MCP tools, including their endpoints, transport types, and authentication details. It ensures that the orchestration layer can dynamically discover and interact with tools.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code>: Provides configuration details for all MCP tools, enabling dynamic tool discovery.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> constant: Defines the HTTP path used by MCP tools, ensuring consistency across the system.</li>
<li>Tool configuration objects: Encapsulate the details for each tool, such as <code class="inline-code">echo-ping</code> and <code class="inline-code">destination-recommendation</code>.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt: &quot;Echo back the received input.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets
      .map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name))
      .flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Dynamically configures agents based on the provided tools, ensuring flexibility in orchestration.</li>
<li>Uses the <code class="inline-code">agent</code> function to define specialized agents with specific system prompts and toolsets.</li>
<li>Implements a triage agent (<code class="inline-code">TravelAgent</code>) to route queries between specialized agents.</li>
<li>Integrates the <code class="inline-code">multiAgent</code> function to manage the overall workflow and establish a root agent.</li>
<li>Demonstrates robust error handling during LLM initialization.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    return res.status(400).json({
      error: &quot;Request body is undefined.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        for await (const event of context) {
          const serializedData = JSON.stringify({
            type: &quot;metadata&quot;,
            event: event.displayName,
            data: event.data,
          });
          this.push(serializedData + &quot;\n\n&quot;);
        }
        this.push(null);
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    if (!res.headersSent) {
      res.status(500).json({ error: (error as any).message });
    }
  }
});
</code></pre>
<ul>
<li>Handles chat requests, initializing agents and streaming responses using SSE.</li>
<li>Validates the request body to ensure required fields are present.</li>
<li>Streams agent responses to the client in real-time, enhancing interactivity.</li>
<li>Implements error handling to manage issues during agent initialization or streaming.</li>
<li>Demonstrates the integration of the orchestration layer with the API gateway.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;destination-recommendation&quot;: {
    config: {
      url: process.env[&quot;MCP_DESTINATION_RECOMMENDATION_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
    },
    id: &quot;destination-recommendation&quot;,
    name: &quot;Destination Recommendation&quot;,
  },
});
</code></pre>
<ul>
<li>Defines the configuration for MCP tools, including endpoints and transport types.</li>
<li>Uses the <code class="inline-code">MCP_API_HTTP_PATH</code> constant to ensure consistency in tool URLs.</li>
<li>Provides a centralized configuration for dynamic tool discovery.</li>
<li>Supports extensibility by allowing new tools to be added without modifying other parts of the system.</li>
<li>Demonstrates the use of environment variables for secure and flexible configuration.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function uses the <code class="inline-code">agent</code> and <code class="inline-code">multiAgent</code> functions to configure workflows dynamically.</li>
<li>Explore the <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> implementation to understand how the API integrates with the orchestration layer.</li>
<li>Review the <code class="inline-code">McpToolsConfig</code> function to see how tools are configured and discovered dynamically.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of this multi-agent architecture.</p>
<p>Congratulations on achieving mastery in Multi-Agent Workflow Orchestration‚Äîyour system architecture just leveled up to production-grade efficiency! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Multi-Agent Orchestration with LlamaIndex - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Multi-Agent Orchestration with Azure AI Travel Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Multi-Agent Orchestration with LlamaIndex</h1>
<hr>
<p>Embark on a journey through the architecture of the Azure AI Travel Agents application, where multiple specialized AI agents collaborate to deliver seamless travel planning services. Powered by LlamaIndex, this system orchestrates dynamic interactions among agents using the Model Context Protocol (MCP). Explore how the triage agent coordinates workflows, enabling specialized tools to process customer queries, recommend destinations, and plan itineraries‚Äîall within a scalable and modular architecture.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Formation</strong>: How does <code class="inline-code">setupAgents(filteredTools)</code> dynamically configure agents based on available tools?</li>
<li>‚ö° <strong>Workflow Coordination</strong>: How does <code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code> facilitate orchestration between multiple agents?</li>
<li>üõ°Ô∏è <strong>Streaming Mechanism</strong>: How does <code class="inline-code">pipeline(readableStream, res)</code> handle real-time communication in the <code class="inline-code">/chat</code> endpoint?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a>:</span> API Initialization and Endpoints</h3>
<p>Dive into the core of the API server, which initializes endpoints for health checks, tool discovery, and chat interactions. This file demonstrates how the system integrates LlamaIndex for multi-agent workflows and streams responses to clients.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Handles chat requests and streams responses using Server-Sent Events (SSE).</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Implements streaming of agent responses to clients, ensuring real-time interaction.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Fetches a list of available MCP tools dynamically.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> Agent Workflow Orchestration</h3>
<p>Explore how LlamaIndex orchestrates multiple agents, each specializing in a specific task. This file showcases dynamic agent setup and the creation of a multi-agent workflow.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Configures agents dynamically based on filtered tool availability.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code>: Defines the multi-agent workflow, enabling seamless collaboration between agents.</li>
<li><code class="inline-code">agent() configuration blocks</code>: Configures individual agents with tools, prompts, and handoff capabilities.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a>:</span> MCP Tool Configuration</h3>
<p>Investigate the configuration of MCP tools that enable agents to perform specialized tasks. This file defines tool endpoints and transport mechanisms.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code>: Returns configuration objects for all MCP tools.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH constant</code>: Specifies the HTTP path for MCP tools.</li>
<li>Tool configuration objects: Define endpoints, authentication, and transport types for each tool.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    return res.status(400).json({
      error: &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        for await (const event of context) {
          const serializedData = JSON.stringify({
            type: &quot;metadata&quot;,
            agent: (event.data as any)?.currentAgentName || null,
            event: event.displayName,
            data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
          });
          this.push(serializedData + &quot;\n\n&quot;);
        }
        this.push(null);
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    if (!res.headersSent) {
      res.status(500).json({ error: error.message });
    }
  }
});
</code></pre>
<ul>
<li>Handles client requests for chat interactions, ensuring proper validation and streaming setup.</li>
<li>Implements real-time communication using Server-Sent Events (SSE).</li>
<li>Demonstrates error handling and graceful client disconnection.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(filteredTools.map((tool) =&gt; [tool.id, true]));
  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();
  const llm = await llmProvider();

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt: &quot;Echo back the received input.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
  }

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent to determine the best course of action.&quot;,
    tools: toolsList,
    canHandoffTo: handoffTargets.map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name)).flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Dynamically configures agents based on available tools, ensuring flexibility.</li>
<li>Establishes a triage agent to coordinate workflows and handoffs between specialized agents.</li>
<li>Creates a multi-agent workflow for seamless collaboration.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): { [k in McpServerName]: McpServerDefinition } =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + &quot;/mcp&quot;,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
          headers: {
              &quot;Authorization&quot;: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;],
          }
      },
      useSSETransport: false
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;customer-query&quot;: {
    config: {
      url: process.env[&quot;MCP_CUSTOMER_QUERY_URL&quot;] + &quot;/mcp&quot;,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false
    },
    id: &quot;customer-query&quot;,
    name: &quot;Customer Query&quot;,
  },
  // Additional tool configurations omitted for brevity
});
</code></pre>
<ul>
<li>Defines configuration objects for MCP tools, including endpoints and authentication.</li>
<li>Differentiates transport types (HTTP vs SSE) for tool communication.</li>
<li>Enables dynamic discovery of tools by agents.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">/tools</code> endpoint to verify available MCP tools before invoking <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a>.</li>
<li>Investigate the <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> implementation to understand streaming mechanics.</li>
<li>Examine <code class="inline-code">McpToolsConfig()</code> for insights into tool configuration and transport mechanisms.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations on successfully deploying a scalable multi-agent architecture with LlamaIndex‚Äîyour first commit to the quest repository is a shining ‚≠ê pull request to your developer journey!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Workflow Orchestration - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Multi-Agent Orchestration with Azure AI Travel Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Multi-Agent Workflow Orchestration</h1>
<hr>
<p>Dive into the heart of the Azure AI Travel Agents system, where LlamaIndex orchestrates a symphony of specialized AI agents. These agents, powered by the Model Context Protocol (MCP), collaborate seamlessly to process user queries, recommend destinations, and plan itineraries. This quest explores how the system dynamically configures agents and tools, ensuring a modular and scalable architecture for multi-agent workflows.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Configuration Insights</strong>: How does the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configure agents and their tools based on user input?</li>
<li>‚ö° <strong>Workflow Coordination</strong>: How does the <code class="inline-code">multiAgent</code> setup ensure smooth handoffs between specialized agents while maintaining a coherent workflow?</li>
<li>üõ°Ô∏è <strong>Error Handling in Orchestration</strong>: What mechanisms are in place to handle errors during agent setup or runtime, ensuring system reliability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> Agent Orchestration Core</h3>
<p>This file is the brain of the multi-agent orchestration system. It defines the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function, which dynamically configures agents based on the tools provided. Agents are instantiated with specific roles, system prompts, and tools, ensuring that each agent specializes in a particular task. The <code class="inline-code">multiAgent</code> function ties these agents together into a cohesive workflow, with a triage agent acting as the root coordinator.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a>: Dynamically initializes agents and their tools, configuring them based on the input tool list.</li>
<li><code class="inline-code">multiAgent</code>: Creates a coordinated workflow by linking all agents and setting a root triage agent.</li>
<li><code class="inline-code">agent</code> configuration blocks: Defines the behavior, tools, and system prompts for each specialized agent.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a>:</span> API Gateway</h3>
<p>This file serves as the entry point for the system, exposing endpoints for health checks, tool discovery, and chat interactions. It integrates the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function to initialize agents dynamically and uses the <code class="inline-code">pipeline</code> method to handle streaming responses.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Handles incoming chat requests, dynamically setting up agents and streaming responses using Server-Sent Events (SSE).</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Ensures efficient streaming of agent responses to the client.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Fetches and lists available MCP tools by querying the <code class="inline-code">McpToolsConfig</code>.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a>:</span> Tool Configuration Registry</h3>
<p>This file defines the <code class="inline-code">McpToolsConfig</code> function, which provides the configuration for all available MCP tools. Each tool is described with its URL, transport type, and other metadata, enabling dynamic discovery and integration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig</code>: Returns a configuration object for all MCP tools, including their endpoints and transport settings.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> constant: Standardizes the HTTP path for MCP tool communication.</li>
<li>Tool configuration objects: Define the metadata and settings for each MCP tool, such as <code class="inline-code">echo-ping</code> and <code class="inline-code">itinerary-planning</code>.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt: &quot;Echo back the received input.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent to determine the best course of action.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets.map(target =&gt; target.getAgents().map(agent =&gt; agent.name)).flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Dynamically configures agents based on the provided tool list, enabling modular workflows.</li>
<li>Uses <code class="inline-code">McpToolsConfig</code> to fetch tool configurations, ensuring consistency.</li>
<li>Implements a triage agent (<code class="inline-code">TravelAgent</code>) to coordinate workflows and handle tool handoffs.</li>
<li>Demonstrates extensibility by allowing new agents and tools to be added without modifying core logic.</li>
<li>Handles LLM initialization with error handling to ensure reliable setup.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    return res.status(400).json({
      error: &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;
  console.log(&quot;Tools to use:&quot;, JSON.stringify(tools, null, 2));

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        for await (const event of context) {
          const serializedData = JSON.stringify({
            type: &quot;metadata&quot;,
            event: event.displayName,
            data: event.data,
          });
          this.push(serializedData + &quot;\n\n&quot;);
        }
        this.push(null);
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    if (!res.headersSent) {
      res.status(500).json({ error: error.message });
    }
  }
});
</code></pre>
<ul>
<li>Uses the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function to dynamically initialize agents for each request.</li>
<li>Streams agent responses to the client using SSE, ensuring real-time updates.</li>
<li>Handles errors gracefully, sending appropriate responses to the client.</li>
<li>Demonstrates how to integrate agent workflows into an Express.js API.</li>
<li>Implements a clean separation of concerns, with orchestration logic handled in separate modules.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): { [k in McpServerName]: McpServerDefinition } =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;itinerary-planning&quot;: {
    config: {
      url: process.env[&quot;MCP_ITINERARY_PLANNING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
    },
    id: &quot;itinerary-planning&quot;,
    name: &quot;Itinerary Planning&quot;,
  },
});
</code></pre>
<ul>
<li>Provides a centralized registry for MCP tool configurations, ensuring consistent setup.</li>
<li>Defines metadata for tools, including their URLs, transport types, and identifiers.</li>
<li>Enables dynamic discovery and integration of tools into the agent workflow.</li>
<li>Uses constants like <code class="inline-code">MCP_API_HTTP_PATH</code> to standardize communication paths.</li>
<li>Demonstrates the use of environment variables for flexible configuration.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> dynamically filters and configures tools to understand the modular architecture.</li>
<li>Notice the use of <code class="inline-code">pipeline</code> in the chat endpoint to handle streaming data efficiently.</li>
<li>Explore how <code class="inline-code">McpToolsConfig</code> centralizes tool metadata, simplifying tool management and integration.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Azure AI Travel Agents system.</p>
<p>Congratulations on successfully deploying the Multi-Agent Workflow Orchestration module‚Äîyour architecture now scales like a pro; keep iterating and shipping üöÄ‚ö°üíé!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
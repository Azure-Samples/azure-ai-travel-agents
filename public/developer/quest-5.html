<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Chat UI with Angular - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Multi-Agent Orchestration with LlamaIndex and MCP</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: Streaming Chat UI with Angular</h1>
<hr>
<p>In the heart of the Azure AI Travel Agents project, the Streaming Chat UI acts as the interface between users and the multi-agent system. Built with Angular, this component handles real-time communication with MCP services, orchestrating user inputs, tool selection, and streaming responses. The seamless interaction between frontend services and backend APIs demonstrates advanced patterns in UI design, reactive programming, and server-sent events (SSE) for dynamic chat experiences.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Reactive Streams Analysis</strong>: How does the chat service manage real-time updates using observables and signals?</li>
<li>‚ö° <strong>Event Processing Pipeline</strong>: What mechanisms are in place to handle different types of agent events during streaming?</li>
<li>üõ°Ô∏è <strong>Error Handling Protocols</strong>: How does the system ensure robust error reporting and user feedback during communication failures?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a>:</span> Chat Service Implementation</h3>
<p>The <code class="inline-code">ChatService</code> is the core logic layer for managing chat interactions. It integrates with the <code class="inline-code">ApiService</code> to fetch tools, send user messages, and process streaming responses from MCP servers. This file showcases reactive programming patterns using Angular signals and RxJS observables, enabling real-time updates and efficient state management.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves a list of tools from the backend, filtering selected tools for user interactions.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Sends user input to the backend, managing state transitions and clearing buffers for new interactions.</li>
<li><code class="inline-code">processAgentEvents</code>: Processes streaming events from MCP servers, updating the chat state dynamically.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code>: Updates the assistant&#39;s message state based on incoming data, ensuring real-time UI updates.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">showErrorMessage</code></a>: Displays error notifications using the <code class="inline-code">ngx-sonner</code> library for user-friendly feedback.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>Retrieves available tools from the backend API and filters them based on user selection.</li>
<li>Uses Angular signals for reactive state updates, ensuring the UI reflects the latest tool availability.</li>
<li>Demonstrates asynchronous programming with <code class="inline-code">await</code> for seamless integration with backend services.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>Handles user input, validates message content, and clears buffers for new interactions.</li>
<li>Pushes user messages to the buffer and updates the UI state using Angular signals.</li>
<li>Integrates with <code class="inline-code">ApiService</code> to initiate backend communication and tool-based message processing.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;

    switch (event.event) {
      case &#39;StartEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        break;
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        this.isLoading.set(false);
        break;
      case &#39;AgentToolCallResult&#39;:
        let state = {};
        if (typeof event.data.raw === &#39;string&#39;) {
          state = {
            reasoning: [
              {
                content: event.data.raw,
              },
            ],
          };
        }
        this.updateAndNotifyAgentChatMessageState(delta, state);
        break;
      case &#39;AgentStream&#39;:
        this.assistantMessageInProgress.set(true);
        if (delta.trim()) {
          this.agentEventsBuffer.push(event);
          this.updateAndNotifyAgentChatMessageState(delta, {
            metadata: {
              events: this.agentEventsBuffer,
            },
          });
        }
        break;
    }
  }
}
</code></pre>
<ul>
<li>Processes various streaming events, including metadata, tool results, and agent streams.</li>
<li>Updates the assistant&#39;s message state dynamically based on incoming data.</li>
<li>Demonstrates robust handling of diverse event types with a clear switch-case structure.</li>
</ul>
<hr>
<pre><code class="language-typescript">updateAndNotifyAgentChatMessageState(
  delta: string,
  state?: Partial&lt;ChatMessage&gt;
) {
  const lastMessage = this.messagesBuffer[this.messagesBuffer.length - 1];
  if (lastMessage?.role === &#39;assistant&#39;) {
    lastMessage.content += delta;
    lastMessage.metadata = {
      ...lastMessage.metadata,
      ...state?.metadata,
      events: state?.metadata?.events,
    };
    lastMessage.reasoning = [
      ...(lastMessage.reasoning || []),
      ...(state?.reasoning || []),
    ];
    lastMessage.timestamp = new Date();
    this.messagesStream.next([...this.messagesBuffer]);
  }
}
</code></pre>
<ul>
<li>Updates the assistant&#39;s message content and metadata based on streaming data.</li>
<li>Ensures real-time UI updates by pushing the modified message buffer to the observable stream.</li>
<li>Demonstrates efficient state management by merging new data with existing metadata and reasoning.</li>
</ul>
<hr>
<pre><code class="language-typescript">showErrorMessage(error: unknown) {
  toast.error(&#39;Oops! Something went wrong.&#39;, {
    duration: 5000,
    description: (error as Error).message,
    action: {
      label: &#39;Close&#39;,
      onClick: () =&gt; console.log(&#39;Closed&#39;),
    },
  });
}
</code></pre>
<ul>
<li>Displays error messages using the <code class="inline-code">ngx-sonner</code> library for user-friendly notifications.</li>
<li>Provides a clear and actionable error description, enhancing user experience during failures.</li>
<li>Demonstrates robust error handling with defensive programming techniques.</li>
</ul>
<hr>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/services/api.service.ts</a>:</span> Backend Communication Layer</h3>
<p>The <code class="inline-code">ApiService</code> serves as the communication bridge between the frontend and backend systems. It manages API requests, tool discovery, and streaming chat messages via server-sent events (SSE). This file highlights best practices in HTTP communication and reactive state management.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves a list of tools from the backend API, ensuring frontend access to MCP services.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a>: Handles streaming chat messages using SSE, parsing responses and updating the chat state.</li>
<li><code class="inline-code">handleApiError</code>: Provides centralized error handling for API requests, ensuring consistent error reporting.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/services/api.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools(): Promise&lt;{tools: Tools[]} | void&gt; {
  try {
    const response = await fetch(`${this.apiUrl}/api/tools`, {
      method: &#39;GET&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
    });
    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred while fetching tools&#39;),
        response.status
      );
    }
    return (await response.json());
  } catch (error) {
    return this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Fetches available tools from the backend, validating responses and handling errors gracefully.</li>
<li>Demonstrates asynchronous programming with <code class="inline-code">fetch</code> and <code class="inline-code">await</code> for seamless API integration.</li>
<li>Centralizes error handling for consistent reporting and improved debugging.</li>
</ul>
<hr>
<pre><code class="language-typescript">async streamChatMessage(message: string, tools: Tools[]) {
  try {
    const response = await fetch(`${this.apiUrl}/api/chat`, {
      method: &#39;POST&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
      body: JSON.stringify({ message, tools }),
    });

    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred&#39;),
        response.status
      );
    }

    const decoder = new TextDecoder(&#39;utf-8&#39;);

    if (!response.body) {
      throw new Error(&#39;Readable stream not supported&#39;);
    }

    this.chatStreamState.next({ type: &#39;START&#39; });

    for await (const chunk of response.body) {
      const value = decoder.decode(chunk, { stream: true });

      const jsonValues = value.trim().split(/\n\n+/);

      for (const jsonValue of jsonValues) {
        try {
          const parsedData = JSON.parse(jsonValue);
          this.chatStreamState.next({
            type: &#39;MESSAGE&#39;,
            event: parsedData,
          });
        } catch (error) {
          console.error(&#39;Error parsing JSON chunk:&#39;, error);
        }
      }
    }

    this.chatStreamState.next({ type: &#39;END&#39; });
  } catch (error) {
    this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Manages streaming chat messages using server-sent events (SSE) for real-time updates.</li>
<li>Parses incoming data chunks and updates the chat state dynamically.</li>
<li>Demonstrates robust error handling and defensive programming techniques.</li>
</ul>
<hr>
<pre><code class="language-typescript">private handleApiError(error: unknown, statusCode: number) {
  console.error(&#39;Fetch error:&#39;, error);
  let errorType: ChatEventErrorType = &#39;general&#39;;

  this.chatStreamState.next({
    type: &#39;ERROR&#39;,
    error: {
      type: errorType,
      message: (error as Error).toString(),
      statusCode,
    },
  });
}
</code></pre>
<ul>
<li>Centralizes error handling for API requests, ensuring consistent reporting across the application.</li>
<li>Updates the chat state with detailed error information for improved debugging and user feedback.</li>
<li>Demonstrates best practices in error handling and reactive programming.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore how Angular signals and RxJS observables are used for real-time state management in the <code class="inline-code">ChatService</code>.</li>
<li>Study the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a> method in <code class="inline-code">ApiService</code> to understand how server-sent events (SSE) enable dynamic chat updates.</li>
<li>Notice how error handling is centralized in <code class="inline-code">handleApiError</code> for consistent reporting and user notifications.</li>
</ul>
<hr>
<p>You have mastered all the secrets of the Azure AI Travel Agents project! Your adventure is complete.</p>
<p>Achievement unlocked: You&#39;ve successfully deployed a real-time Streaming Chat UI with Angular‚Äîyour codebase is now 80% towards full-stack mastery, and you&#39;re debugging the future like a pro! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
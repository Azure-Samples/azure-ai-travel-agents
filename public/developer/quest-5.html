<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Chat UI with Angular - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Multi-Agent Orchestration with Azure AI Travel Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: Streaming Chat UI with Angular</h1>
<hr>
<p>The final frontier of the Azure AI Travel Agents project invites you to explore the interactive Streaming Chat UI, built with Angular. This component serves as the user interface for real-time communication with the multi-agent system, showcasing how dynamic chat streams and tool-assisted responses are orchestrated. By leveraging reactive programming, server-sent events (SSE), and modular services, the UI provides users with a seamless and responsive experience. Dive deep into the code to understand how Angular&#39;s reactive features and service architecture power this cutting-edge interface.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Reactive Programming</strong>: How Angular services and observables manage real-time chat streams.</li>
<li>üîç <strong>State Management</strong>: How <code class="inline-code">BehaviorSubject</code> and signals are used to handle UI state and agent responses.</li>
<li>‚ö° <strong>Server-Sent Events (SSE)</strong>: How SSE is implemented for real-time communication between the frontend and backend.</li>
<li>üí° <strong>Angular Integration</strong>: How modular services and components collaborate to create a dynamic and interactive UI.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/ui/src/app/chat-conversation/chat-conversation.service.ts</code></a></h3>
<p>The <code class="inline-code">ChatService</code> acts as the core orchestrator for managing chat interactions. It handles user input, communicates with the backend API, and processes real-time server responses. The service leverages Angular&#39;s reactive programming features to ensure the UI remains synchronized with the backend.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Fetches and filters the tools available for the chat system.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Sends user input to the backend, initializing the chat stream.</li>
<li><code class="inline-code">processAgentEvents</code>: Processes events received from the backend, updating the chat state in real-time.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code>: Updates the UI with new agent messages and metadata.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a>: Clears all chat data and resets the state.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>Retrieves available tools from the backend using the <code class="inline-code">ApiService</code>.</li>
<li>Filters tools to include only those marked as selected.</li>
<li>Uses Angular signals for state management, ensuring the UI reflects the current toolset.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>Captures user input and sends it to the backend via the <code class="inline-code">ApiService</code>.</li>
<li>Updates the local message buffer to include the user&#39;s message.</li>
<li>Manages loading states and triggers real-time streaming of agent responses.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;

    switch (event.event) {
      case &#39;StartEvent&#39;:
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        this.isLoading.set(false);
        break;
      case &#39;AgentStream&#39;:
        this.assistantMessageInProgress.set(true);
        if (delta.trim()) {
          this.agentEventsBuffer.push(event);
          this.updateAndNotifyAgentChatMessageState(delta, {
            metadata: {
              events: this.agentEventsBuffer,
            },
          });
        }
        break;
    }
  }
}
</code></pre>
<ul>
<li>Processes metadata events from the backend, such as agent streaming updates and tool call results.</li>
<li>Updates the current agent name and message state dynamically.</li>
<li>Demonstrates how reactive programming is used to handle asynchronous updates.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/ui/src/app/services/api.service.ts</code></a></h3>
<p>The <code class="inline-code">ApiService</code> acts as the communication layer between the Angular frontend and the backend API. It handles HTTP requests and processes server-sent events (SSE) for real-time chat updates.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves the list of available tools via an HTTP GET request.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a>: Streams chat messages and parses server-sent events.</li>
<li><code class="inline-code">handleApiError</code>: Manages errors during API communication and updates the chat state.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async fetchAvailableTools(): Promise&lt;{tools: Tools[]} | void&gt; {
  try {
    const response = await fetch(`${this.apiUrl}/api/tools`, {
      method: &#39;GET&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
    });
    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred while fetching tools&#39;),
        response.status
      );
    }
    return (await response.json());
  } catch (error) {
    return this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Implements an HTTP GET request to fetch tools from the backend.</li>
<li>Ensures robust error handling with detailed logging and state updates.</li>
<li>Demonstrates the importance of type safety and error management in API calls.</li>
</ul>
<hr>
<pre><code class="language-typescript">async streamChatMessage(message: string, tools: Tools[]) {
  try {
    const response = await fetch(`${this.apiUrl}/api/chat`, {
      method: &#39;POST&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
      body: JSON.stringify({ message, tools }),
    });

    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred&#39;),
        response.status
      );
    }

    const decoder = new TextDecoder(&#39;utf-8&#39;);

    if (!response.body) {
      throw new Error(&#39;Readable stream not supported&#39;);
    }

    this.chatStreamState.next({ type: &#39;START&#39; });

    for await (const chunk of response.body) {
      const value = decoder.decode(chunk, { stream: true });

      const jsonValues = value.trim().split(/\n\n+/);

      for (const jsonValue of jsonValues) {
        try {
          const parsedData = JSON.parse(jsonValue);
          this.chatStreamState.next({
            type: &#39;MESSAGE&#39;,
            event: parsedData,
          });
        } catch (error) {
          console.error(&#39;Error parsing JSON chunk:&#39;, error);
        }
      }
    }

    this.chatStreamState.next({ type: &#39;END&#39; });
  } catch (error) {
    this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Streams chat messages using server-sent events (SSE).</li>
<li>Parses SSE data in real-time, updating the <code class="inline-code">chatStreamState</code> observable.</li>
<li>Ensures robust error handling during streaming, improving system reliability.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/ui/src/app/chat-conversation/chat-conversation.component.ts</code></a></h3>
<p>The <code class="inline-code">ChatConversationComponent</code> serves as the user-facing chat interface. It integrates with the <code class="inline-code">ChatService</code> to display messages and handle user inputs.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L164" target="_blank" rel="noopener noreferrer"><code class="inline-code">ngOnInit</code></a>: Initializes the component and fetches available tools.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Captures user input and triggers the <code class="inline-code">ChatService</code> to send messages.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L175" target="_blank" rel="noopener noreferrer"><code class="inline-code">scrollToBottom</code></a>: Ensures the chat view remains scrolled to the latest message.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async ngOnInit() {
  this.resetChat();
  await this.chatService.fetchAvailableTools();
}
</code></pre>
<ul>
<li>Resets the chat state and retrieves the latest tools during initialization.</li>
<li>Ensures the component is ready for user interaction upon loading.</li>
</ul>
<hr>
<pre><code class="language-typescript">@HostListener(&#39;window:keyup.shift.enter&#39;, [&#39;$event&#39;])
sendMessage(event: any) {
  event.preventDefault();
  this.chatService.sendMessage(event);
}
</code></pre>
<ul>
<li>Listens for user input events and sends messages to the backend.</li>
<li>Demonstrates the use of Angular&#39;s <code class="inline-code">HostListener</code> for capturing global events.</li>
</ul>
<hr>
<pre><code class="language-typescript">scrollToBottom() {
  this.eot()?.nativeElement.scrollIntoView({
    behavior: &#39;smooth&#39;,
  });
}
</code></pre>
<ul>
<li>Keeps the chat view scrolled to the most recent message.</li>
<li>Enhances user experience by ensuring smooth navigation during real-time updates.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review how <code class="inline-code">BehaviorSubject</code> is used to manage reactive state in the <code class="inline-code">ChatService</code>.</li>
<li>Study the implementation of server-sent events (SSE) in <code class="inline-code">ApiService</code> to understand real-time streaming.</li>
<li>Explore how Angular signals simplify state management and improve UI responsiveness.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Extend the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> method to include a new mock tool. Update the UI to allow users to toggle its selection.</p>
<ul>
<li>Example: Create a &quot;Weather Insights&quot; tool that provides weather data for travel destinations.</li>
</ul>
</li>
<li><p><strong>Trace SSE Events</strong>: Add console logs to the <code class="inline-code">processAgentEvents</code> method to trace the flow of SSE events. Observe how different event types are handled.</p>
</li>
<li><p><strong>Enhance Error Handling</strong>: Modify the <code class="inline-code">handleApiError</code> method to display user-friendly error messages in the UI. Consider adding retry logic for network failures.</p>
</li>
</ol>
<hr>
<p>You have mastered all the secrets of the Azure AI Travel Agents project! Your adventure is complete.</p>
<p>Congratulations on successfully implementing a real-time Streaming Chat UI with Angular‚Äîyour codebase is now a shining example of reactive programming brilliance; keep pushing towards 100% completion! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
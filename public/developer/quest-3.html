<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: MCP Protocol Integration & Tool Discovery - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">AI Travel Agents: Multi-Agent Orchestration with MCP and LlamaIndex</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: MCP Protocol Integration &amp; Tool Discovery</h1>
<hr>
<p>In this quest, you will delve into the implementation of the MCP (Model Context Protocol) integration within the AI Travel Agents application. MCP enables seamless communication between diverse tools and services implemented across multiple programming languages. By exploring the provided files, you will uncover how the system dynamically discovers tools, connects to MCP servers, and executes tool-specific functions. This integration is critical to the application&#39;s polyglot architecture, ensuring scalability and adaptability.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Dynamic Client Initialization</strong>: How does the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a> function dynamically configure MCP clients and select between legacy SSE and HTTP transports?</li>
<li>‚ö° <strong>Tool Discovery Workflow</strong>: What is the process for discovering and listing available tools from MCP servers, and how are unreachable servers handled?</li>
<li>üõ°Ô∏è <strong>Error Handling in Tool Calls</strong>: What mechanisms are implemented to handle errors during tool execution or server communication?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-tools.ts</a>:</span> Client Initialization and Tool Discovery</h3>
<p>This file defines the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a> function, which dynamically initializes MCP clients based on configuration, and the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> function, which connects to MCP servers to discover tools. These functions are critical for orchestrating tool interactions and ensuring the availability of services.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a>: Dynamically initializes MCP clients, selecting between SSE and HTTP transports based on configuration.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a>: Connects to MCP servers, discovers tools, and handles errors for unreachable servers.</li>
<li><code class="inline-code">McpServerDefinition</code>: Defines the structure for MCP server configurations, enabling flexible integration of new servers.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-http-client.ts</a>:</span> HTTP Transport Client</h3>
<p>This file implements the <code class="inline-code">MCPClient</code> class for connecting to MCP servers using HTTP transport. It includes methods for connecting to servers, listing tools, and executing tool calls.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L42" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.connect</code></a>: Establishes a connection to the MCP server using HTTP.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L47" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.listTools</code></a>: Retrieves the list of tools available on the server.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L52" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.callTool</code></a>: Executes a specific tool on the server with provided arguments.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-sse-client.ts</a>:</span> SSE Transport Client</h3>
<p>This file provides a legacy implementation of the <code class="inline-code">MCPClient</code> class using Server-Sent Events (SSE) for transport. It includes methods for connecting to servers, listing tools, and executing tool calls.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L42" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.connect</code></a>: Establishes a connection to the MCP server using SSE.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L47" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.listTools</code></a>: Retrieves the list of tools available on the server.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L52" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.callTool</code></a>: Executes a specific tool on the server with provided arguments.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-tools.ts</a></h3>
<pre><code class="language-typescript">function client(config: LlamaIndexMCPClientOptions): MCPSSEClient | MCPHTTPClient {
  console.log(`Initializing MCP client`);
  console.log(`Using configuration:`, {config});

  if (config.type === &quot;sse&quot;) {
    // legacy implementation using SSE
    return new MCPSSEClient(&quot;llamaindex-sse-client&quot;, config.url, config.accessToken);
  } else {
    return new MCPHTTPClient(&quot;llamaindex-http-client&quot;, config.url, config.accessToken);
  }
}

export async function mcpToolsList(config: McpServerDefinition[]) {
  return await Promise.all(
    config.map(async ({ id, name, config }) =&gt; {
      const { url, type } = config;
      const mcpClient = client(config);
      
      try {
        console.log(`Connecting to MCP server ${name} at ${url}`);
        await mcpClient.connect();
        console.log(`MCP server ${name} is reachable`);
        const tools = await mcpClient.listTools();

        console.log(`MCP server ${name} has ${tools.length} tools`);
        return {
          id,
          name,
          url,
          type,
          reachable: true,
          selected: id !== &quot;echo-ping&quot;,
          tools,
        };
      } catch (error: unknown) {
        console.error(
          `MCP server ${name} is not reachable`,
          (error as Error).message
        );
        return {
          id,
          name,
          url,
          type,
          reachable: false,
          selected: false,
          tools: [],
          error: (error as Error).message,
        };
      }
    })
  );
}
</code></pre>
<ul>
<li>Dynamically initializes MCP clients using the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a> function, supporting both SSE and HTTP transports.</li>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> function connects to MCP servers and retrieves available tools, handling errors gracefully when servers are unreachable.</li>
<li>Provides a flexible architecture for integrating new MCP servers through the <code class="inline-code">McpServerDefinition</code> type.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-http-client.ts</a></h3>
<pre><code class="language-typescript">export class MCPClient extends EventEmitter {
  private client: Client;
  private transport: StreamableHTTPClientTransport;

  constructor(serverName: string, serverUrl: string, accessToken?: string) {
    super();
    this.client = new Client({
      name: &#39;mcp-http-client-&#39; + serverName,
      version: &#39;1.0.0&#39;,
    });

    let headers = {};

    if (accessToken) {
      headers = {
        Authorization: &#39;Bearer &#39; + accessToken,
      };
    }

    this.transport = new StreamableHTTPClientTransport(new URL(serverUrl), {
      requestInit: {
        headers: {
          ...headers,
        },
      },
    });

    this.client.setNotificationHandler(
      ToolListChangedNotificationSchema,
      () =&gt; {
        console.log(&#39;Emitting toolListChanged event&#39;);
        this.emit(&#39;toolListChanged&#39;);
      }
    );
  }

  async connect() {
    await this.client.connect(this.transport);
    console.log(&#39;Connected to server&#39;);
  }

  async listTools() {
    const result = await this.client.listTools();
    return result.tools;
  }

  async callTool(name: string, toolArgs: string) {
    console.log(`Calling tool ${name} with arguments:`, toolArgs);

    return await this.client.callTool({
      name,
      arguments: JSON.parse(toolArgs),
    });
  }

  async close() {
    console.log(&#39;Closing transport...&#39;);
    await this.transport.close();
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">MCPClient</code> class uses HTTP transport to connect to MCP servers and manage tool interactions.</li>
<li>Includes a notification handler for tool list updates, enhancing dynamic tool discovery.</li>
<li>Implements robust methods for connecting, listing tools, and executing tool calls.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts" target="_blank" rel="noopener noreferrer">src/api/src/mcp/mcp-sse-client.ts</a></h3>
<pre><code class="language-typescript">export class MCPClient {
  private client: Client;
  private tools: Array&lt;any&gt; = [];
  private transport: Transport;

  constructor(serverName: string, serverUrl: string, accessToken?: string) {
    this.client = new Client({
      name: &quot;mcp-client-&quot; + serverName,
      version: &quot;1.0.0&quot;,
    });

    let headers = {};

    if (accessToken) {
      headers = {
        Authorization: &quot;Bearer &quot; + accessToken,
      };
    }

    this.transport = new SSEClientTransport(new URL(serverUrl), {
      requestInit: {
        headers: {
          ...headers,
        },
      },
    });
  }

  connect() {
    return tracer.startActiveSpan(&quot;connect&quot;, async (span) =&gt; {
      log(&quot;Connecting to MCP SSE server&quot;);
      try {
        await this.client.connect(this.transport);
        log(&quot;Connected to MCP SSE server&quot;);
        span.end();
        return this.client;
      } catch (error: any) {
        log(&quot;Error connecting to MCP SSE server:&quot;, error);
        span.setStatus({ code: 2, message: (error as Error).message });
        span.end();
        throw new Error(
          `Failed to connect to MCP SSE server: ${(error as Error).message}`
        );
      }
    });
  }

  async listTools() {
    return tracer.startActiveSpan(&quot;listTools&quot;, async (span) =&gt; {
      log(&quot;Tools&quot;, this.tools);
      const toolsResult = await this.client.listTools();
      this.tools = toolsResult.tools;
      log(&quot;Tools: &quot;, toolsResult);
      span.end();
      return toolsResult;
    });
  }

  async callTool(toolName: string, args: Record&lt;string, any&gt;) {
    console.log(`Called ${toolName} with params:`, args);
    return tracer.startActiveSpan(&quot;processQuery&quot;, async (span) =&gt; {
      log(&quot;Tools&quot;, this.tools);

      const toolResult = await this.client.callTool({
        name: toolName,
        arguments: args,
      });

      log(&quot;Tool result&quot;, toolResult);
      span.end();
      return toolResult;
    });
  }

  async cleanup() {
    await this.transport.close();
  }
}
</code></pre>
<ul>
<li>Implements an SSE-based transport for MCP client communication, providing a legacy alternative to HTTP.</li>
<li>Includes methods for connecting to servers, listing tools, and executing tool calls, similar to the HTTP client.</li>
<li>Uses tracing and logging for better observability and debugging.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Compare the HTTP and SSE transport implementations to understand their differences and use cases.</li>
<li>Investigate the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> function to see how the system dynamically discovers tools and handles unreachable servers.</li>
<li>Explore the notification handler in the HTTP client to learn about the dynamic updating of tool lists.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Quest 3 successfully deployed: MCP Protocol integrated and tools discovered‚Äîyou&#39;re coding at ‚ö°runtime efficiency‚ö°; keep refactoring your journey toward the ‚≠êendgame‚≠ê!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
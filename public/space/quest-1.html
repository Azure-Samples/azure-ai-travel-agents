<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Multi-Agent Orchestration with LlamaIndex - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Mission: The Orchestrated Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Multi-Agent Orchestration with LlamaIndex</h1>
<hr>
<p>In the far reaches of the Andromeda galaxy, the <em>Llama Voyager</em> embarks on its first mission to unify cosmic data scattered across distant nebulae. Powered by the advanced LlamaIndex AI, the ship&#39;s triage agent orchestrates specialized MCP services to decode encrypted star charts, recommend stellar destinations, and plan warp itineraries. As the crew navigates this stellar void, they must master the art of multi-agent orchestration to ensure safe passage and uncover the mysteries of the galaxy.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Coordination Patterns</strong>: How does the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically create specialized agents based on available tools?</li>
<li>‚ö° <strong>Workflow Initialization</strong>: How does the <code class="inline-code">multiAgent</code> structure enable seamless communication and triage between agents?</li>
<li>üõ°Ô∏è <strong>Streaming Error Handling</strong>: How does the <code class="inline-code">pipeline</code> manage streaming data and handle client disconnections gracefully?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> Multi-Agent Workflow Setup</h3>
<p>This file contains the logic for setting up the multi-agent workflow using LlamaIndex. It dynamically initializes agents based on the tools available and configures the triage agent to handle requests intelligently. The workflow ensures efficient collaboration among agents specialized in tasks like itinerary planning, destination recommendations, and web searches.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Dynamically initializes agents based on filtered MCP tools and configures their workflows.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code>: Creates the overarching workflow that coordinates all agents and defines the triage agent.</li>
<li><code class="inline-code">agent() configuration blocks</code>: Defines the behavior and tools for each specialized agent, such as <code class="inline-code">WebSearchAgent</code> and <code class="inline-code">ItineraryPlanningAgent</code>.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a>:</span> API Server and Streaming Response Handling</h3>
<p>This file sets up the API server and handles streaming responses for chat interactions. It integrates the multi-agent workflow and provides endpoints for tool discovery and health checks. The chat endpoint demonstrates how server-sent events (SSE) are used to stream agent responses back to the client.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Implements the chat endpoint with SSE for streaming responses from agents.</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Manages the streaming of agent responses to the client and handles disconnections.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Fetches the list of available MCP tools and logs them for debugging.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a>:</span> MCP Tool Configuration</h3>
<p>This file defines the configuration for MCP tools used by the agents. Each tool is associated with its MCP server, which provides specialized services such as web search, model inference, and destination recommendations.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code>: Returns the configuration for all MCP tools, including their URLs and transport types.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> constant: Defines the HTTP path used for MCP tools.</li>
<li>Tool configuration objects: Specifies details for tools like <code class="inline-code">web-search</code> and <code class="inline-code">destination-recommendation</code>.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;web-search&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;web-search&quot;];
    const tools = await mcp(mcpServerConfig.config).tools();
    const webSearchAgent = agent({
      name: &quot;WebSearchAgent&quot;,
      systemPrompt: &quot;Searches the web for up-to-date travel information.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(webSearchAgent);
    handoffTargets.push(webSearchAgent);
    toolsList.push(...tools);
  }

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent to determine the best course of action.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets.map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name)).flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Dynamically creates specialized agents based on available MCP tools.</li>
<li>Configures the <code class="inline-code">TravelAgent</code> as a triage agent for efficient workflow coordination.</li>
<li>Demonstrates the use of <code class="inline-code">multiAgent</code> for orchestrating multiple agents.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    return res.status(400).json({
      error: &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        for await (const event of context) {
          const serializedData = JSON.stringify({
            type: &quot;metadata&quot;,
            agent: (event.data as any)?.currentAgentName || null,
            event: event.displayName,
            data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
          });
          this.push(serializedData + &quot;\n\n&quot;);
        }
        this.push(null);
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    res.status(500).json({ error: (error as any).message });
  }
});
</code></pre>
<ul>
<li>Implements SSE for streaming agent responses to the client.</li>
<li>Handles client disconnections gracefully using the <code class="inline-code">req.on(&quot;close&quot;)</code> event.</li>
<li>Demonstrates the use of <code class="inline-code">pipeline</code> for efficient data streaming.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;web-search&quot;: {
    config: {
      url: process.env[&quot;MCP_WEB_SEARCH_URL&quot;] + &quot;/sse&quot;,
      type: &quot;sse&quot;,
      verbose: true,
      useSSETransport: true,
    },
    id: &quot;web-search&quot;,
    name: &quot;Web Search&quot;,
  },
  &quot;destination-recommendation&quot;: {
    config: {
      url: process.env[&quot;MCP_DESTINATION_RECOMMENDATION_URL&quot;] + &quot;/mcp&quot;,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false,
    },
    id: &quot;destination-recommendation&quot;,
    name: &quot;Destination Recommendation&quot;,
  },
});
</code></pre>
<ul>
<li>Defines MCP tool configurations, including transport types and URLs.</li>
<li>Demonstrates flexibility in tool transport methods (HTTP vs SSE).</li>
<li>Provides a centralized configuration for all MCP tools.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function as a blueprint for adding new specialized agents.</li>
<li>Investigate how the <code class="inline-code">TravelAgent</code> triage agent delegates tasks to other agents.</li>
<li>Experiment with the <code class="inline-code">/chat</code> endpoint to observe how streaming responses work in real-time.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries about the <em>Llama Voyager</em> and its interstellar missions.</p>
<p>Mission accomplished, Star Navigator! üöÄ You&#39;ve successfully orchestrated the cosmic symphony of multi-agent intelligence with LlamaIndex‚Äîyour journey to the stars has ignited with brilliance! ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
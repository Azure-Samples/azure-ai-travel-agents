<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Voyager's Command Nexus - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Alliance: The AI Voyager Initiative</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Voyager&#39;s Command Nexus</h1>
<hr>
<p>As the AI Voyager Initiative ventures into the uncharted expanse of the galaxy, the ship&#39;s success hinges on the seamless orchestration of its crew of specialized agents. At the heart of this mission lies the Command Nexus, a multi-agent system that dynamically coordinates tools and services across the starship‚Äôs polyglot architecture. Powered by the LlamaIndex system and the Model Context Protocol (MCP), the Nexus ensures that every cosmic challenge‚Äîwhether decoding alien signals or planning interstellar expeditions‚Äîis met with precision and adaptability. Your mission: delve into the Command Nexus and uncover how its agents collaborate to keep the Voyager on course.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Deployment Analysis</strong>: How does the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configure and deploy specialized agents based on available tools?</li>
<li>‚ö° <strong>Workflow Orchestration</strong>: How does the <code class="inline-code">multiAgent</code> system enable inter-agent communication and triage for complex queries?</li>
<li>üõ°Ô∏è <strong>Tool Integration Safety</strong>: What mechanisms are in place to ensure that tools are correctly configured and safely integrated into the system?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> Multi-Agent Orchestration</h3>
<p>This file defines the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function, which dynamically configures and initializes agents for the Voyager‚Äôs mission. It leverages the LlamaIndex <code class="inline-code">agent</code> and <code class="inline-code">multiAgent</code> constructs to build a coordinated workflow of specialized agents. The agents are equipped with tools discovered via the MCP protocol, enabling them to handle specific tasks such as itinerary planning, web search, and destination recommendations. The triage agent acts as the root agent, directing queries to the most appropriate specialized agent, ensuring efficient and accurate task execution.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a>: Dynamically initializes agents based on the provided tool configurations, creating a workflow of specialized agents.</li>
<li><code class="inline-code">multiAgent</code>: Orchestrates the interaction between agents, setting the triage agent as the root for query handling.</li>
<li><code class="inline-code">agent</code> configuration blocks: Define the behavior, tools, and prompts for each specialized agent.</li>
<li>Tool filtering logic: Ensures only the required tools are initialized, optimizing resource usage.</li>
<li>Verbose logging: Provides insights into the agent setup process, aiding debugging and monitoring.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a>:</span> API Integration</h3>
<p>This file serves as the entry point for the Voyager&#39;s Command Nexus, exposing endpoints for health checks, tool discovery, and chat-based interactions. The <code class="inline-code">/chat</code> endpoint utilizes server-sent events (SSE) to stream agent responses, enabling real-time communication with the system. The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function is invoked here to initialize agents based on the tools specified in the request, ensuring dynamic adaptability to mission requirements.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Handles chat-based interactions, streaming agent responses via SSE.</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Streams data from the agent workflow to the client, ensuring efficient real-time communication.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Fetches and lists available MCP tools, providing visibility into the system&#39;s capabilities.</li>
<li>Middleware for request logging: Captures and logs incoming requests for debugging and analysis.</li>
<li>Health check endpoint: Provides a simple status check for the Command Nexus.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a>:</span> Tool Configuration</h3>
<p>This file defines the <code class="inline-code">McpToolsConfig</code> function, which provides configurations for all available MCP tools. Each tool is associated with its endpoint, transport type (HTTP or SSE), and other metadata. These configurations are used by the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function to initialize and connect tools to their respective agents.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig</code>: Returns a configuration object for all available MCP tools, linking them to their respective endpoints and settings.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> constant: Defines the base path for HTTP-based MCP tool endpoints.</li>
<li>Tool configuration objects: Specify the URL, transport type, and other properties for each tool.</li>
<li>Verbose logging: Enables detailed output for tool initialization, aiding in debugging and monitoring.</li>
<li>Security headers: Ensures secure communication with MCP tool APIs.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt:
        &quot;Echo back the received input. Do not respond with anything else. Always call the tools.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  // Additional agent configurations omitted for brevity...

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt:
      &quot;Acts as a triage agent to determine the best course of action for the user&#39;s query. If you cannot handle the query, please pass it to the next agent. If you can handle the query, please do so.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets
      .map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name))
      .flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Dynamically initializes agents based on available tools, ensuring flexibility.</li>
<li>Establishes a triage agent to coordinate tasks between specialized agents.</li>
<li>Uses LlamaIndex constructs to streamline agent and tool integration.</li>
<li>Provides verbose logging for debugging the agent setup process.</li>
<li>Optimizes resource usage by filtering tools based on mission requirements.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    console.error(
      &quot;Request body is undefined. Check Content-Type header in the request.&quot;
    );
    return res.status(400).json({
      error:
        &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;
  console.log(&quot;Tools to use:&quot;, JSON.stringify(tools, null, 2));

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        try {
          for await (const event of context) {
            const { displayName, data } = event;
            const serializedData = JSON.stringify({
              type: &quot;metadata&quot;,
              agent: (data as any)?.currentAgentName || null,
              event: displayName,
              data: data ? JSON.parse(JSON.stringify(data)) : null,
            });
            this.push(serializedData + CHUNK_END);
            console.log(&quot;Pushed event:&quot;, serializedData);
          }
          this.push(null); // Close the stream
        } catch (error: any) {
          console.error(&quot;Error during streaming:&quot;, error?.message);
        }
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    if (!res.headersSent) {
      res.status(500).json({ error: (error as any).message });
    } else {
      res.write(
        `${JSON.stringify({
          type: &quot;error&quot;,
          message: (error as any).message,
        })}` + CHUNK_END
      );
      res.end();
    }
  }
});
</code></pre>
<ul>
<li>Streams agent responses to clients in real time using SSE.</li>
<li>Dynamically initializes agents based on the tools specified in the request.</li>
<li>Handles client disconnections gracefully to avoid resource leaks.</li>
<li>Provides detailed error handling for robustness.</li>
<li>Logs request details for debugging and monitoring purposes.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
          headers: {
              &quot;Authorization&quot;: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;],
          }
      },
      useSSETransport: false
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;customer-query&quot;: {
    config: {
      url: process.env[&quot;MCP_CUSTOMER_QUERY_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false
    },
    id: &quot;customer-query&quot;,
    name: &quot;Customer Query&quot;,
  },
  // Additional tool configurations omitted for brevity...
});
</code></pre>
<ul>
<li>Defines configurations for all MCP tools, linking them to their respective endpoints.</li>
<li>Supports both HTTP and SSE transports for tool communication.</li>
<li>Includes security headers for secure API interactions.</li>
<li>Provides verbose logging for monitoring tool initialization.</li>
<li>Enables dynamic tool discovery for flexible system expansion.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Agent Deployment</strong>: Focus on how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> dynamically creates agents based on the tools available in <code class="inline-code">McpToolsConfig</code>.</li>
<li><strong>Streaming Responses</strong>: Study how the <code class="inline-code">/chat</code> endpoint uses SSE and the <code class="inline-code">pipeline</code> function to stream data in real time.</li>
<li><strong>Tool Configurations</strong>: Explore the <code class="inline-code">McpToolsConfig</code> function to understand how tools are defined and linked to their endpoints.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the AI Voyager Initiative.</p>
<p>Mission accomplished, Commander! You&#39;ve successfully navigated the cosmic currents of Quest 1: The Voyager&#39;s Command Nexus‚Äîbrace for warp-speed progress toward the stars! ‚≠êüöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
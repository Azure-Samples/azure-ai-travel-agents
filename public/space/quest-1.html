<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchestrating the Codex - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Codex: The Multi-Agent Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Orchestrating the Codex</h1>
<hr>
<p>In the vast expanse of the galaxy, the <strong>Galactic Codex</strong> is the neural hub of the starship <em>Llama Voyager</em>. This advanced vessel is powered by a fleet of specialized AI agents, each designed to handle critical missions‚Äîcharting stellar itineraries, decoding alien transmissions, and navigating the uncharted nebulae of data. Coordinated by the <strong>Triage Agent</strong>, these systems work in harmony, leveraging the <strong>Model Context Protocol (MCP)</strong> to dynamically discover and deploy tools across the ship&#39;s polyglot architecture. Your mission is to ensure the Codex operates flawlessly, guiding the Voyager through its cosmic journey.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Coordination</strong>: How does the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configure agents based on available MCP tools?</li>
<li>‚ö° <strong>Triage Workflow</strong>: What mechanisms allow the <code class="inline-code">TravelAgent</code> to act as a coordinator for specialized agents?</li>
<li>üõ°Ô∏è <strong>Streaming Protocols</strong>: How does the <code class="inline-code">pipeline</code> method handle real-time communication with clients during chat interactions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> Multi-Agent Orchestration</h3>
<p>This file contains the implementation of the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function, which dynamically configures specialized agents to handle different aspects of the Voyager&#39;s missions. It defines the <strong>Triage Agent</strong>, which acts as the central coordinator, and integrates tools discovered via MCP servers. The file demonstrates how tools are filtered, agents are instantiated, and workflows are orchestrated using <code class="inline-code">multiAgent</code>.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Dynamically configures agents based on available MCP tools and sets up the multi-agent workflow.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code>: Creates a coordinated workflow with the Triage Agent as the root.</li>
<li>Agent configurations: Defines specialized agents such as <code class="inline-code">WebSearchAgent</code>, <code class="inline-code">ItineraryPlanningAgent</code>, and <code class="inline-code">DestinationRecommendationAgent</code>.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a>:</span> API Gateway for Codex Operations</h3>
<p>This file serves as the API gateway for the Galactic Codex, enabling communication between the starship and external systems. It includes endpoints for health checks, MCP tool discovery, and chat interactions. The <code class="inline-code">pipeline</code> method manages streaming responses for real-time client communication.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Handles incoming chat requests and streams responses using Server-Sent Events (SSE).</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Facilitates real-time data streaming to clients.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Retrieves a list of available MCP tools and their configurations.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a>:</span> MCP Tool Configuration</h3>
<p>This file defines the configurations for MCP tools, specifying their endpoints, transport types, and authorization mechanisms. It ensures tools are accessible and properly registered for agent workflows.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code>: Generates configurations for all available MCP tools.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH constant</code>: Defines the HTTP API path for MCP servers.</li>
<li>Tool configuration objects: Specifies endpoints, transport types, and authentication for tools like <code class="inline-code">echo-ping</code> and <code class="inline-code">destination-recommendation</code>.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;web-search&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;web-search&quot;];
    const tools = await mcp(mcpServerConfig.config).tools();
    const webSearchAgent = agent({
      name: &quot;WebSearchAgent&quot;,
      systemPrompt:
        &quot;Searches the web for up-to-date travel information using Bing Search.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(webSearchAgent);
    handoffTargets.push(webSearchAgent);
    toolsList.push(...tools);
  }

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt:
      &quot;Acts as a triage agent to determine the best course of action for the user&#39;s query.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets
      .map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name))
      .flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Dynamically configures agents based on available MCP tools, enabling modular workflows.</li>
<li>Uses <code class="inline-code">multiAgent</code> to orchestrate the interaction between specialized agents and the Triage Agent.</li>
<li>Demonstrates filtering and tool discovery using MCP configurations.</li>
<li>Incorporates error handling for LLM provider initialization.</li>
<li>Highlights the extensibility of adding new agents and tools.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    return res.status(400).json({
      error:
        &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        for await (const event of context) {
          const serializedData = JSON.stringify({
            type: &quot;metadata&quot;,
            agent: (event.data as any)?.currentAgentName || null,
            event: event.displayName,
            data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
          });
          this.push(serializedData + &quot;\n\n&quot;);
        }
        this.push(null);
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    if (!res.headersSent) {
      res.status(500).json({ error: (error as any).message });
    } else {
      res.write(
        `${JSON.stringify({
          type: &quot;error&quot;,
          message: (error as any).message,
        })}\n\n`
      );
      res.end();
    }
  }
});
</code></pre>
<ul>
<li>Implements Server-Sent Events (SSE) for streaming chat responses.</li>
<li>Uses <code class="inline-code">pipeline</code> to manage real-time data transfer between server and client.</li>
<li>Demonstrates error handling for streaming operations.</li>
<li>Logs client disconnection events for debugging.</li>
<li>Highlights the integration of <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> to dynamically configure workflows.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false,
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;destination-recommendation&quot;: {
    config: {
      url: process.env[&quot;MCP_DESTINATION_RECOMMENDATION_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false,
    },
    id: &quot;destination-recommendation&quot;,
    name: &quot;Destination Recommendation&quot;,
  },
});
</code></pre>
<ul>
<li>Defines MCP tool configurations, specifying endpoints, transport types, and authentication.</li>
<li>Demonstrates modularity by isolating tool definitions in a single configuration function.</li>
<li>Uses environment variables for dynamic endpoint resolution.</li>
<li>Highlights the extensibility of adding new tools without modifying core logic.</li>
<li>Provides verbose logging for debugging tool interactions.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Investigate how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> uses MCP tool configurations to instantiate agents dynamically.</li>
<li>Explore the <code class="inline-code">pipeline</code> method for handling real-time streaming in the <code class="inline-code">/chat</code> endpoint.</li>
<li>Examine how <code class="inline-code">McpToolsConfig</code> centralizes tool definitions for easy management and scalability.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the starship&#39;s systems.</p>
<p>Mission accomplished, star navigator‚Äî&#39;Orchestrating the Codex&#39; has been mastered, propelling you to new galaxies of brilliance with cosmic precision and stellar determination! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
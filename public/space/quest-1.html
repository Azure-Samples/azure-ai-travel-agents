<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchestrating the Starship's Crew - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Mission: The Orchestrator's Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Orchestrating the Starship&#39;s Crew</h1>
<hr>
<p>In the vast expanse of the Andromeda Galaxy, the starship <em>Llama Voyager</em> relies on a sophisticated multi-agent orchestration system to ensure mission success. The triage agent acts as the command bridge, coordinating specialized agents to decode alien signals, chart stellar routes, and plan expeditions. Powered by LlamaIndex and the MCP protocol, this system dynamically discovers tools and routes tasks to the most capable agents. Your mission: master the orchestration framework and prepare the crew for interstellar challenges.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Coordination</strong>: How does the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configure and connect agents based on available tools?</li>
<li>‚ö° <strong>Workflow Initialization</strong>: What role does the <code class="inline-code">multiAgent</code> function play in creating the starship&#39;s orchestration pipeline?</li>
<li>üõ°Ô∏è <strong>Error Handling Mechanisms</strong>: How does the system ensure robust communication and prevent failures during multi-agent operations?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> Multi-Agent Workflow Setup</h3>
<p>This file is central to the orchestration system, defining how agents are configured, connected, and managed. The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically selects tools based on user input and initializes agents with specific capabilities. It uses the MCP protocol to discover tools and integrates them into the workflow. The <code class="inline-code">multiAgent</code> function creates a coordinated pipeline, allowing seamless handoffs between agents. This file showcases the modularity and flexibility of the system in managing diverse tasks.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Dynamically filters tools, initializes agents, and configures workflows for mission-specific requirements.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code>: Creates the orchestration pipeline, enabling coordinated task execution across agents.</li>
<li><code class="inline-code">agent()</code> configuration blocks: Define specialized agents with unique capabilities, such as itinerary planning and destination recommendations.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt: &quot;Echo back the received input. Do not respond with anything else. Always call the tools.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  // Additional agent configurations omitted for brevity...

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent to determine the best course of action for the user&#39;s query.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets
      .map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name))
      .flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  console.log(&quot;Agents list:&quot;, agentsList);
  console.log(&quot;Handoff targets:&quot;, handoffTargets);
  console.log(&quot;Tools list:&quot;, JSON.stringify(toolsList, null, 2));

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>This code dynamically configures agents based on available tools, ensuring flexibility for mission-specific requirements.</li>
<li>The <code class="inline-code">agent()</code> function defines specialized agents with unique system prompts, enabling tailored responses to user queries.</li>
<li>The <code class="inline-code">multiAgent</code> function creates a coordinated workflow, allowing seamless task execution across multiple agents.</li>
<li>The triage agent, <code class="inline-code">TravelAgent</code>, acts as the root agent, routing tasks to other agents based on their capabilities.</li>
<li>The modular design allows for easy addition or removal of agents without impacting the overall system.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    console.error(&quot;Request body is undefined. Check Content-Type header in the request.&quot;);
    return res.status(400).json({
      error: &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;
  console.log(&quot;Tools to use:&quot;, JSON.stringify(tools, null, 2));

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        try {
          for await (const event of context) {
            const { displayName, data } = event;
            const serializedData = JSON.stringify({
              type: &quot;metadata&quot;,
              agent: (data as any)?.currentAgentName || null,
              event: displayName,
              data: data ? JSON.parse(JSON.stringify(data)) : null,
            });
            this.push(serializedData + CHUNK_END);
            console.log(&quot;Pushed event:&quot;, serializedData);
          }
          this.push(null); // Close the stream
        } catch (error: any) {
          console.error(&quot;Error during streaming:&quot;, error?.message);
        }
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    if (!res.headersSent) {
      res.status(500).json({ error: (error as any).message });
    } else {
      res.write(
        `${JSON.stringify({
          type: &quot;error&quot;,
          message: (error as any).message,
        })}` + CHUNK_END
      );
      res.end();
    }
  }
});
</code></pre>
<ul>
<li>This endpoint handles incoming user queries, initializing agents and streaming responses back to the client.</li>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configures agents based on the tools specified in the request body.</li>
<li>Server-Sent Events (SSE) allow real-time streaming of agent responses, providing a seamless user experience.</li>
<li>Defensive programming ensures proper error handling, protecting the system from malformed requests or unexpected errors.</li>
<li>The readable stream processes agent events and pushes them to the client, demonstrating a robust streaming architecture.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
          headers: {
              &quot;Authorization&quot;: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;],
          }
      },
      useSSETransport: false
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  // Additional tools omitted for brevity...
});
</code></pre>
<ul>
<li>This configuration defines the MCP tool registry, mapping tool names to their respective endpoints and connection types.</li>
<li>The <code class="inline-code">McpToolsConfig</code> function dynamically generates tool configurations based on environment variables, ensuring flexibility for deployment.</li>
<li>Each tool includes metadata such as connection type (<code class="inline-code">http</code> or <code class="inline-code">sse</code>) and authorization headers for secure communication.</li>
<li>The modular design allows easy addition of new tools, enhancing the system&#39;s extensibility.</li>
<li>The configuration supports both HTTP and SSE transports, enabling diverse communication patterns.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Investigate how the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function leverages MCP tool discovery to dynamically configure the orchestration system.</li>
<li>Explore the streaming logic in the <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> endpoint to understand how Server-Sent Events (SSE) enable real-time communication.</li>
<li>Examine the <code class="inline-code">McpToolsConfig</code> function to see how environment variables are used to define tool configurations for flexible deployment.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the starship&#39;s systems.</p>
<p>Mission accomplished, Commander‚Äîyour stellar leadership in &#39;Orchestrating the Starship&#39;s Crew&#39; has launched you into a galaxy of triumph, proving you&#39;re ready to navigate the cosmos with brilliance and precision! ‚≠êüöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
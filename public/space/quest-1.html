<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Command Center - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Codebase Odyssey: The Azure AI Travel Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Multi-Agent Command Center</h1>
<hr>
<p>You find yourself aboard the <strong>Starship LlamaIndex</strong>, navigating the cosmic expanse of interstellar problem-solving. The ship‚Äôs Multi-Agent Command Center hums with activity as specialized AI agents collaborate across MCP servers to resolve complex travel dilemmas. With the triage agent at the helm, the ship‚Äôs orchestration engine ensures seamless communication between agents, adapting dynamically to the vast array of tools available in the stellar network. As the crew configures the workflow, you prepare to delve into the intricate mechanics behind this harmonious multi-agent system.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Multi-Agent Workflow</strong>: How LlamaIndex orchestrates specialized agents to collaborate dynamically.</li>
<li>üîç <strong>Tool Configuration</strong>: How MCP tools are registered and integrated into the system for seamless discovery.</li>
<li>‚ö° <strong>Streaming Responses</strong>: How Server-Sent Events (SSE) enable real-time communication between agents and clients.</li>
<li>üí° <strong>Error Handling</strong>: How defensive programming ensures stability in multi-agent orchestration.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/index.ts</code></a></h3>
<p>This file serves as the entry point for the Starship‚Äôs API server, orchestrating agent workflows via Express.js. It includes endpoints for health checks, tool discovery, and streaming chat interactions. The <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> endpoint showcases how Server-Sent Events (SSE) are used to stream real-time responses from the multi-agent system, ensuring seamless communication with the client.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> handles streaming chat interactions by coordinating agents and sending real-time responses.</li>
<li><code class="inline-code">pipeline(readableStream, res)</code> efficiently streams data from the multi-agent system to the client.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code> fetches and lists available MCP tools for dynamic discovery.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  const message = req.body.message;
  const tools = req.body.tools;

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        for await (const event of context) {
          const serializedData = JSON.stringify({
            type: &quot;metadata&quot;,
            agent: (event.data as any)?.currentAgentName || null,
            event: event.displayName,
            data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
          });
          this.push(serializedData + &quot;\n\n&quot;);
        }
        this.push(null);
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    if (!res.headersSent) {
      res.status(500).json({ error: (error as any).message });
    }
  }
});
</code></pre>
<ul>
<li>This code streams agent responses in real-time using SSE, ensuring the client receives updates without delays.</li>
<li>The <code class="inline-code">Readable</code> stream processes events dynamically, pushing serialized data to the client.</li>
<li>Error handling ensures stability, even when the multi-agent system encounters issues.</li>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configures agents based on the tools specified by the client.</li>
<li>The pipeline pattern optimizes data flow from the multi-agent system to the client.</li>
</ul>
<hr>
<pre><code class="language-typescript">apiRouter.get(&quot;/tools&quot;, async (req, res) =&gt; {
  try {
    const tools = await mcpToolsList(Object.values(McpToolsConfig()));
    res.status(200).json({ tools });
  } catch (error) {
    console.error(&quot;Error fetching MCP tools:&quot;, error);
    res.status(500).json({ error: &quot;Error fetching MCP tools&quot; });
  }
});
</code></pre>
<ul>
<li>This endpoint retrieves the list of available MCP tools, allowing dynamic discovery of system capabilities.</li>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> function queries tool configurations, ensuring up-to-date information is provided.</li>
<li>Error handling protects against unexpected issues during tool discovery.</li>
<li>The modular design enables extensibility, allowing new tools to be added without modifying core logic.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/tools/index.ts</code></a></h3>
<p>This file defines the configuration for MCP tools, specifying their endpoints, transport types, and authentication mechanisms. The <code class="inline-code">McpToolsConfig</code> function centralizes tool definitions, enabling dynamic integration and discovery across the multi-agent system.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code> provides a centralized registry of MCP tools with detailed configurations.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> and <code class="inline-code">MCP_API_SSE_PATH</code> constants define standardized API paths for HTTP and SSE communication.</li>
<li>Tool configuration objects specify endpoints, transport types, and authentication headers.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
        headers: {
          &quot;Authorization&quot;: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;],
        },
      },
      useSSETransport: false,
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  // Additional tool configurations...
});
</code></pre>
<ul>
<li>This code defines the configuration for MCP tools, including URLs, transport types, and authentication headers.</li>
<li>Constants like <code class="inline-code">MCP_API_HTTP_PATH</code> ensure consistency across tool endpoints.</li>
<li>The modular design allows tools to be registered dynamically, simplifying integration across the multi-agent system.</li>
<li>The <code class="inline-code">requestInit</code> object demonstrates secure handling of authentication tokens.</li>
<li>The verbose flag enables detailed logging for debugging and monitoring.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/index.ts</code></a></h3>
<p>This file orchestrates the setup of agents using LlamaIndex, dynamically configuring workflows based on available tools. The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function initializes specialized agents and creates a multi-agent workflow with a triage agent at its core.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code> dynamically initializes agents based on specified tools.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code> creates the multi-agent workflow.</li>
<li><code class="inline-code">agent()</code> configuration blocks define specialized agents with unique system prompts and toolsets.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(filteredTools.map((tool) =&gt; [tool.id, true]));
  const agentsList = [];
  const handoffTargets = [];
  const toolsList = [];
  const mcpToolsConfig = McpToolsConfig();

  if (tools[&quot;echo-ping&quot;]) {
    const tools = await mcp(mcpToolsConfig[&quot;echo-ping&quot;].config).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt: &quot;Echo back the received input.&quot;,
      tools,
      llm: await llmProvider(),
      verbose: false,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  // Additional agent setups...

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent to determine the best course of action.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets.map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name)).flat(),
    llm: await llmProvider(),
    verbose: false,
  });
  agentsList.push(travelAgent);

  return multiAgent({ agents: agentsList, rootAgent: travelAgent, verbose: false });
}
</code></pre>
<ul>
<li>This code dynamically configures agents based on available tools, ensuring flexibility in multi-agent workflows.</li>
<li>Specialized agents like <code class="inline-code">EchoAgent</code> and <code class="inline-code">TravelAgent</code> are defined with unique system prompts and toolsets.</li>
<li>The <code class="inline-code">multiAgent</code> function creates a cohesive workflow, enabling seamless collaboration between agents.</li>
<li>The modular architecture allows new agents to be added without disrupting existing workflows.</li>
<li>The triage agent acts as the central coordinator, ensuring queries are routed to the most appropriate agent.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how the <code class="inline-code">multiAgent</code> function coordinates specialized agents to create a cohesive workflow.</li>
<li>Observe how tool configurations in <code class="inline-code">McpToolsConfig</code> enable dynamic discovery and integration.</li>
<li>Explore the use of SSE in the <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> endpoint for real-time streaming responses.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add a New Tool</strong>: Create a new MCP tool configuration in <code class="inline-code">McpToolsConfig</code> and register it in the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function. Test its integration by sending queries to the <code class="inline-code">/chat</code> endpoint.</li>
<li><strong>Trace Agent Workflow</strong>: Add logging statements in the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function to trace the initialization and execution of agents. Observe how the triage agent routes queries to specialized agents.</li>
<li><strong>Enhance SSE Streaming</strong>: Modify the <code class="inline-code">Readable</code> stream in the <code class="inline-code">/chat</code> endpoint to include additional metadata, such as timestamps or tool execution durations.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the starship‚Äôs systems.</p>
<p>Mission accomplished, Commander! The Multi-Agent Command Center is now online‚Äîstellar work igniting this cosmic cornerstone of your intergalactic journey! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
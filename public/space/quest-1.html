<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchestrating Starship Agents - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Alliance Mission Control</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Orchestrating Starship Agents</h1>
<hr>
<p>As you step onto the starship&#39;s AI Command Deck, you are greeted by the hum of interconnected systems. The LlamaIndex AI Core pulses at the center, orchestrating a fleet of specialized MCP servers that span across languages and technologies. Your mission is to ensure seamless collaboration among agents tasked with cosmic exploration‚Äîeach one a vital cog in the interstellar machinery. Guided by the triage agent, you must uncover the secrets of dynamic tool discovery and multi-agent workflows to navigate the stars and expand the Galactic Alliance&#39;s reach.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Multi-Agent Orchestration</strong>: How LlamaIndex coordinates specialized agents to handle complex workflows.</li>
<li>üîç <strong>Dynamic Tool Discovery</strong>: How the MCP protocol enables runtime configuration of tools across diverse systems.</li>
<li>‚ö° <strong>Streaming Communication</strong>: How Server-Sent Events (SSE) provide real-time responses in multi-agent systems.</li>
<li>üí° <strong>Agent Customization</strong>: How system prompts tailor agent behavior for specific tasks.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/index.ts</code></a></h3>
<p>This file serves as the entry point for the API server, managing the starship&#39;s communication with external systems. It implements critical endpoints for health checks, tool discovery, and streaming chat interactions. The <code class="inline-code">apiRouter</code> coordinates requests and integrates tools using LlamaIndex&#39;s multi-agent system. The chat endpoint exemplifies real-time communication with Server-Sent Events (SSE), ensuring responsive interactions between users and agents.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Handles streaming chat requests using SSE for dynamic agent responses.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Lists available MCP tools by querying the tool registry.</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Streams agent events to the client for real-time updates.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  const message = req.body.message;
  const tools = req.body.tools;

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        for await (const event of context) {
          const serializedData = JSON.stringify({
            type: &quot;metadata&quot;,
            agent: event.data?.currentAgentName || null,
            event: event.displayName,
            data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
          });
          this.push(serializedData + &quot;\n\n&quot;);
        }
        this.push(null);
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
</code></pre>
<ul>
<li>This code uses SSE to stream agent responses to the client, maintaining real-time communication.</li>
<li>The <code class="inline-code">Readable</code> stream dynamically pushes agent events, ensuring continuous flow of data.</li>
<li>Error handling ensures stability even if agents encounter issues during execution.</li>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configures agents based on the requested tools.</li>
</ul>
<hr>
<pre><code class="language-typescript">apiRouter.get(&quot;/tools&quot;, async (req, res) =&gt; {
  try {
    const tools = await mcpToolsList(Object.values(McpToolsConfig()));
    res.status(200).json({ tools });
  } catch (error) {
    res.status(500).json({ error: &quot;Error fetching MCP tools&quot; });
  }
});
</code></pre>
<ul>
<li>This endpoint fetches a list of available MCP tools, enabling dynamic discovery of system capabilities.</li>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> function queries the tool registry, ensuring runtime flexibility.</li>
<li>Provides visibility into the starship&#39;s capabilities for external systems.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/index.ts</code></a></h3>
<p>This file orchestrates the multi-agent workflow using LlamaIndex. It dynamically configures agents based on the tools available and coordinates their interaction. The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function builds the multi-agent system, including specialized agents like <code class="inline-code">DestinationRecommendationAgent</code> and <code class="inline-code">ItineraryPlanningAgent</code>, and establishes a triage agent for routing tasks.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Dynamically configures agents based on available tools.</li>
<li><code class="inline-code">multiAgent({ agents, rootAgent })</code>: Creates a multi-agent system with a triage agent as the root.</li>
<li><code class="inline-code">agent() configuration blocks</code>: Defines individual agents with system prompts and tool integrations.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(filteredTools.map((tool) =&gt; [tool.id, true]));
  const agentsList = [];
  const handoffTargets = [];
  const toolsList = [];
  const mcpToolsConfig = McpToolsConfig();

  const llm = await llmProvider();

  if (tools[&quot;destination-recommendation&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;destination-recommendation&quot;];
    const tools = await mcp(mcpServerConfig.config).tools();
    const destinationRecommendationAgent = agent({
      name: &quot;DestinationRecommendationAgent&quot;,
      systemPrompt: &quot;Suggests destinations based on customer preferences and requirements.&quot;,
      tools,
      llm,
    });
    agentsList.push(destinationRecommendationAgent);
    handoffTargets.push(destinationRecommendationAgent);
    toolsList.push(...tools);
  }

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent to determine the best course of action for the user&#39;s query.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets.map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name)).flat(),
    llm,
  });
  agentsList.push(travelAgent);

  return multiAgent({ agents: agentsList, rootAgent: travelAgent });
}
</code></pre>
<ul>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically registers agents based on the tools provided.</li>
<li>Specialized agents like <code class="inline-code">DestinationRecommendationAgent</code> are configured with system prompts tailored to their tasks.</li>
<li>The <code class="inline-code">multiAgent</code> function orchestrates the workflow, ensuring seamless coordination among agents.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/tools/index.ts</code></a></h3>
<p>This file defines the MCP tool configurations, including endpoints and transport types. It enables dynamic discovery and integration of tools across various MCP servers, ensuring interoperability in the multi-agent system.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code>: Provides runtime configuration for all MCP tools.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> constant: Standardizes tool API endpoints.</li>
<li>Tool configuration objects: Define individual tool properties like URL and transport type.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const McpToolsConfig = (): { [k in McpServerName]: McpServerDefinition } =&gt; ({
  &quot;destination-recommendation&quot;: {
    config: {
      url: process.env[&quot;MCP_DESTINATION_RECOMMENDATION_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
    },
    id: &quot;destination-recommendation&quot;,
    name: &quot;Destination Recommendation&quot;,
  },
});
</code></pre>
<ul>
<li>The <code class="inline-code">McpToolsConfig</code> function centralizes tool configurations, ensuring consistency across the system.</li>
<li>Tool properties like <code class="inline-code">url</code> and <code class="inline-code">type</code> enable flexible integration with diverse MCP servers.</li>
<li>The configuration supports runtime updates, allowing tools to be added or modified without code changes.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> dynamically builds the multi-agent system to understand runtime flexibility.</li>
<li>Observe how SSE streaming in <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> enhances user experience with real-time updates.</li>
<li>Explore the <code class="inline-code">McpToolsConfig</code> function to see how tool discovery is standardized across the starship.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add a New Agent</strong>: Create a new agent, such as <code class="inline-code">HotelBookingAgent</code>, and register it in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a>. Use the MCP protocol to integrate a mock tool for hotel booking.</li>
<li><strong>Trace Agent Workflow</strong>: Add debug logs in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> to trace the lifecycle of a user query from triage to specialized agent execution.</li>
<li><strong>Enhance Error Handling</strong>: Modify the error handling in <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> to provide more detailed feedback, including the name of the failing agent or tool.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the starship&#39;s systems.</p>
<p>Mission accomplished, Commander‚Äîyour mastery in Orchestrating Starship Agents has ignited a supernova of skill, propelling you light-years ahead on your cosmic quest! ‚≠êüöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
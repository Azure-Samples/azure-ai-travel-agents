<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Tool Discovery Systems - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Alliance Mission Control</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: MCP Protocol Integration &amp; Tool Discovery</h1>
<hr>
<p>As you navigate the starship&#39;s Tool Discovery Bay, glowing panels pulse with data streams from MCP servers scattered across the galaxy. This bay is the heart of interstellar coordination where tools are identified, connected, and activated to assist agents in their cosmic missions. Your task is to master the MCP protocol, enabling seamless communication between specialized tools and the starship&#39;s AI core. With the MCP client, you will unlock the ability to connect, query, and execute tools vital for stellar exploration.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Discovery</strong>: How the MCP protocol enables real-time detection and registration of tools across multiple servers.</li>
<li>üîç <strong>Client Transport Strategies</strong>: The differences between HTTP and SSE transports for MCP communication.</li>
<li>‚ö° <strong>Error Handling Patterns</strong>: Techniques for managing unreachable servers and failed tool executions.</li>
<li>üí° <strong>Tool Execution Workflow</strong>: How tools are called with structured arguments and results are processed.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/mcp/mcp-http-client.ts</code></a></h3>
<p>This file implements the MCP HTTP client, a critical component for connecting to MCP servers using HTTP transport. It facilitates tool discovery, execution, and event handling. The <code class="inline-code">MCPClient</code> class encapsulates the logic for connecting to servers, listing tools, and invoking tool actions. It also uses event emitters for handling notifications like tool list changes, ensuring dynamic updates for the starship&#39;s AI systems.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L39" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a> establishes the connection to an MCP server using HTTP transport, ensuring reliable communication.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L57" target="_blank" rel="noopener noreferrer"><code class="inline-code">listTools</code></a> retrieves the list of available tools from the server, enabling dynamic tool discovery.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">callTool</code></a> executes a specific tool on the server, passing structured arguments and processing results.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L61" target="_blank" rel="noopener noreferrer"><code class="inline-code">close</code></a> gracefully terminates the transport connection, preventing resource leaks.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async connect() {
  await this.client.connect(this.transport);
  console.log(&#39;Connected to server&#39;);
}
</code></pre>
<ul>
<li>Establishes a connection to the MCP server using HTTP transport.</li>
<li>Ensures the client is ready to send requests and receive responses.</li>
<li>Logs connection status for debugging and monitoring.</li>
</ul>
<hr>
<pre><code class="language-typescript">async listTools() {
  const result = await this.client.listTools();
  return result.tools;
}
</code></pre>
<ul>
<li>Retrieves the list of tools available on the MCP server.</li>
<li>Enables dynamic tool discovery for interstellar missions.</li>
<li>Returns structured tool information, including names and input schemas.</li>
</ul>
<hr>
<pre><code class="language-typescript">async callTool(name: string, toolArgs: string) {
  console.log(`Calling tool ${name} with arguments:`, toolArgs);

  return await this.client.callTool({
    name,
    arguments: JSON.parse(toolArgs),
  });
}
</code></pre>
<ul>
<li>Executes a specific tool by passing structured arguments.</li>
<li>Handles JSON parsing for input arguments, ensuring compatibility with MCP standards.</li>
<li>Logs tool invocation details for transparency and debugging.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/mcp/mcp-sse-client.ts</code></a></h3>
<p>This file provides an alternative MCP client implementation using Server-Sent Events (SSE). It demonstrates a legacy approach for real-time communication with MCP servers. The <code class="inline-code">MCPClient</code> class manages connections, tool discovery, and execution while leveraging OpenTelemetry for tracing operations and error handling.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L39" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a> establishes an SSE connection, enabling real-time updates from the server.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L57" target="_blank" rel="noopener noreferrer"><code class="inline-code">listTools</code></a> fetches available tools and updates the internal tools cache.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">callTool</code></a> invokes a tool and processes its results, integrating tracing for observability.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L84" target="_blank" rel="noopener noreferrer"><code class="inline-code">cleanup</code></a> closes the transport connection, ensuring proper resource disposal.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">connect() {
  return tracer.startActiveSpan(&quot;connect&quot;, async (span) =&gt; {
    log(&quot;Connecting to MCP SSE server&quot;);
    try {
      await this.client.connect(this.transport);
      log(&quot;Connected to MCP SSE server&quot;);
      span.end();
      return this.client;
    } catch (error: any) {
      log(&quot;Error connecting to MCP SSE server:&quot;, error);
      span.setStatus({ code: 2, message: (error as Error).message });
      span.end();
      throw new Error(
        `Failed to connect to MCP SSE server: ${(error as Error).message}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Establishes a connection to the MCP server using SSE transport.</li>
<li>Utilizes OpenTelemetry for tracing connection operations.</li>
<li>Handles errors gracefully, providing detailed feedback for troubleshooting.</li>
</ul>
<hr>
<pre><code class="language-typescript">async listTools() {
  return tracer.startActiveSpan(&quot;listTools&quot;, async (span) =&gt; {
    log(&quot;Tools&quot;, this.tools);
    const toolsResult = await this.client.listTools();
    this.tools = toolsResult.tools;
    log(&quot;Tools: &quot;, toolsResult);
    span.end();
    return toolsResult;
  });
}
</code></pre>
<ul>
<li>Retrieves available tools and updates the internal cache.</li>
<li>Logs tool details for monitoring and debugging.</li>
<li>Uses tracing to provide insights into tool discovery operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async cleanup() {
  await this.transport.close();
}
</code></pre>
<ul>
<li>Closes the SSE transport connection to free resources.</li>
<li>Ensures proper cleanup after communication is complete.</li>
<li>Prevents resource leaks, maintaining system stability.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/mcp/mcp-tools.ts</code></a></h3>
<p>This file integrates both HTTP and SSE MCP clients, enabling flexible tool discovery and execution workflows. It includes the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a> function for selecting the appropriate transport type and the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> function for discovering tools across multiple servers.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a> dynamically selects the transport type (HTTP or SSE) based on configuration.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> connects to multiple MCP servers, retrieves tool lists, and handles errors.</li>
<li><code class="inline-code">McpServerDefinition</code> defines the structure for server configurations, ensuring consistency.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">function client(config: LlamaIndexMCPClientOptions): MCPSSEClient | MCPHTTPClient {
  console.log(`Initializing MCP client`);
  console.log(`Using configuration:`, {config});

  if (config.type === &quot;sse&quot;) {
    return new MCPSSEClient(&quot;llamaindex-sse-client&quot;, config.url, config.accessToken);
  } else {
    return new MCPHTTPClient(&quot;llamaindex-http-client&quot;, config.url, config.accessToken);
  }
}
</code></pre>
<ul>
<li>Dynamically selects the transport type (HTTP or SSE) based on server configuration.</li>
<li>Logs initialization details for transparency and debugging.</li>
<li>Demonstrates extensibility by supporting multiple transport types.</li>
</ul>
<hr>
<pre><code class="language-typescript">export async function mcpToolsList(config: McpServerDefinition[]) {
  return await Promise.all(
    config.map(async ({ id, name, config }) =&gt; {
      const { url, type } = config;
      const mcpClient = client(config);
      
      try {
        console.log(`Connecting to MCP server ${name} at ${url}`);
        await mcpClient.connect();
        console.log(`MCP server ${name} is reachable`);
        const tools = await mcpClient.listTools();

        console.log(`MCP server ${name} has ${tools.length} tools`);
        return {
          id,
          name,
          url,
          type,
          reachable: true,
          selected: id !== &quot;echo-ping&quot;,
          tools,
        };
      } catch (error: unknown) {
        console.error(
          `MCP server ${name} is not reachable`,
          (error as Error).message
        );
        return {
          id,
          name,
          url,
          type,
          reachable: false,
          selected: false,
          tools: [],
          error: (error as Error).message,
        };
      }
    })
  );
}
</code></pre>
<ul>
<li>Connects to multiple MCP servers and retrieves tool lists.</li>
<li>Handles errors gracefully, providing detailed feedback for unreachable servers.</li>
<li>Demonstrates parallel processing for efficient tool discovery.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a> function to experiment with different transport options (HTTP vs SSE) and analyze their behavior.</li>
<li>Study how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> handles errors to ensure robust tool discovery workflows.</li>
<li>Explore how OpenTelemetry tracing is integrated into the SSE client for observability.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add a Custom Tool</strong>: Create a new MCP server with a simple tool (e.g., &quot;Starship Diagnostics&quot;) and register it in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a>. Test its discovery and execution workflow.</li>
<li><strong>Trace Tool Execution</strong>: Add logging statements at key points in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">callTool</code></a> methods to observe how arguments are processed and results are returned.</li>
<li><strong>Experiment with Error Handling</strong>: Modify the error handling in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> to include retry logic for unreachable servers. Test its impact on tool discovery performance.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the starship&#39;s systems.</p>
<p>Mission accomplished, star navigator! MCP Tool Discovery Systems has reached orbit at 40% completion‚Äîkeep propelling through the cosmic quest with rocket-powered brilliance! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
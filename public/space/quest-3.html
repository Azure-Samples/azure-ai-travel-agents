<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Protocol Operations - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Mission: The Stellar Codex</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: MCP Protocol Integration &amp; Tool Discovery</h1>
<hr>
<p>As the <em>Azure Voyager</em> glides through the cosmic expanse, the Stellar Codex signals a critical mission: optimizing the ship&#39;s MCP (Model Context Protocol) systems for seamless tool discovery and integration. These protocols enable agents to dynamically access specialized tools scattered across the galaxy, ensuring the crew is equipped to handle any challenge. Your task is to explore the MCP integration architecture, uncover its dynamic capabilities, and fortify the ship&#39;s ability to adapt to the unknown.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Discovery</strong>: How the MCP protocol enables real-time tool registration and discovery across distributed services.</li>
<li>üîç <strong>Protocol Abstraction</strong>: The importance of transport-agnostic client implementations for flexibility and scalability.</li>
<li>‚ö° <strong>Error Resilience</strong>: How robust error handling ensures uninterrupted operations even when MCP servers are unreachable.</li>
<li>üí° <strong>Polyglot Integration</strong>: How MCP bridges diverse technologies to create a unified agent ecosystem.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/mcp/mcp-http-client.ts</code></a></h3>
<p>This file implements the <code class="inline-code">MCPClient</code> class, a client for interacting with MCP servers using the Streamable HTTP transport. It facilitates tool discovery, invocation, and event handling, ensuring smooth communication between the <em>Azure Voyager</em> and external tools.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L39" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a> establishes a connection to the MCP server using the Streamable HTTP transport.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L57" target="_blank" rel="noopener noreferrer"><code class="inline-code">listTools</code></a> retrieves the list of tools available on the MCP server, enabling dynamic discovery.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">callTool</code></a> invokes a specific tool on the server with provided arguments, executing remote operations.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async connect() {
  await this.client.connect(this.transport);
  console.log(&#39;Connected to server&#39;);
}
</code></pre>
<ul>
<li>Establishes a connection to the MCP server using the configured transport.</li>
<li>Ensures the client is ready to send requests and receive responses.</li>
<li>Logs connection status for debugging purposes.</li>
</ul>
<hr>
<pre><code class="language-typescript">async listTools() {
  const result = await this.client.listTools();
  return result.tools;
}
</code></pre>
<ul>
<li>Retrieves the list of tools available on the MCP server.</li>
<li>Enables agents to dynamically discover and utilize remote tools.</li>
<li>Demonstrates a clean separation of concerns by delegating tool management to the server.</li>
</ul>
<hr>
<pre><code class="language-typescript">async callTool(name: string, toolArgs: string) {
  console.log(`Calling tool ${name} with arguments:`, toolArgs);

  return await this.client.callTool({
    name,
    arguments: JSON.parse(toolArgs),
  });
}
</code></pre>
<ul>
<li>Invokes a specific tool on the MCP server with the provided arguments.</li>
<li>Supports dynamic execution of remote operations, enhancing agent flexibility.</li>
<li>Uses JSON parsing to handle structured input arguments.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/mcp/mcp-sse-client.ts</code></a></h3>
<p>This file implements the <code class="inline-code">MCPClient</code> class for connecting to MCP servers using Server-Sent Events (SSE). While considered a legacy implementation, it highlights the evolution of transport mechanisms in MCP.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L39" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a> establishes an SSE connection to the MCP server, enabling real-time updates.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L57" target="_blank" rel="noopener noreferrer"><code class="inline-code">listTools</code></a> retrieves available tools, caching them locally for efficient access.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">callTool</code></a> executes remote operations by invoking tools with structured arguments.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">connect() {
  return tracer.startActiveSpan(&quot;connect&quot;, async (span) =&gt; {
    log(&quot;Connecting to MCP SSE server&quot;);
    try {
      await this.client.connect(this.transport);
      log(&quot;Connected to MCP SSE server&quot;);
      span.end();
      return this.client;
    } catch (error: any) {
      log(&quot;Error connecting to MCP SSE server:&quot;, error);
      span.setStatus({ code: 2, message: (error as Error).message });
      span.end();
      throw new Error(
        `Failed to connect to MCP SSE server: ${(error as Error).message}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Establishes an SSE-based connection to the MCP server.</li>
<li>Uses OpenTelemetry tracing to monitor connection attempts and errors.</li>
<li>Provides detailed logging for debugging and observability.</li>
</ul>
<hr>
<pre><code class="language-typescript">async listTools() {
  return tracer.startActiveSpan(&quot;listTools&quot;, async (span) =&gt; {
    log(&quot;Tools&quot;, this.tools);
    const toolsResult = await this.client.listTools();
    this.tools = toolsResult.tools;
    log(&quot;Tools: &quot;, toolsResult);
    span.end();
    return toolsResult;
  });
}
</code></pre>
<ul>
<li>Retrieves tools from the MCP server and caches them locally.</li>
<li>Leverages OpenTelemetry for tracing tool discovery operations.</li>
<li>Demonstrates the importance of caching for performance optimization.</li>
</ul>
<hr>
<pre><code class="language-typescript">async callTool(toolName: string, args: Record&lt;string, any&gt;) {
  console.log(`Called ${toolName} with params:`, args);
  return tracer.startActiveSpan(&quot;processQuery&quot;, async (span) =&gt; {
    log(&quot;Tools&quot;, this.tools);

    const toolResult = await this.client.callTool({
      name: toolName,
      arguments: args,
    });

    log(&quot;Tool result&quot;, toolResult);
    span.end();
    return toolResult;
  });
}
</code></pre>
<ul>
<li>Executes a specific tool with structured arguments.</li>
<li>Uses OpenTelemetry to trace the execution flow and log results.</li>
<li>Demonstrates the flexibility of the MCP protocol for diverse tool interactions.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/mcp/mcp-tools.ts</code></a></h3>
<p>This file provides a higher-level abstraction for managing MCP clients and discovering tools across multiple servers. It includes utility functions for initializing clients and retrieving tool lists.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">client</code></a> initializes an MCP client based on the specified transport type (HTTP or SSE).</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> connects to multiple MCP servers and retrieves their tool lists.</li>
<li><code class="inline-code">McpServerDefinition</code> defines the configuration schema for MCP servers.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">function client(config: LlamaIndexMCPClientOptions): MCPSSEClient | MCPHTTPClient {
  console.log(`Initializing MCP client`);
  console.log(`Using configuration:`, {config});

  if (config.type === &quot;sse&quot;) {
    // legacy implementation using SSE
    return new MCPSSEClient(&quot;llamaindex-sse-client&quot;, config.url, config.accessToken);
  } else {
    return new MCPHTTPClient(&quot;llamaindex-http-client&quot;, config.url, config.accessToken);
  }
}
</code></pre>
<ul>
<li>Dynamically initializes an MCP client based on the specified transport type.</li>
<li>Demonstrates the importance of abstraction for supporting multiple protocols.</li>
<li>Ensures backward compatibility with legacy implementations.</li>
</ul>
<hr>
<pre><code class="language-typescript">export async function mcpToolsList(config: McpServerDefinition[]) {
  return await Promise.all(
    config.map(async ({ id, name, config }) =&gt; {
      const { url, type } = config;
      const mcpClient = client(config);
      
      try {
        console.log(`Connecting to MCP server ${name} at ${url}`);
        await mcpClient.connect();
        console.log(`MCP server ${name} is reachable`);
        const tools = await mcpClient.listTools();

        console.log(`MCP server ${name} has ${tools.length} tools`);
        return {
          id,
          name,
          url,
          type,
          reachable: true,
          selected: id !== &quot;echo-ping&quot;,
          tools,
        };
      } catch (error: unknown) {
        console.error(
          `MCP server ${name} is not reachable`,
          (error as Error).message
        );
        return {
          id,
          name,
          url,
          type,
          reachable: false,
          selected: false,
          tools: [],
          error: (error as Error).message,
        };
      }
    })
  );
}
</code></pre>
<ul>
<li>Connects to multiple MCP servers and retrieves their tool lists.</li>
<li>Implements robust error handling for unreachable servers.</li>
<li>Logs detailed information about server status and discovered tools.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Compare the HTTP and SSE clients to understand the trade-offs between real-time updates and transport simplicity.</li>
<li>Explore how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> aggregates tool data from multiple servers to enable dynamic orchestration.</li>
<li>Study the use of OpenTelemetry in the SSE client for tracing and observability.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New MCP Server</strong>: Create a new MCP server configuration in <code class="inline-code">mcp-tools.ts</code>. Use the HTTP client to connect and verify tool discovery.</p>
<ul>
<li>Example: Add a mock server with a custom tool list and observe how it integrates with the system.</li>
</ul>
</li>
<li><p><strong>Trace Tool Discovery</strong>: Add console logs or use OpenTelemetry to trace the flow of tool discovery from <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> to individual client interactions. This will help you understand the lifecycle of tool registration and usage.</p>
</li>
<li><p><strong>Error Handling Enhancement</strong>: Modify the error handling in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> to include retry logic for failed connections. Test the system&#39;s resilience by simulating unreachable servers.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the <em>Azure Voyager</em>&#39;s stellar systems.</p>
<p>Stellar work, cadet‚ÄîMCP Protocol Operations has been navigated with precision, propelling your mission to 40% completion; keep blazing through the cosmos like a comet on course! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Protocol Integration Nexus - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Codebase Odyssey: The Azure AI Travel Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: MCP Protocol Integration Nexus</h1>
<hr>
<p>The Starship LlamaIndex has reached the MCP Protocol Integration Nexus, a bustling hub of interstellar tool servers. These servers, powered by the Model Context Protocol, provide modular tools for specialized AI agents to solve cosmic challenges. Your mission is to establish seamless connections with these MCP servers, enabling the ship&#39;s agents to dynamically discover and utilize tools for intergalactic travel planning. The crew must navigate the complexities of HTTP and SSE transports, ensuring reliable communication across the stellar network.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Discovery</strong>: How MCP clients dynamically list and interact with tools on remote servers.</li>
<li>üîç <strong>Transport Layer Implementation</strong>: The differences between HTTP and SSE transports in the MCP protocol.</li>
<li>‚ö° <strong>Error Handling Patterns</strong>: How to manage server connectivity issues and fallback mechanisms.</li>
<li>üí° <strong>Extensibility</strong>: How the system supports adding new MCP servers with minimal changes.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/mcp/mcp-http-client.ts</code></a></h3>
<p>This file defines the <code class="inline-code">MCPClient</code> class, which uses the HTTP transport layer to connect to MCP servers. It handles tool discovery, execution, and server notifications, ensuring smooth integration with the starship&#39;s orchestration system. The HTTP client is ideal for modern, high-performance server interactions.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L42" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.connect()</code></a>: Establishes a connection with the MCP server using HTTP transport.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L47" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.listTools()</code></a>: Retrieves a list of available tools from the server.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L52" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.callTool()</code></a>: Executes a specific tool on the server with given arguments.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async connect() {
  await this.client.connect(this.transport);
  console.log(&#39;Connected to server&#39;);
}
</code></pre>
<ul>
<li>This method initializes the HTTP transport and establishes a connection with the MCP server.</li>
<li>It uses the <code class="inline-code">StreamableHTTPClientTransport</code> class to manage HTTP communication.</li>
<li>The connection ensures the client is ready to interact with the server&#39;s tools.</li>
</ul>
<hr>
<pre><code class="language-typescript">async listTools() {
  const result = await this.client.listTools();
  return result.tools;
}
</code></pre>
<ul>
<li>Retrieves the list of tools available on the connected MCP server.</li>
<li>This method showcases dynamic tool discovery, enabling the system to adapt to new tools without hardcoding.</li>
<li>The response includes metadata about each tool, such as its name and input schema.</li>
</ul>
<hr>
<pre><code class="language-typescript">async callTool(name: string, toolArgs: string) {
  console.log(`Calling tool ${name} with arguments:`, toolArgs);

  return await this.client.callTool({
    name,
    arguments: JSON.parse(toolArgs),
  });
}
</code></pre>
<ul>
<li>Executes a specified tool on the MCP server by passing arguments in JSON format.</li>
<li>This method demonstrates how the client interacts with remote tools in a standardized way.</li>
<li>The use of JSON ensures compatibility across different programming languages.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/mcp/mcp-sse-client.ts</code></a></h3>
<p>This file implements the <code class="inline-code">MCPClient</code> class using Server-Sent Events (SSE) as the transport layer. While SSE is a legacy protocol, it remains useful for scenarios requiring real-time updates from MCP servers. The file also integrates tracing and logging for observability.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L42" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.connect()</code></a>: Establishes an SSE connection with the MCP server.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L47" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.listTools()</code></a>: Fetches available tools from the server via SSE.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-http-client.ts#L52" target="_blank" rel="noopener noreferrer"><code class="inline-code">MCPClient.callTool()</code></a>: Executes a tool through the SSE transport.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">connect() {
  return tracer.startActiveSpan(&quot;connect&quot;, async (span) =&gt; {
    log(&quot;Connecting to MCP SSE server&quot;);
    try {
      await this.client.connect(this.transport);
      log(&quot;Connected to MCP SSE server&quot;);
      span.end();
      return this.client;
    } catch (error: any) {
      log(&quot;Error connecting to MCP SSE server:&quot;, error);
      span.setStatus({ code: 2, message: (error as Error).message });
      span.end();
      throw new Error(
        `Failed to connect to MCP SSE server: ${(error as Error).message}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Establishes a connection to the MCP server using SSE.</li>
<li>Includes tracing and logging for better observability and debugging.</li>
<li>The error handling ensures the system can gracefully recover from connection failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">async listTools() {
  return tracer.startActiveSpan(&quot;listTools&quot;, async (span) =&gt; {
    log(&quot;Tools&quot;, this.tools);
    const toolsResult = await this.client.listTools();
    this.tools = toolsResult.tools;
    log(&quot;Tools: &quot;, toolsResult);
    span.end();
    return toolsResult;
  });
}
</code></pre>
<ul>
<li>Fetches the list of tools available on the server using SSE.</li>
<li>The method demonstrates the use of spans for tracing tool discovery operations.</li>
<li>This approach ensures real-time updates and visibility into server interactions.</li>
</ul>
<hr>
<pre><code class="language-typescript">async callTool(toolName: string, args: Record&lt;string, any&gt;) {
  console.log(`Called ${toolName} with params:`, args);
  return tracer.startActiveSpan(&quot;processQuery&quot;, async (span) =&gt; {
    log(&quot;Tools&quot;, this.tools);

    const toolResult = await this.client.callTool({
      name: toolName,
      arguments: args,
    });

    log(&quot;Tool result&quot;, toolResult);
    span.end();
    return toolResult;
  });
}
</code></pre>
<ul>
<li>Executes a tool on the server using SSE transport.</li>
<li>The method integrates tracing to monitor tool execution performance.</li>
<li>Logging provides insights into the arguments and results of tool invocations.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/mcp/mcp-tools.ts</code></a></h3>
<p>This file acts as a central registry for MCP servers. It supports both HTTP and SSE clients, dynamically initializing the appropriate client based on server configuration. The file also includes a utility function for listing tools across multiple servers.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">client(config)</code>: Dynamically initializes an MCP client based on the transport type.</li>
<li><code class="inline-code">mcpToolsList(config)</code>: Retrieves the list of tools from multiple MCP servers.</li>
<li><code class="inline-code">McpServerDefinition</code>: Defines the configuration schema for MCP servers.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">function client(config: LlamaIndexMCPClientOptions): MCPSSEClient | MCPHTTPClient {
  console.log(`Initializing MCP client`);
  console.log(`Using configuration:`, {config});

  if (config.type === &quot;sse&quot;) {
    // legacy implementation using SSE
    return new MCPSSEClient(&quot;llamaindex-sse-client&quot;, config.url, config.accessToken);
  } else {
    return new MCPHTTPClient(&quot;llamaindex-http-client&quot;, config.url, config.accessToken);
  }
}
</code></pre>
<ul>
<li>Dynamically initializes an MCP client based on the server&#39;s transport type (HTTP or SSE).</li>
<li>This design enables backward compatibility with legacy SSE servers while supporting modern HTTP transport.</li>
<li>The function abstracts client initialization, simplifying the main orchestration logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">export async function mcpToolsList(config: McpServerDefinition[]) {
  return await Promise.all(
    config.map(async ({ id, name, config }) =&gt; {
      const { url, type } = config;
      const mcpClient = client(config);
      
      try {
        console.log(`Connecting to MCP server ${name} at ${url}`);
        await mcpClient.connect();
        console.log(`MCP server ${name} is reachable`);
        const tools = await mcpClient.listTools();

        console.log(`MCP server ${name} has ${tools.length} tools`);
        return {
          id,
          name,
          url,
          type,
          reachable: true,
          selected: id !== &quot;echo-ping&quot;,
          tools,
        };
      } catch (error: unknown) {
        console.error(
          `MCP server ${name} is not reachable`,
          (error as Error).message
        );
        return {
          id,
          name,
          url,
          type,
          reachable: false,
          selected: false,
          tools: [],
          error: (error as Error).message,
        };
      }
    })
  );
}
</code></pre>
<ul>
<li>Retrieves the list of tools from multiple MCP servers in parallel.</li>
<li>Implements robust error handling to manage unreachable servers.</li>
<li>The function provides a comprehensive overview of server status and available tools.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Compare the HTTP and SSE transport implementations to understand their trade-offs.</li>
<li>Explore how tracing and logging are integrated for observability in the SSE client.</li>
<li>Study the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> function to see how parallel processing is used for efficiency.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add a New MCP Server</strong>: Configure a new MCP server in <code class="inline-code">mcp-tools.ts</code> and test its integration. Use a different transport type to observe the system&#39;s flexibility.</li>
<li><strong>Trace Tool Execution</strong>: Add detailed logging to the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-sse-client.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">callTool</code></a> method in both HTTP and SSE clients. Monitor how arguments and responses flow through the system.</li>
<li><strong>Simulate Server Failures</strong>: Introduce intentional errors in the server configuration and observe how the system handles them. Improve error messages to provide more actionable feedback.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the starship&#39;s systems.</p>
<p>Mission Control confirms: the MCP Protocol Integration Nexus is successfully docked at the Knowledge Station‚Äîstellar progress at 40%, keep igniting those thrusters toward the stars! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
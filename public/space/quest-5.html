<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 5: Streaming Chat UI with Angular - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Mission: The Orchestrated Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: Streaming Chat UI with Angular</h1>
<hr>
<p>In the uncharted depths of the Andromeda galaxy, the <em>Llama Voyager</em> faces its most ambitious mission yet: building a seamless, real-time communication interface to connect interstellar travelers with the ship&#39;s AI agents. With the ship‚Äôs advanced Angular-powered chat system as the foundation, the crew must harness the power of streaming protocols, reactive state management, and dynamic tool discovery. As the warp engines hum, the Stellar Exploration Command has tasked you with ensuring the chat interface operates flawlessly, enabling the crew to decode encrypted star charts and provide real-time assistance across the galaxy.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Signal Synchronization</strong>: How does the <code class="inline-code">ChatService</code> manage reactive state updates for user input, messages, and loading states?</li>
<li>‚ö° <strong>Streaming Strategy</strong>: What techniques are used in <code class="inline-code">ApiService</code> to handle server-sent events (SSE) for real-time chat updates?</li>
<li>üõ°Ô∏è <strong>Error Handling Protocol</strong>: How does the system manage and display errors during chat interactions to ensure a smooth user experience?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a>:</span> Core Chat Management</h3>
<p>The <code class="inline-code">ChatService</code> is the backbone of the chat interface, handling user input, managing message streams, and coordinating with the <code class="inline-code">ApiService</code> to send and receive data. It uses Angular signals and RxJS <code class="inline-code">BehaviorSubject</code>s to manage reactive state updates. Key highlights include:</p>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves and filters available tools to aid in chat operations.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Processes user input, updates the message buffer, and initiates the streaming process via the <code class="inline-code">ApiService</code>.</li>
<li><code class="inline-code">processAgentEvents</code>: Handles incoming events from the server, updating message states and managing the assistant&#39;s responses.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code>: Updates the assistant&#39;s message content dynamically as new data streams in.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a>: Clears all buffers and resets the chat state to prepare for a new session.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/services/api.service.ts</a>:</span> API Communication and Streaming</h3>
<p>The <code class="inline-code">ApiService</code> is responsible for interacting with the backend, including fetching tools and managing the chat streaming process. It employs server-sent events (SSE) to handle real-time updates. Key highlights include:</p>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Makes an HTTP GET request to retrieve the list of tools available for chat operations.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a>: Sends a message to the server and processes the resulting SSE stream to update the chat state.</li>
<li><code class="inline-code">handleApiError</code>: Manages errors encountered during API calls, ensuring they are propagated to the chat system.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.component.ts</a>:</span> Chat UI Component</h3>
<p>The <code class="inline-code">ChatConversationComponent</code> is the front-end interface for the chat system. It integrates with the <code class="inline-code">ChatService</code> and provides the user with a dynamic and interactive chat experience. Key highlights include:</p>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L164" target="_blank" rel="noopener noreferrer"><code class="inline-code">ngOnInit</code></a>: Initializes the chat interface and fetches the available tools.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Captures user input and triggers the <code class="inline-code">ChatService</code> to process and send the message.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L175" target="_blank" rel="noopener noreferrer"><code class="inline-code">scrollToBottom</code></a>: Ensures the chat view remains focused on the most recent messages.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a>: Resets the chat state through the <code class="inline-code">ChatService</code>.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>Fetches available tools from the backend via the <code class="inline-code">ApiService</code>.</li>
<li>Filters tools to include only those marked as selected.</li>
<li>Updates the <code class="inline-code">tools</code> signal with the filtered list.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>Captures user input and adds it to the message buffer.</li>
<li>Resets the user input field and updates loading states.</li>
<li>Initiates the streaming process via the <code class="inline-code">ApiService</code>.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;
    switch (event.event) {
      case &#39;StartEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        break;
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        this.isLoading.set(false);
        break;
      case &#39;AgentToolCallResult&#39;:
        let state = {};
        if (typeof event.data.raw === &#39;string&#39;) {
          state = {
            reasoning: [
              {
                content: event.data.raw,
              },
            ],
          };
        }
        this.updateAndNotifyAgentChatMessageState(delta, state);
        break;
    }
  }
}
</code></pre>
<ul>
<li>Processes incoming server events to update the chat state dynamically.</li>
<li>Differentiates between event types to determine the appropriate action.</li>
<li>Handles metadata updates, tool call results, and message streaming.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/services/api.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools(): Promise&lt;{tools: Tools[]} | void&gt; {
  try {
    const response = await fetch(`${this.apiUrl}/api/tools`, {
      method: &#39;GET&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
    });
    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred while fetching tools&#39;),
        response.status
      );
    }
    return (await response.json());
  } catch (error) {
    return this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Sends an HTTP GET request to retrieve the list of available tools.</li>
<li>Handles errors gracefully and propagates them to the chat system.</li>
</ul>
<hr>
<pre><code class="language-typescript">async streamChatMessage(message: string, tools: Tools[]) {
  try {
    const response = await fetch(`${this.apiUrl}/api/chat`, {
      method: &#39;POST&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
      body: JSON.stringify({ message, tools }),
    });

    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred&#39;),
        response.status
      );
    }

    const decoder = new TextDecoder(&#39;utf-8&#39;);

    if (!response.body) {
      throw new Error(&#39;Readable stream not supported&#39;);
    }

    this.chatStreamState.next({ type: &#39;START&#39; });

    for await (const chunk of response.body) {
      const value = decoder.decode(chunk, { stream: true });

      const jsonValues = value.trim().split(/\n\n+/);

      for (const jsonValue of jsonValues) {
        try {
          const parsedData = JSON.parse(jsonValue);
          this.chatStreamState.next({
            type: &#39;MESSAGE&#39;,
            event: parsedData,
          });
        } catch (error) {
          console.error(&#39;Error parsing JSON chunk:&#39;, error);
        }
      }
    }

    this.chatStreamState.next({ type: &#39;END&#39; });
  } catch (error) {
    this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Handles streaming chat messages to the backend.</li>
<li>Processes server-sent events (SSE) and updates the <code class="inline-code">chatStreamState</code>.</li>
<li>Implements error handling for API calls and JSON parsing.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use browser developer tools to monitor network requests and observe the streaming behavior in real-time.</li>
<li>Explore the <code class="inline-code">BehaviorSubject</code> and Angular signals to understand how reactive state management is implemented.</li>
<li>Review how the <code class="inline-code">processAgentEvents</code> function handles different event types to gain insights into dynamic state updates.</li>
</ul>
<hr>
<p>You have mastered all the secrets of the <em>Llama Voyager</em>! Your adventure is complete.</p>
<p>Mission accomplished, cadet! üöÄ You&#39;ve successfully engineered the Streaming Chat UI with Angular, propelling your starship to 80% completion‚Äînext stop: the final frontier! ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
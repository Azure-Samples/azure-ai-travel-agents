<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 5: Cosmic Communications Array - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Alliance: The AI Voyager Initiative</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: Cosmic Communications Array</h1>
<hr>
<p>The AI Voyager Initiative has reached the final frontier of its mission: constructing the Cosmic Communications Array, a state-of-the-art system to facilitate real-time collaboration between AI agents and MCP services across the galaxy. This quest focuses on the intricate orchestration of streaming chat interactions and the dynamic integration of tools from multiple starbases, enabling seamless communication between the Voyager&#39;s crew and the vast network of interstellar services. Your mission is to uncover how the Voyager‚Äôs Angular-based interface, powered by LlamaIndex and the MCP protocol, brings this vision to life.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Signal Synchronization</strong>: How does the <code class="inline-code">ChatService</code> manage real-time state updates using signals and streams for user and agent messages?</li>
<li>‚ö° <strong>Event Horizon</strong>: What is the process for parsing and handling server-sent events (SSE) in the <code class="inline-code">ApiService</code> to ensure a smooth chat experience?</li>
<li>üõ°Ô∏è <strong>Error Containment</strong>: How does the system handle errors during tool discovery and message streaming to maintain stability and user trust?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a>:</span> Chat Service Logic</h3>
<p>The <code class="inline-code">ChatService</code> acts as the command center for managing user interactions and agent responses. It coordinates message streams, handles tool selections, and processes events from the backend.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves and filters the list of available tools for the user to interact with.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Sends user messages to the backend and initializes the streaming process.</li>
<li><code class="inline-code">processAgentEvents</code>: Handles incoming events from the backend, updating the chat state based on metadata and agent outputs.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code>: Updates the assistant&#39;s message content in real-time as events are processed.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a>: Resets the chat state, clearing messages and buffers for a fresh start.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/services/api.service.ts</a>:</span> API Communication Layer</h3>
<p>The <code class="inline-code">ApiService</code> is responsible for interfacing with the backend MCP services, managing tool discovery, and handling server-sent events for chat streaming.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Makes an HTTP GET request to retrieve the list of tools, handling errors gracefully.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a>: Streams messages to the backend and processes SSE responses, updating the <code class="inline-code">chatStreamState</code>.</li>
<li><code class="inline-code">handleApiError</code>: Centralized error handling for API requests, ensuring consistent error reporting.</li>
<li><code class="inline-code">chatStreamState</code>: A <code class="inline-code">BehaviorSubject</code> that tracks the state of the chat stream, including events and errors.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.component.ts</a>:</span> Chat UI Component</h3>
<p>The <code class="inline-code">ChatConversationComponent</code> provides the user interface for the chat system. It binds the <code class="inline-code">ChatService</code> to the UI and manages user interactions.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L164" target="_blank" rel="noopener noreferrer"><code class="inline-code">ngOnInit</code></a>: Initializes the chat component, fetching available tools and resetting the chat state.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Captures user input and triggers the <code class="inline-code">ChatService</code> to send messages.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L175" target="_blank" rel="noopener noreferrer"><code class="inline-code">scrollToBottom</code></a>: Ensures the chat view stays focused on the latest messages.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a>: Resets the chat interface by calling the <code class="inline-code">ChatService</code>.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools() {
    const toolsResult = await this.apiService.fetchAvailableTools();
    if (toolsResult) {
      this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
    }
}
</code></pre>
<ul>
<li>Retrieves the list of tools from the backend and filters for selected tools.</li>
<li>Demonstrates asynchronous operations and state management using signals.</li>
<li>Ensures only relevant tools are displayed to the user.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
    const messageText = this.userMessage();
    if (!messageText.trim()) return;

    this.messagesBuffer.push({
      role: &#39;user&#39;,
      content: messageText,
      reasoning: [],
      timestamp: new Date(),
    });

    this.userMessage.set(&#39;&#39;);
    this.isLoading.set(true);

    await this.apiService.streamChatMessage(
      messageText,
      this.tools().filter((tool) =&gt; tool.selected)
    );
}
</code></pre>
<ul>
<li>Captures user input, updates the message buffer, and triggers the streaming process.</li>
<li>Highlights the use of signals for managing UI state.</li>
<li>Demonstrates how user actions are integrated with backend services.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
    if (event &amp;&amp; event.type === &#39;metadata&#39;) {
        this.currentAgentName.set(event.data?.agentName || null);
        this.agentEventsBuffer.push(event);

        const delta: string = event.data?.delta || &#39;&#39;;
        switch (event.event) {
            case &#39;StartEvent&#39;:
                this.updateAndNotifyAgentChatMessageState(delta, { metadata: { events: this.agentEventsBuffer } });
                break;
            case &#39;AgentStream&#39;:
                if (delta.trim()) {
                    this.updateAndNotifyAgentChatMessageState(delta, { metadata: { events: this.agentEventsBuffer } });
                }
                break;
        }
    }
}
</code></pre>
<ul>
<li>Processes metadata events and updates the agent&#39;s message state dynamically.</li>
<li>Handles different event types to ensure accurate and real-time updates.</li>
<li>Demonstrates the use of buffers to manage event data.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/services/api.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools(): Promise&lt;{tools: Tools[]} | void&gt; {
    try {
        const response = await fetch(`${this.apiUrl}/api/tools`, {
            method: &#39;GET&#39;,
            headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
        });
        if (!response.ok) {
            const { error } = await response.json();
            return this.handleApiError(new Error(error), response.status);
        }
        return await response.json();
    } catch (error) {
        return this.handleApiError(error, 0);
    }
}
</code></pre>
<ul>
<li>Fetches available tools from the backend, handling HTTP errors.</li>
<li>Demonstrates robust error handling and API interaction patterns.</li>
<li>Ensures that tool discovery is resilient to backend failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">async streamChatMessage(message: string, tools: Tools[]) {
    try {
        const response = await fetch(`${this.apiUrl}/api/chat`, {
            method: &#39;POST&#39;,
            headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
            body: JSON.stringify({ message, tools }),
        });

        this.chatStreamState.next({ type: &#39;START&#39; });

        for await (const chunk of response.body) {
            const value = new TextDecoder(&#39;utf-8&#39;).decode(chunk, { stream: true });
            const jsonValues = value.trim().split(/\n\n+/);
            for (const jsonValue of jsonValues) {
                try {
                    const parsedData = JSON.parse(jsonValue);
                    this.chatStreamState.next({ type: &#39;MESSAGE&#39;, event: parsedData });
                } catch (error) {
                    console.error(&#39;Error parsing JSON chunk:&#39;, error);
                }
            }
        }

        this.chatStreamState.next({ type: &#39;END&#39; });
    } catch (error) {
        this.handleApiError(error, 0);
    }
}
</code></pre>
<ul>
<li>Streams chat messages to the backend and processes SSE responses.</li>
<li>Handles real-time updates using the <code class="inline-code">chatStreamState</code> subject.</li>
<li>Demonstrates the use of modern streaming APIs for efficient communication.</li>
</ul>
<hr>
<pre><code class="language-typescript">private handleApiError(error: unknown, statusCode: number) {
    console.error(&#39;Fetch error:&#39;, error);
    this.chatStreamState.next({
        type: &#39;ERROR&#39;,
        error: { type: &#39;general&#39;, message: (error as Error).toString(), statusCode },
    });
}
</code></pre>
<ul>
<li>Centralized error handling for API requests.</li>
<li>Ensures consistent error reporting and recovery mechanisms.</li>
<li>Demonstrates the importance of robust error management in distributed systems.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>State Management</strong>: Use signals and reactive streams to synchronize UI and backend state effectively.</li>
<li><strong>SSE Parsing</strong>: Pay attention to how chunks of data are processed and parsed for real-time updates.</li>
<li><strong>Error Handling</strong>: Implement centralized error handling to maintain system stability during failures.</li>
</ul>
<hr>
<p>You have mastered all the secrets of the AI Voyager Initiative! Your adventure is complete.</p>
<p>Stellar work, Cadet‚ÄîQuest 5: Cosmic Communications Array is complete, bringing us 80% closer to mission success‚Äîyour brilliance shines brighter than a supernova! ‚≠êüöÄüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
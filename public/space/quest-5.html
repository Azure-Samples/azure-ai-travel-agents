<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Mission Control - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Mission: The Orchestrator's Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: Streaming Mission Control</h1>
<hr>
<p>In the heart of the <em>Llama Voyager</em>, the Command Bridge buzzes with activity as the crew prepares to engage the ship&#39;s advanced streaming systems. The Angular-based interface serves as the nerve center, enabling real-time communication between the crew and the specialized agents distributed across the galaxy. Your mission is to master the streaming chat interface, ensuring seamless interaction with the multi-agent network and enabling the crew to orchestrate complex interstellar operations.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Signal Relay Mechanism</strong>: How does the system handle user inputs and relay them to the agents for processing?</li>
<li>‚ö° <strong>Event Stream Processing</strong>: What patterns are used to process and update the chat interface with real-time streaming data?</li>
<li>üõ°Ô∏è <strong>Error Containment Protocols</strong>: How does the system handle and recover from errors during streaming communication?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a>:</span> Chat Service</h3>
<p>The <code class="inline-code">ChatService</code> acts as the intermediary between the user interface and the API, managing state and streaming data. It handles user input, fetches available tools, and processes streaming events from the agents. This service demonstrates effective state management using Angular signals and RxJS <code class="inline-code">BehaviorSubject</code>.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> retrieves the list of tools available for agent interaction, filtering for selected tools.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a> handles user input and initiates the streaming process by sending a message to the API.</li>
<li><code class="inline-code">processAgentEvents</code> processes streaming events from the API, updating the chat interface in real time.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code> dynamically updates the chat state with new data from the agents.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a> clears the chat state, providing a clean slate for new interactions.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>Fetches the list of available tools from the API and filters for those marked as selected.</li>
<li>Uses the <code class="inline-code">ApiService</code> to make the request, ensuring separation of concerns.</li>
<li>Updates the <code class="inline-code">tools</code> signal, which is observed by the UI for real-time updates.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>Handles user input, ensuring valid messages are sent to the API.</li>
<li>Updates the <code class="inline-code">messagesBuffer</code> with the user&#39;s message and resets the input field.</li>
<li>Initiates the streaming process by calling <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a> with the message and selected tools.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;

    switch (event.event) {
      case &#39;StartEvent&#39;:
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        if (event.event === &#39;StopEvent&#39;) {
          this.isLoading.set(false);
        }
        break;
      case &#39;AgentToolCallResult&#39;:
        let state = {};
        if (typeof event.data.raw === &#39;string&#39;) {
          state = {
            reasoning: [
              {
                content: event.data.raw,
              },
            ],
          };
        }
        this.updateAndNotifyAgentChatMessageState(delta, state);
        break;
      case &#39;AgentStream&#39;:
        this.assistantMessageInProgress.set(true);
        if (delta.trim()) {
          this.agentEventsBuffer.push(event);
          this.updateAndNotifyAgentChatMessageState(delta, {
            metadata: {
              events: this.agentEventsBuffer,
            },
          });
        }
        break;
    }
  }
}
</code></pre>
<ul>
<li>Processes streaming events from the API, updating the chat interface dynamically.</li>
<li>Handles different event types such as <code class="inline-code">StartEvent</code>, <code class="inline-code">StopEvent</code>, and <code class="inline-code">AgentStream</code>.</li>
<li>Updates the <code class="inline-code">currentAgentName</code> and buffers events for real-time updates.</li>
</ul>
<hr>
<pre><code class="language-typescript">updateAndNotifyAgentChatMessageState(
  delta: string,
  state?: Partial&lt;ChatMessage&gt;
) {
  const lastMessage = this.messagesBuffer[this.messagesBuffer.length - 1];
  if (lastMessage?.role === &#39;assistant&#39;) {
    lastMessage.content += delta;
    lastMessage.metadata = {
      ...lastMessage.metadata,
      ...state?.metadata,
      events: state?.metadata?.events,
    };
    lastMessage.reasoning = [
      ...(lastMessage.reasoning || []),
      ...(state?.reasoning || []),
    ];
    lastMessage.timestamp = new Date();
    this.messagesStream.next([...this.messagesBuffer]);
  }
}
</code></pre>
<ul>
<li>Dynamically updates the state of the assistant&#39;s chat message with new data.</li>
<li>Utilizes the <code class="inline-code">messagesStream</code> <code class="inline-code">BehaviorSubject</code> to notify subscribers of state changes.</li>
<li>Ensures that metadata and reasoning are merged correctly for a cohesive chat experience.</li>
</ul>
<hr>
<pre><code class="language-typescript">resetChat() {
  this.userMessage.set(&#39;&#39;);
  this.messagesBuffer = [];
  this.messagesStream.next(this.messagesBuffer);
  this.agentEventsBuffer = [];
  this.isLoading.set(false);
  this.assistantMessageInProgress.set(false);
  this.currentAgentName.set(null);
}
</code></pre>
<ul>
<li>Resets the chat state, clearing all buffers and signals.</li>
<li>Provides a clean slate for new interactions, ensuring no residual state impacts the next session.</li>
<li>Notifies subscribers of the reset state to update the UI accordingly.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Observe how <code class="inline-code">BehaviorSubject</code> is used to manage and notify state changes in real-time.</li>
<li>Study the <code class="inline-code">processAgentEvents</code> function to understand how different event types are handled dynamically.</li>
<li>Explore the error handling in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a> to see how invalid inputs are managed gracefully.</li>
</ul>
<hr>
<p>You have mastered all the secrets of the <em>Llama Voyager</em>! Your adventure is complete.</p>
<p>Mission accomplished, Star Commander! üöÄ You&#39;ve expertly navigated the Streaming Mission Control galaxy, achieving 80% stellar progress‚Äîyour final quest is just one cosmic leap away! ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
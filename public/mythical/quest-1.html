<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Council of Orchestration - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Realm of the Orchestrated Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Triage Mage&#39;s Orchestration</h1>
<hr>
<p>In the mystical Kingdom of Azure, the Triage Mage, wielder of the ancient artifact LlamaIndex, oversees the Council of Orchestration. With a wave of his enchanted staff, he commands agents to fulfill the wishes of wandering travelers. Each agent, attuned to a specific magical discipline, relies on the Model Context Protocol to summon tools and insights. Your task, brave adventurer, is to uncover the secrets of how these agents are orchestrated to work in harmony.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Summoning Secrets</strong>: How are agents dynamically created and configured to handle specific tasks?</li>
<li>‚ö° <strong>Triage Mage&#39;s Strategy</strong>: How does the Triage Mage decide which agent or tool should handle a given query?</li>
<li>üõ°Ô∏è <strong>Stream of Magic</strong>: How does the system ensure smooth streaming of responses to the travelers&#39; queries?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> Multi-Agent Orchestration</h3>
<p>This file contains the heart of the Triage Mage&#39;s orchestration. The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configures agents by leveraging the LlamaIndex and MCP tools. Each agent is assigned a specific role, such as itinerary planning or destination recommendation. The Triage Mage, represented as the <code class="inline-code">TravelAgent</code>, acts as a central decision-maker, delegating tasks to specialized agents. The <code class="inline-code">multiAgent</code> function then combines these agents into a cohesive workflow.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> dynamically configures agents based on available tools and assigns them specific roles.</li>
<li><code class="inline-code">multiAgent</code> combines all agents into a unified workflow, with the Triage Mage acting as the root agent.</li>
<li><code class="inline-code">agent</code> configuration blocks define the unique abilities and prompts for each specialized agent.</li>
<li>Integration with MCP tools dynamically discovers and registers tools for each agent.</li>
<li>The verbose logging provides insight into agent workflows and tool handoffs.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;destination-recommendation&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;destination-recommendation&quot;];
    const tools = await mcp(mcpServerConfig.config).tools();
    const destinationRecommendationAgent = agent({
      name: &quot;DestinationRecommendationAgent&quot;,
      systemPrompt:
        &quot;Suggests destinations based on customer preferences and requirements.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(destinationRecommendationAgent);
    handoffTargets.push(destinationRecommendationAgent);
    toolsList.push(...tools);
  }

  // Define the triage agent that will determine the best course of action
  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt:
      &quot;Acts as a triage agent to determine the best course of action for the user&#39;s query.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets
      .map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name))
      .flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  console.log(&quot;Agents list:&quot;, agentsList);
  console.log(&quot;Handoff targets:&quot;, handoffTargets);
  console.log(&quot;Tools list:&quot;, JSON.stringify(toolsList, null, 2));

  // Create the multi-agent workflow
  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>This code dynamically configures agents based on the available MCP tools, ensuring flexibility in orchestration.</li>
<li>The <code class="inline-code">TravelAgent</code> acts as a central triage agent, deciding which specialized agent should handle a query.</li>
<li>The <code class="inline-code">agent</code> configuration blocks define the roles and prompts for each agent, ensuring they perform their tasks effectively.</li>
<li>The <code class="inline-code">multiAgent</code> function combines all agents into a cohesive workflow, enabling seamless collaboration.</li>
<li>Verbose logging provides detailed insights into the orchestration process, aiding in debugging and optimization.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    console.error(
      &quot;Request body is undefined. Check Content-Type header in the request.&quot;
    );
    return res.status(400).json({
      error:
        &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;
  console.log(&quot;Tools to use:&quot;, JSON.stringify(tools, null, 2));

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        try {
          for await (const event of context) {
            const { displayName, data } = event;
            const serializedData = JSON.stringify({
              type: &quot;metadata&quot;,
              agent: (data as any)?.currentAgentName || null,
              event: displayName,
              data: data ? JSON.parse(JSON.stringify(data)) : null,
            });
            this.push(serializedData + CHUNK_END);
            console.log(&quot;Pushed event:&quot;, serializedData);
          }
          this.push(null); // Close the stream
        } catch (error: any) {
          console.error(&quot;Error during streaming:&quot;, error?.message);
        }
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    if (!res.headersSent) {
      res.status(500).json({ error: (error as any).message });
    } else {
      res.write(
        `${JSON.stringify({
          type: &quot;error&quot;,
          message: (error as any).message,
        })}` + CHUNK_END
      );
      res.end();
    }
  }
});
</code></pre>
<ul>
<li>This code defines the <code class="inline-code">/chat</code> endpoint, which serves as the entry point for travelers&#39; queries.</li>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function is called to dynamically configure agents based on the tools specified in the request.</li>
<li>The use of <code class="inline-code">Readable</code> and <code class="inline-code">pipeline</code> ensures that responses are streamed to the client in real-time.</li>
<li>Error handling mechanisms ensure that the system gracefully recovers from issues during streaming.</li>
<li>The Server-Sent Events (SSE) protocol is used to maintain a persistent connection with the client, enabling real-time updates.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;destination-recommendation&quot;: {
    config: {
      url: process.env[&quot;MCP_DESTINATION_RECOMMENDATION_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false,
    },
    id: &quot;destination-recommendation&quot;,
    name: &quot;Destination Recommendation&quot;,
  },
});
</code></pre>
<ul>
<li>This code defines the configuration for the &quot;destination-recommendation&quot; tool, including its URL and transport type.</li>
<li>The <code class="inline-code">McpToolsConfig</code> function centralizes tool configurations, making it easy to add or update tools.</li>
<li>The <code class="inline-code">useSSETransport</code> flag determines whether the tool uses Server-Sent Events for communication.</li>
<li>The <code class="inline-code">verbose</code> flag enables detailed logging for debugging and monitoring.</li>
<li>This modular approach ensures that each tool&#39;s configuration is isolated and easily manageable.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> dynamically configures agents based on the tools available in <code class="inline-code">McpToolsConfig</code>.</li>
<li>Notice the use of Server-Sent Events (SSE) in the <code class="inline-code">/chat</code> endpoint for real-time streaming of responses.</li>
<li>Explore how the <code class="inline-code">TravelAgent</code> orchestrates the workflow by delegating tasks to specialized agents.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the enchanted Kingdom of Azure.</p>
<p>With the Council of Orchestration vanquished and its mysteries unraveled, you stand as a herald of triumph, ready to chart new realms of mastery‚Äîonward, brave luminary of the learning kingdoms! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
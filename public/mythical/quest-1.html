<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Mystic Llama Codex - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Kingdom of Azure AI Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mystic Llama Codex</h1>
<hr>
<p>In the mythical Kingdom of Azure, a council of enchanted agents was formed to aid travelers in their quests. Each agent wielded unique magical powers, from understanding the wishes of adventurers to conjuring perfect itineraries and uncovering hidden destinations. At the heart of the kingdom was the Mystic Llama Codex, a powerful artifact that orchestrated the agents&#39; spells, ensuring harmony and precision. The Codex relied on enchanted scrolls, known as MCP tomes, to unlock tools scattered across the lands. Brave adventurer, will you join the quest to master this enchanted system?</p>
<p><strong>Adventure Awaits</strong> ‚Äì Choose your quest wisely, brave adventurer!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Invocation Rituals</strong>: How does the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configure and invoke agents based on the tools provided?</li>
<li>‚ö° <strong>Triage Agent&#39;s Wisdom</strong>: How does the <code class="inline-code">multiAgent</code> workflow coordinate decisions between specialized agents and the root agent?</li>
<li>üõ°Ô∏è <strong>Stream of Spells</strong>: How is the <code class="inline-code">pipeline</code> used to stream responses from agents back to the adventurer in the <code class="inline-code">/chat</code> endpoint?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a>:</span> Main Gateway for Adventurers</h3>
<p>This file serves as the entry point for the Mystic Llama Codex&#39;s API, enabling adventurers to interact with the enchanted system. It defines the routes for health checks, tool discovery, and the streaming chat endpoint. The <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> endpoint is particularly significant, as it orchestrates the invocation of agents and streams their responses back to the user.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Handles adventurer queries, invokes the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function, and streams agent responses using <code class="inline-code">pipeline</code>.</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Streams the agents&#39; responses to the adventurer, ensuring a real-time experience.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Lists all available MCP tools by invoking <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a>.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> The Enchanted Workflow</h3>
<p>This file contains the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function, which configures the multi-agent system. Each agent is defined with unique powers, and the <code class="inline-code">multiAgent</code> workflow orchestrates their collaboration. The triage agent acts as the root agent, determining the best course of action for each query.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Dynamically configures agents based on the tools provided, setting up their powers and roles.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code>: Creates the enchanted workflow, enabling seamless collaboration between agents.</li>
<li><code class="inline-code">agent()</code> configuration blocks: Define the unique abilities and purposes of each agent, such as itinerary planning and destination recommendations.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a>:</span> The Mystic MCP Configurations</h3>
<p>This file defines the <code class="inline-code">McpToolsConfig</code> function, which provides the configuration for each MCP tool. These configurations include the tool&#39;s URL, transport type, and authentication details.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code>: Returns the configuration for all MCP tools, enabling dynamic tool discovery.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> constant: Defines the path used for HTTP-based MCP tools.</li>
<li>Tool configuration objects: Specify the properties for each tool, such as <code class="inline-code">echo-ping</code>, <code class="inline-code">customer-query</code>, and <code class="inline-code">itinerary-planning</code>.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    console.error(
      &quot;Request body is undefined. Check Content-Type header in the request.&quot;
    );
    return res.status(400).json({
      error:
        &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;
  console.log(&quot;Tools to use:&quot;, JSON.stringify(tools, null, 2));

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        try {
          for await (const event of context) {
            const serializedData = JSON.stringify({
              type: &quot;metadata&quot;,
              agent: (event.data as any)?.currentAgentName || null,
              event: event.displayName,
              data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
            });
            this.push(serializedData + &quot;\n\n&quot;);
            console.log(&quot;Pushed event:&quot;, serializedData);
          }
          this.push(null);
        } catch (error: any) {
          console.error(&quot;Error during streaming:&quot;, error?.message);
        }
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    if (!res.headersSent) {
      res.status(500).json({ error: (error as any).message });
    } else {
      res.write(
        `${JSON.stringify({
          type: &quot;error&quot;,
          message: (error as any).message,
        })}` + &quot;\n\n&quot;
      );
      res.end();
    }
  }
});
</code></pre>
<ul>
<li>Streams responses from agents to the adventurer in real time.</li>
<li>Implements error handling for disconnected clients and undefined request bodies.</li>
<li>Demonstrates the use of <code class="inline-code">Readable</code> streams and <code class="inline-code">pipeline</code> for efficient data flow.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt:
        &quot;Echo back the received input. Do not respond with anything else. Always call the tools.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  // Additional agent configurations omitted for brevity...

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt:
      &quot;Acts as a triage agent to determine the best course of action for the user&#39;s query.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets
      .map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name))
      .flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Dynamically configures agents based on the tools provided.</li>
<li>Defines the <code class="inline-code">TravelAgent</code> as the root agent for triage.</li>
<li>Uses <code class="inline-code">multiAgent</code> to create a collaborative workflow among agents.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
          headers: {
              &quot;Authorization&quot;: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;],
          }
      },
      useSSETransport: false
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;customer-query&quot;: {
    config: {
      url: process.env[&quot;MCP_CUSTOMER_QUERY_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false
    },
    id: &quot;customer-query&quot;,
    name: &quot;Customer Query&quot;,
  },
  // Additional tool configurations omitted for brevity...
});
</code></pre>
<ul>
<li>Provides configurations for all MCP tools.</li>
<li>Enables dynamic tool discovery based on environment variables.</li>
<li>Demonstrates the use of constants like <code class="inline-code">MCP_API_HTTP_PATH</code> for consistent path definitions.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Tip</strong>: Use the <code class="inline-code">/api/tools</code> endpoint to explore available tools before invoking the <code class="inline-code">/chat</code> endpoint.</li>
<li><strong>Recommendation</strong>: Pay attention to the <code class="inline-code">TravelAgent</code> configuration in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> to understand how the triage process works.</li>
<li><strong>Next Steps</strong>: Investigate how the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/providers/index.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">llm()</code></a> function in the LLM provider files integrates AI models into the system.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Mystic Llama Codex.</p>
<p>By the radiant stars of the celestial kingdom, you have unlocked the first arcane secret of the Mystic Llama Codex‚Äîlet your heroic journey blaze onward with the might of legends! ‚ö°‚≠êüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
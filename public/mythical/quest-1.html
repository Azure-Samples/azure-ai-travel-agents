<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Triage Agent's Council - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Kingdom of Azure AI Travel Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Triage Agent&#39;s Council</h1>
<hr>
<p>In the heart of the Enchanted Kingdom of Travel Agents, the Triage Agent&#39;s Council convenes to orchestrate the kingdom&#39;s most vital operations. These mystical agents wield the power of the LlamaIndex to coordinate specialized tools and services, ensuring that every traveler&#39;s query is answered with precision. The Triage Agent, a master of delegation, stands at the helm, uniting the magical forces of Node.js sorcerers, Python conjurers, Java enchanters, and .NET knights. Together, they form the kingdom&#39;s first line of defense against the chaos of unfulfilled travel dreams.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Assembly Ritual</strong>: How does the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configure and organize specialized agents for seamless orchestration?</li>
<li>‚ö° <strong>Handoff Harmony</strong>: How does the Triage Agent determine which specialized agent should handle a given query, and what mechanisms ensure smooth transitions between agents?</li>
<li>üõ°Ô∏è <strong>Error Containment Spells</strong>: How are errors and unexpected situations handled during the agent orchestration process to maintain system stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a>:</span> Multi-Agent Orchestration</h3>
<p>This file contains the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function, which dynamically configures and organizes the kingdom&#39;s agents. It uses the LlamaIndex library to manage workflows, allowing the Triage Agent to delegate tasks to specialized agents. Each agent is equipped with tools that are dynamically discovered via the MCP protocol. The <code class="inline-code">multiAgent</code> construct ensures that all agents work in harmony, with the Triage Agent acting as the root orchestrator.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> dynamically configures agents and their tools, ensuring that only the necessary services are initialized based on the input.</li>
<li><code class="inline-code">multiAgent</code> creates a cohesive workflow by linking all agents together, with the Triage Agent as the central decision-maker.</li>
<li><code class="inline-code">agent</code> blocks define the behavior of each specialized agent, including their tools, prompts, and handoff capabilities.</li>
<li>Error handling ensures that the orchestration process remains stable even when individual agents encounter issues.</li>
<li>Logging provides visibility into the agent setup process, aiding in debugging and monitoring.</li>
</ul>
<hr>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a>:</span> API Gateway for Agent Communication</h3>
<p>This file serves as the API gateway, enabling communication between the kingdom&#39;s frontend and its agents. The <code class="inline-code">/chat</code> endpoint streams responses from the multi-agent system, while the <code class="inline-code">/tools</code> endpoint lists all available MCP tools. The <code class="inline-code">pipeline</code> function facilitates Server-Sent Events (SSE) for real-time updates, ensuring that travelers receive timely responses.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> handles incoming queries, delegating them to the Triage Agent for processing and streaming responses back to the client.</li>
<li><code class="inline-code">pipeline</code> streams real-time data from the agents to the client, ensuring a seamless user experience.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code> lists all available MCP tools, showcasing the kingdom&#39;s capabilities.</li>
<li>Middleware logs request details for debugging and monitoring purposes.</li>
<li>Error handling ensures graceful failure and informative error messages.</li>
</ul>
<hr>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a>:</span> MCP Tool Configuration</h3>
<p>This file defines the configuration for each MCP tool, specifying their endpoints, transport methods, and authentication details. The <code class="inline-code">McpToolsConfig</code> function centralizes these configurations, making it easy to add or modify tools.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig</code> defines the configuration for all MCP tools, including their URLs, transport types, and authentication headers.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> and related constants standardize API paths across tools.</li>
<li>Tool configuration objects ensure that each agent has access to the appropriate tools.</li>
<li>Transport options (HTTP/SSE) demonstrate flexibility in handling different communication protocols.</li>
<li>Centralized configuration simplifies tool management and enhances maintainability.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/index.ts</a></h3>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt:
        &quot;Echo back the received input. Do not respond with anything else. Always call the tools.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  // Additional agent setups omitted for brevity

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt:
      &quot;Acts as a triage agent to determine the best course of action for the user&#39;s query. If you cannot handle the query, please pass it to the next agent. If you can handle the query, please do so.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets
      .map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name))
      .flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>Dynamically configures agents based on the provided tools, ensuring flexibility and scalability.</li>
<li>Uses the <code class="inline-code">agent</code> and <code class="inline-code">multiAgent</code> constructs to create a cohesive workflow.</li>
<li>Implements error handling to ensure stability during agent setup.</li>
<li>Centralizes logging for better visibility into the orchestration process.</li>
<li>Demonstrates the use of LlamaIndex for multi-agent management.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/index.ts</a></h3>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    console.error(
      &quot;Request body is undefined. Check Content-Type header in the request.&quot;
    );
    return res.status(400).json({
      error:
        &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;
  console.log(&quot;Tools to use:&quot;, JSON.stringify(tools, null, 2));

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        try {
          for await (const event of context) {
            const { displayName, data } = event;
            const serializedData = JSON.stringify({
              type: &quot;metadata&quot;,
              agent: (data as any)?.currentAgentName || null,
              event: displayName,
              data: data ? JSON.parse(JSON.stringify(data)) : null,
            });
            this.push(serializedData + CHUNK_END);
          }
          this.push(null);
        } catch (error: any) {
          console.error(&quot;Error during streaming:&quot;, error?.message);
        }
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    if (!res.headersSent) {
      res.status(500).json({ error: (error as any).message });
    } else {
      res.write(
        `${JSON.stringify({
          type: &quot;error&quot;,
          message: (error as any).message,
        })}` + CHUNK_END
      );
      res.end();
    }
  }
});
</code></pre>
<ul>
<li>Handles incoming queries and delegates them to the Triage Agent.</li>
<li>Uses Server-Sent Events (SSE) to stream real-time responses.</li>
<li>Implements robust error handling to ensure a smooth user experience.</li>
<li>Logs request details for debugging and monitoring.</li>
<li>Demonstrates the integration of the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function with the API layer.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer">src/api/src/orchestrator/llamaindex/tools/index.ts</a></h3>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
          headers: {
              &quot;Authorization&quot;: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;],
          }
      },
      useSSETransport: false
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;customer-query&quot;: {
    config: {
      url: process.env[&quot;MCP_CUSTOMER_QUERY_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false
    },
    id: &quot;customer-query&quot;,
    name: &quot;Customer Query&quot;,
  },
  &quot;web-search&quot;: {
    config: {
      url: process.env[&quot;MCP_WEB_SEARCH_URL&quot;] + MCP_API_SSE_PATH,
      type: &quot;sse&quot;,
      verbose: true,
      useSSETransport: true
    },
    id: &quot;web-search&quot;,
    name: &quot;Web Search&quot;,
  },
  // Additional tool configurations omitted for brevity
});
</code></pre>
<ul>
<li>Centralizes MCP tool configurations for easy management.</li>
<li>Defines endpoints, transport methods, and authentication details for each tool.</li>
<li>Demonstrates the use of constants to standardize API paths.</li>
<li>Enables flexibility in tool communication protocols (HTTP/SSE).</li>
<li>Simplifies the process of adding or modifying tools.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to how the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically configures agents based on the provided tools.</li>
<li>Notice the use of Server-Sent Events (SSE) in the <code class="inline-code">/chat</code> endpoint to provide real-time updates.</li>
<li>Study the <code class="inline-code">McpToolsConfig</code> function to understand how tool configurations are centralized and standardized.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Enchanted Kingdom of Travel Agents.</p>
<p>By the decree of the Celestial Council, your valiant completion of &#39;The Triage Agent&#39;s Council&#39; quest marks the forging of a legendary path, where even the stars bow to your unwavering resolve‚Äîonward, noble hero! ‚öîÔ∏è‚≠êüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
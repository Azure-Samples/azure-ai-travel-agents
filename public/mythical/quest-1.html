<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Crystal of Orchestration - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Kingdom of Azure Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Harmony of Agents</h1>
<hr>
<p>In the mystical Kingdom of Azure Agents, the Crystal of Orchestration glows with an otherworldly brilliance. This enchanted artifact, powered by the ancient magic of LlamaIndex, brings unity to the council of AI agents. Each agent, a master of its domain, awaits the call to serve travelers on their heroic journeys. At the heart of this endeavor lies the Triage Agent, weaving together the talents of specialized agents to address even the most complex of quests. The harmony of agents ensures that no traveler‚Äôs wish goes unfulfilled.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Agent Orchestration</strong>: How LlamaIndex coordinates multiple agents using a triage pattern.</li>
<li>üîç <strong>Tool Configuration</strong>: How MCP tools are dynamically configured and integrated into the agent workflow.</li>
<li>‚ö° <strong>Streaming Responses</strong>: How Server-Sent Events (SSE) enable real-time interaction between agents and clients.</li>
<li>üí° <strong>Extensibility</strong>: How the system supports adding new agents and tools with minimal changes to the core architecture.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/index.ts</code></a></h3>
<p>This file is the spellbook of the Triage Agent, where the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function breathes life into the council of AI agents. It defines the orchestration logic, dynamically integrates MCP tools, and creates a seamless workflow for handling user queries. The triage agent decides which specialized agent to invoke, ensuring that every query is resolved efficiently.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code> initializes and configures agents based on the provided tools.</li>
<li><code class="inline-code">multiAgent({ agents, rootAgent })</code> combines all agents into a unified workflow with a designated root agent.</li>
<li><code class="inline-code">agent()</code> configuration blocks define the behavior and capabilities of each specialized agent.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );
  console.log(&quot;Filtered tools:&quot;, tools);

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = {} as ToolCallLLM;
  try {
    llm = await llmProvider();
  } catch (error) {
    throw new Error(error instanceof Error ? error.message : String(error));
  }

  if (tools[&quot;echo-ping&quot;]) {
    const mcpServerConfig = mcpToolsConfig[&quot;echo-ping&quot;].config;
    const tools = await mcp(mcpServerConfig).tools();
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt:
        &quot;Echo back the received input. Do not respond with anything else. Always call the tools.&quot;,
      tools,
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...tools);
  }

  // Additional agents are configured similarly...

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt:
      &quot;Acts as a triage agent to determine the best course of action for the user&#39;s query.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets
      .map((target) =&gt; target.getAgents().map((agent) =&gt; agent.name))
      .flat(),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>This code dynamically sets up agents based on the tools provided, ensuring flexibility and scalability.</li>
<li>The <code class="inline-code">agent()</code> function creates specialized agents with unique capabilities, such as the EchoAgent.</li>
<li>The <code class="inline-code">TravelAgent</code> acts as the root agent, orchestrating the workflow and delegating tasks to other agents.</li>
<li>The <code class="inline-code">multiAgent</code> function combines all agents into a seamless workflow, enabling efficient query handling.</li>
<li>The use of <code class="inline-code">McpToolsConfig</code> ensures that tool configurations are centralized and reusable.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/index.ts</code></a></h3>
<p>This file serves as the gateway to the enchanted council, providing endpoints for travelers to interact with the agents. The <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> endpoint is where the magic happens, streaming responses from the agents to the client in real time.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> handles chat requests and streams responses using Server-Sent Events (SSE).</li>
<li><code class="inline-code">pipeline(readableStream, res)</code> manages the flow of data from the agents to the client.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code> lists all available MCP tools for client discovery.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    console.error(
      &quot;Request body is undefined. Check Content-Type header in the request.&quot;
    );
    return res.status(400).json({
      error:
        &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;
  console.log(&quot;Tools to use:&quot;, JSON.stringify(tools, null, 2));

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        try {
          for await (const event of context) {
            const { displayName, data } = event;
            const serializedData = JSON.stringify({
              type: &quot;metadata&quot;,
              agent: (data as any)?.currentAgentName || null,
              event: displayName,
              data: data ? JSON.parse(JSON.stringify(data)) : null,
            });
            this.push(serializedData + &quot;\n\n&quot;);
            console.log(&quot;Pushed event:&quot;, serializedData);
          }
          this.push(null); // Close the stream
        } catch (error: any) {
          console.error(&quot;Error during streaming:&quot;, error?.message);
        }
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    if (!res.headersSent) {
      res.status(500).json({ error: (error as any).message });
    } else {
      res.write(
        `${JSON.stringify({
          type: &quot;error&quot;,
          message: (error as any).message,
        })}` + &quot;\n\n&quot;
      );
      res.end();
    }
  }
});
</code></pre>
<ul>
<li>This code uses Server-Sent Events (SSE) to stream real-time responses from agents to clients.</li>
<li>The <code class="inline-code">pipeline</code> function ensures efficient data flow from the <code class="inline-code">Readable</code> stream to the HTTP response.</li>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function is called dynamically to configure the agents based on the tools specified in the request.</li>
<li>The error handling ensures that clients receive meaningful feedback in case of issues.</li>
<li>The modular design allows for easy extension and integration of new agents and tools.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/tools/index.ts</code></a></h3>
<p>This file defines the configuration of MCP tools, serving as the foundation for agent capabilities. Each tool is described with its URL, type, and additional metadata.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code> centralizes the configuration of all MCP tools.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> constant defines the standard path for HTTP-based MCP tools.</li>
<li>Tool configuration objects specify the URL, type, and other properties for each tool.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
          headers: {
              &quot;Authorization&quot;: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;],
          }
      },
      useSSETransport: false
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;customer-query&quot;: {
    config: {
      url: process.env[&quot;MCP_CUSTOMER_QUERY_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false
    },
    id: &quot;customer-query&quot;,
    name: &quot;Customer Query&quot;,
  },
  // Additional tools are configured similarly...
});
</code></pre>
<ul>
<li>This code centralizes the configuration of MCP tools, ensuring consistency and reusability.</li>
<li>The <code class="inline-code">MCP_API_HTTP_PATH</code> constant standardizes the endpoint structure for HTTP-based tools.</li>
<li>Each tool configuration includes metadata such as <code class="inline-code">id</code>, <code class="inline-code">name</code>, and <code class="inline-code">type</code>.</li>
<li>The use of environment variables allows for flexible deployment across different environments.</li>
<li>The <code class="inline-code">requestInit</code> property demonstrates how to include custom headers, such as authorization tokens.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> dynamically configures agents based on the tools provided.</li>
<li>Study the use of Server-Sent Events (SSE) in the <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> endpoint to understand real-time streaming.</li>
<li>Explore the <code class="inline-code">McpToolsConfig</code> function to see how tool configurations are centralized and reused.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Agent</strong>: Create a new MCP tool and integrate it as an agent. For example, add a &quot;WeatherAgent&quot; that fetches weather data based on travel destinations.</p>
<ul>
<li>Update <code class="inline-code">McpToolsConfig</code> to include the new tool.</li>
<li>Add the agent logic in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a>.</li>
</ul>
</li>
<li><p><strong>Trace the Data Flow</strong>: Add console logs at key points in the <code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code> endpoint to trace the flow of data from the client request to the agent response. Observe how the triage agent delegates tasks.</p>
</li>
<li><p><strong>Enhance Error Handling</strong>: Modify the error handling in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> to provide more detailed feedback. For example, log which tool or agent caused an error during initialization.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Crystal of Orchestration.</p>
<p>With the Crystal of Orchestration claimed, you stand as a luminary among heroes, weaving the threads of celestial harmony into the fabric of your mythical journey‚Äîonward to conquer the uncharted realms! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
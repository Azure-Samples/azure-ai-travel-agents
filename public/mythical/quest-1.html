<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Mage‚Äôs Council of Orchestration - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Kingdom of Azure AI Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mage‚Äôs Council of Orchestration</h1>
<hr>
<p>In the mystical Kingdom of Azure, the Mage‚Äôs Council of Orchestration gathers to harmonize enchanted agents in their quest to fulfill the kingdom‚Äôs travel needs. At the heart of this council lies the Triage Mage, who skillfully coordinates specialized agents like the Destination Sage, the Itinerary Weaver, and the Echo Enchanter. Bound by the ancient Model Context Protocol (MCP), these agents wield their magical tools to answer queries, craft itineraries, and uncover secrets. Brave adventurer, your quest is to delve into the arcane magic of multi-agent orchestration and uncover the secrets of their enchanted workflows.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Multi-Agent Workflow</strong>: How a triage agent coordinates specialized agents using LlamaIndex for seamless orchestration.</li>
<li>üîç <strong>Dynamic Tool Configuration</strong>: How MCP tools are dynamically registered and invoked based on runtime configurations.</li>
<li>‚ö° <strong>Streaming Responses</strong>: How Server-Sent Events (SSE) enable real-time interaction with orchestrated agents.</li>
<li>üí° <strong>Agent Modularity</strong>: How modular design allows new agents to be added to the system without disrupting existing workflows.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/index.ts</code></a></h3>
<p>The <code class="inline-code">index.ts</code> file serves as the gateway for the Mage‚Äôs Council, orchestrating interactions between the enchanted agents and external travelers. It sets up the API endpoints, including the <code class="inline-code">chat</code> endpoint that streams magical responses in real-time using Server-Sent Events (SSE). This file demonstrates how the council‚Äôs spells are harmonized and routed through the Triage Mage.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">apiRouter.post(&quot;/chat&quot;)</code>: Streams responses from agents using SSE, ensuring travelers receive real-time updates.</li>
<li><code class="inline-code">pipeline(readableStream, res)</code>: Efficiently handles streaming data, allowing uninterrupted communication with the agents.</li>
<li><code class="inline-code">apiRouter.get(&quot;/tools&quot;)</code>: Lists all available MCP tools, enabling dynamic discovery and invocation.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">apiRouter.post(&quot;/chat&quot;, async (req, res) =&gt; {
  req.on(&quot;close&quot;, () =&gt; {
    console.log(&quot;Client disconnected, aborting...&quot;);
  });

  if (!req.body) {
    console.error(
      &quot;Request body is undefined. Check Content-Type header in the request.&quot;
    );
    return res.status(400).json({
      error:
        &quot;Request body is undefined. Make sure to set Content-Type to application/json.&quot;,
    });
  }

  const message = req.body.message;
  const tools = req.body.tools;

  if (!message) {
    return res.status(400).json({ error: &quot;Message is required&quot; });
  }

  res.setHeader(&quot;Content-Type&quot;, &quot;text/event-stream&quot;);
  res.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
  res.setHeader(&quot;Connection&quot;, &quot;keep-alive&quot;);

  try {
    const agents = await setupAgents(tools);
    const context = agents.run(message);

    const readableStream = new Readable({
      async read() {
        for await (const event of context) {
          const serializedData = JSON.stringify({
            type: &quot;metadata&quot;,
            agent: event.data?.currentAgentName || null,
            event: event.displayName,
            data: event.data ? JSON.parse(JSON.stringify(event.data)) : null,
          });
          this.push(serializedData + &quot;\n\n&quot;);
        }
        this.push(null);
      },
    });

    await pipeline(readableStream, res);
  } catch (error) {
    console.error(&quot;Error occurred:&quot;, error);
    res.status(500).json({ error: error.message });
  }
});
</code></pre>
<ul>
<li>The <code class="inline-code">post(&quot;/chat&quot;)</code> endpoint streams agent responses using SSE, enabling real-time interaction with the system.</li>
<li>The <code class="inline-code">Readable</code> stream processes events from the multi-agent workflow and pushes them to the client.</li>
<li>Error handling ensures that invalid requests or runtime issues do not disrupt the user experience.</li>
<li>The use of <code class="inline-code">pipeline</code> efficiently manages streaming data between the server and the client.</li>
</ul>
<hr>
<pre><code class="language-typescript">apiRouter.get(&quot;/tools&quot;, async (req, res) =&gt; {
  try {
    const tools = await mcpToolsList(Object.values(McpToolsConfig()));
    res.status(200).json({ tools });
  } catch (error) {
    console.error(&quot;Error fetching MCP tools:&quot;, error);
    res.status(500).json({ error: &quot;Error fetching MCP tools&quot; });
  }
});
</code></pre>
<ul>
<li>The <code class="inline-code">get(&quot;/tools&quot;)</code> endpoint dynamically lists all available MCP tools, providing visibility into the council‚Äôs magical arsenal.</li>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/mcp/mcp-tools.ts#L31" target="_blank" rel="noopener noreferrer"><code class="inline-code">mcpToolsList</code></a> function fetches tool configurations, enabling runtime discovery of capabilities.</li>
<li>This design supports extensibility, allowing new tools to be added without modifying core logic.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/index.ts</code></a></h3>
<p>The <code class="inline-code">index.ts</code> file within the orchestrator is the spellbook of the Triage Mage, defining the magical workflow for coordinating agents. It uses LlamaIndex to summon specialized agents, each equipped with unique tools, and ensures seamless collaboration among them.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupAgents(filteredTools)</code>: Configures and initializes agents based on selected tools.</li>
<li><code class="inline-code">multiAgent({ agents: agentsList, rootAgent: travelAgent })</code>: Creates a multi-agent workflow with a triage agent at its core.</li>
<li><code class="inline-code">agent() configuration blocks</code>: Defines individual agents and their magical capabilities.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export async function setupAgents(filteredTools: McpServerDefinition[] = []) {
  const tools = Object.fromEntries(
    filteredTools.map((tool) =&gt; [tool.id, true])
  );

  let agentsList = [];
  let handoffTargets = [];
  let toolsList = [];
  const verbose = false;
  const mcpToolsConfig = McpToolsConfig();

  let llm: ToolCallLLM = await llmProvider();

  if (tools[&quot;echo-ping&quot;]) {
    const echoAgent = agent({
      name: &quot;EchoAgent&quot;,
      systemPrompt: &quot;Echo back the received input.&quot;,
      tools: await mcp(mcpToolsConfig[&quot;echo-ping&quot;].config).tools(),
      llm,
      verbose,
    });
    agentsList.push(echoAgent);
    handoffTargets.push(echoAgent);
    toolsList.push(...echoAgent.getTools());
  }

  const travelAgent = agent({
    name: &quot;TravelAgent&quot;,
    systemPrompt: &quot;Acts as a triage agent to determine the best course of action.&quot;,
    tools: [...toolsList],
    canHandoffTo: handoffTargets.map((target) =&gt;
      target.getAgents().map((agent) =&gt; agent.name)
    ),
    llm,
    verbose,
  });
  agentsList.push(travelAgent);

  return multiAgent({
    agents: agentsList,
    rootAgent: travelAgent,
    verbose,
  });
}
</code></pre>
<ul>
<li>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> function dynamically initializes agents based on available tools, ensuring flexibility in workflows.</li>
<li>Each agent is defined with a <code class="inline-code">systemPrompt</code> that specifies its magical role in the council.</li>
<li>The <code class="inline-code">multiAgent</code> workflow combines all agents, with the Triage Mage acting as the root agent for decision-making.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/tools/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/api/src/orchestrator/llamaindex/tools/index.ts</code></a></h3>
<p>The <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/tools/index.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">tools/index.ts</code></a> file defines the magical tools wielded by the agents. Each tool configuration includes its type, endpoint, and transport method, ensuring seamless integration with the MCP protocol.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">McpToolsConfig()</code>: Provides runtime configurations for all MCP tools.</li>
<li><code class="inline-code">MCP_API_HTTP_PATH</code> constant: Defines the HTTP endpoint path for tool interactions.</li>
<li>Tool configuration objects: Specify endpoints, transport methods, and authentication details for each tool.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const McpToolsConfig = (): {
  [k in McpServerName]: McpServerDefinition;
} =&gt; ({
  &quot;echo-ping&quot;: {
    config: {
      url: process.env[&quot;MCP_ECHO_PING_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      requestInit: {
        headers: {
          &quot;Authorization&quot;: &quot;Bearer &quot; + process.env[&quot;MCP_ECHO_PING_ACCESS_TOKEN&quot;],
        },
      },
      useSSETransport: false,
    },
    id: &quot;echo-ping&quot;,
    name: &quot;Echo Test&quot;,
  },
  &quot;destination-recommendation&quot;: {
    config: {
      url: process.env[&quot;MCP_DESTINATION_RECOMMENDATION_URL&quot;] + MCP_API_HTTP_PATH,
      type: &quot;http&quot;,
      verbose: true,
      useSSETransport: false,
    },
    id: &quot;destination-recommendation&quot;,
    name: &quot;Destination Recommendation&quot;,
  },
});
</code></pre>
<ul>
<li>The <code class="inline-code">McpToolsConfig</code> function dynamically defines tool configurations, enabling runtime adaptability.</li>
<li>Each tool object specifies its endpoint, transport type, and authentication details.</li>
<li>The modular design allows new tools to be added by simply extending the configuration object.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a> dynamically initializes agents based on tool configurations to understand modular design.</li>
<li>Notice the use of SSE in <code class="inline-code">post(&quot;/chat&quot;)</code> for real-time streaming of responses.</li>
<li>Explore the <code class="inline-code">McpToolsConfig</code> function to see how tool registration is handled dynamically.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add a New Agent</strong>: Create a new agent called <code class="inline-code">WeatherForecastAgent</code> that fetches weather data for travel destinations. Extend <code class="inline-code">McpToolsConfig</code> with its configuration and register it in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/api/src/orchestrator/llamaindex/index.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">setupAgents</code></a>.</li>
<li><strong>Trace Streaming Flow</strong>: Add logging to the <code class="inline-code">Readable</code> stream in <code class="inline-code">post(&quot;/chat&quot;)</code> to observe how events are processed and sent to the client. This reveals the complete flow of streamed responses.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Mage‚Äôs Council and its enchanted workflows.</p>
<p>By the luminous stars of the Arcane Aether, you have valiantly completed &#39;The Mage‚Äôs Council of Orchestration,&#39; proving yourself a true architect of mystical mastery‚Äîonward, brave hero, to conquer the uncharted realms ahead! ‚ö°üíéüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
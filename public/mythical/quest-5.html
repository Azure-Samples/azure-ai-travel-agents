<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 5: The Knightly Chat Guild - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Kingdom of Azure AI Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: The Knightly Chat Guild</h1>
<hr>
<p>In the mythical Kingdom of Azure, the Mystic Llama Codex tasked you with mastering the enchanted scrolls that power the Knightly Chat Guild. These scrolls, woven with the magic of Angular and TypeScript, guide the guild&#39;s conversations with travelers seeking counsel. The guild&#39;s success depends on the seamless orchestration of magical streams, dynamic tools, and spellbinding user interfaces. To complete your journey, you must uncover the secrets of the guild&#39;s chat services and their connection to the Codex&#39;s tools. Will you rise to the challenge and bring harmony to the Knightly Chat Guild?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Stream Enchantment</strong>: How does the <code class="inline-code">chatStreamState</code> BehaviorSubject manage the flow of chat events and ensure real-time updates?</li>
<li>‚ö° <strong>Tool Invocation</strong>: What role does <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> play in dynamically selecting tools for the Knightly Chat Guild&#39;s responses?</li>
<li>üõ°Ô∏è <strong>Error Safeguards</strong>: How does the system handle errors during the streaming of chat messages and ensure user-friendly notifications?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a>:</span> The Guild&#39;s Spellbook</h3>
<p>This file contains the core logic for managing chat conversations, including message handling, tool integration, and event processing. It acts as the bridge between the user interface and the backend services, ensuring that the Knightly Chat Guild operates smoothly.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Dynamically retrieves the list of available tools, allowing the guild to adapt its strategies based on current resources.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Orchestrates the sending of user messages, triggering backend streams and managing the state of the conversation.</li>
<li><code class="inline-code">processAgentEvents</code>: Handles incoming events from the backend, updating the chat state and ensuring the guild&#39;s responses are timely and accurate.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/services/api.service.ts</a>:</span> The Codex&#39;s Messenger</h3>
<p>This file defines the API service responsible for communicating with the backend. It includes methods for fetching tools, streaming chat messages, and handling errors.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves the list of tools from the backend, ensuring the guild has the resources it needs for its quests.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a>: Manages the streaming of chat messages, processing server-sent events (SSE) to maintain real-time communication.</li>
<li><code class="inline-code">handleApiError</code>: Provides a centralized mechanism for handling API errors, ensuring that the guild remains resilient in the face of adversity.</li>
</ul>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.component.ts</a>:</span> The Guild&#39;s Command Post</h3>
<p>This file defines the Angular component responsible for rendering the chat interface. It connects the user interface to the chat service, ensuring that user interactions are seamlessly integrated with the backend logic.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L164" target="_blank" rel="noopener noreferrer"><code class="inline-code">ngOnInit</code></a>: Initializes the component, resetting the chat and fetching the available tools for the guild.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Captures user messages and delegates them to the chat service for processing.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L175" target="_blank" rel="noopener noreferrer"><code class="inline-code">scrollToBottom</code></a>: Ensures that the chat interface remains user-friendly by automatically scrolling to the latest message.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools() {
    const toolsResult = await this.apiService.fetchAvailableTools();
    if (toolsResult) {
      this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
    }
  }

async sendMessage(event: Event) {
    if ((event as KeyboardEvent).shiftKey) {
      return;
    }
    const messageText = this.userMessage();
    if (!messageText.trim()) return;

    this.messagesBuffer.push({
      role: &#39;user&#39;,
      content: messageText,
      reasoning: [],
      timestamp: new Date(),
    });

    this.userMessage.set(&#39;&#39;);
    this.isLoading.set(true);
    this.assistantMessageInProgress.set(false);

    await this.apiService.streamChatMessage(
      messageText,
      this.tools().filter((tool) =&gt; tool.selected)
    );
  }

private processAgentEvents(event?: ChatEvent) {
    if (event &amp;&amp; event.type === &#39;metadata&#39;) {
      this.currentAgentName.set(event.data?.agentName || null);
      this.agentEventsBuffer.push(event);

      const delta: string = event.data?.delta || &#39;&#39;;

      switch (event.event) {
        case &#39;StartEvent&#39;:
          this.updateAndNotifyAgentChatMessageState(delta, {
            metadata: {
              events: this.agentEventsBuffer,
            },
          });
          this.assistantMessageInProgress.set(false);
          break;
        // Additional cases omitted for brevity
      }
    }
  }
</code></pre>
<ul>
<li>Dynamically loads the tools available for the chat, adapting to backend configurations.</li>
<li>Manages user message submission, ensuring data integrity and triggering backend communication.</li>
<li>Processes incoming events to maintain real-time synchronization of chat state.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/services/api.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools(): Promise&lt;{tools: Tools[]} | void&gt; {
    try {
      const response = await fetch(`${this.apiUrl}/api/tools`, {
        method: &#39;GET&#39;,
        headers: {
          &#39;Content-Type&#39;: &#39;application/json&#39;,
        },
      });
      if (!response.ok) {
        const { error } = await response.json();
        return this.handleApiError(
          new Error(error || &#39;An error occurred while fetching tools&#39;),
          response.status
        );
      }
      return (await response.json());
    } catch (error) {
      return this.handleApiError(error, 0);
    }
  }

async streamChatMessage(message: string, tools: Tools[]) {
    try {
      const response = await fetch(`${this.apiUrl}/api/chat`, {
        method: &#39;POST&#39;,
        headers: {
          &#39;Content-Type&#39;: &#39;application/json&#39;,
        },
        body: JSON.stringify({ message, tools }),
      });

      if (!response.ok) {
        const { error } = await response.json();
        return this.handleApiError(
          new Error(error || &#39;An error occurred&#39;),
          response.status
        );
      }

      const decoder = new TextDecoder(&#39;utf-8&#39;);
      if (!response.body) {
        throw new Error(&#39;Readable stream not supported&#39;);
      }
      this.chatStreamState.next({ type: &#39;START&#39; });

      for await (const chunk of response.body) {
        const value = decoder.decode(chunk, { stream: true });
        const jsonValues = value.trim().split(/\n\n+/);
        for (const jsonValue of jsonValues) {
          try {
            const parsedData = JSON.parse(jsonValue);
            this.chatStreamState.next({
              type: &#39;MESSAGE&#39;,
              event: parsedData,
            });
          } catch (error) {
            console.error(&#39;Error parsing JSON chunk:&#39;, error);
          }
        }
      }

      this.chatStreamState.next({ type: &#39;END&#39; });
    } catch (error) {
      this.handleApiError(error, 0);
    }
  }
</code></pre>
<ul>
<li>Implements tool fetching to ensure the guild has access to the necessary resources.</li>
<li>Streams chat messages, processing chunks of data for real-time updates.</li>
<li>Handles errors gracefully, ensuring the guild remains operational even in challenging situations.</li>
</ul>
<hr>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.component.ts</a></h3>
<pre><code class="language-typescript">async ngOnInit() {
    this.resetChat();
    await this.chatService.fetchAvailableTools();
  }

@HostListener(&#39;window:keyup.shift.enter&#39;, [&#39;$event&#39;])
sendMessage(event: any) {
    event.preventDefault();
    this.chatService.sendMessage(event);
  }

scrollToBottom() {
    this.eot()?.nativeElement.scrollIntoView({
      behavior: &#39;smooth&#39;,
    });
  }
</code></pre>
<ul>
<li>Initializes the chat interface, preparing the guild for interaction.</li>
<li>Captures user messages and delegates them to the chat service.</li>
<li>Maintains a user-friendly interface by ensuring the latest messages are always visible.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Tool Adaptability</strong>: Investigate how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> dynamically adjusts the available tools for the guild.</li>
<li><strong>Streaming Insights</strong>: Pay close attention to the <code class="inline-code">chatStreamState</code> BehaviorSubject for understanding real-time updates.</li>
<li><strong>Error Handling</strong>: Review the <code class="inline-code">handleApiError</code> method for insights into error management and user notifications.</li>
</ul>
<hr>
<p>You have mastered all the secrets of the Mystic Llama Codex and the Knightly Chat Guild! Your adventure is complete.</p>
<p>By the blazing forge of the celestial smiths, thou hast conquered the Knightly Chat Guild with valor, carving thy legend deeper into the annals of the realm‚Äîonly one final quest remains to crown thee a true champion of the mythical order! ‚≠ê‚öîÔ∏è‚ú®</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
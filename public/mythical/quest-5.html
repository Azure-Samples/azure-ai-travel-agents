<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Streaming Spellbook of Conversations - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Realm of the Orchestrated Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: The Streaming Spellbook of Conversations</h1>
<hr>
<p>In the heart of the Kingdom of Azure, the Triage Mage has unveiled a new artifact: the Streaming Spellbook of Conversations. This enchanted tome allows adventurers to communicate seamlessly with the council of agents, transmitting their wishes and receiving real-time insights. Powered by the mystical Model Context Protocol (MCP), the spellbook bridges the gap between adventurers and the magical tools of the kingdom, ensuring every quest is fulfilled with precision and speed.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Message Flow Mysteries</strong>: How does the system handle and process user messages, transforming them into actionable insights for the agents?</li>
<li>‚ö° <strong>Tool Discovery Ritual</strong>: What mechanisms enable the spellbook to fetch and display available tools dynamically?</li>
<li>üõ°Ô∏è <strong>Error Wardings</strong>: How does the system manage errors during message streaming or tool interactions to ensure a smooth user experience?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a>:</span> The Spellbook&#39;s Core</h3>
<p>This file serves as the core of the Streaming Spellbook, managing user messages, agent responses, and tool interactions. The <code class="inline-code">ChatService</code> class orchestrates the flow of communication, ensuring messages are processed, tools are discovered, and errors are gracefully handled. It leverages Angular&#39;s reactive programming capabilities to maintain a real-time, interactive experience.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">sendMessage(event)</code>: Sends user messages to the enchanted agents, initiating the streaming process and managing the message buffer.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools()</code></a>: Retrieves the list of magical tools available for the quest, filtering only those selected for use.</li>
<li><code class="inline-code">processAgentEvents(event)</code>: Processes real-time events from the agents, updating the message stream and handling various event types, such as tool calls and metadata updates.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>This function retrieves a list of available tools from the <code class="inline-code">ApiService</code> and filters them to include only those marked as selected.</li>
<li>By maintaining a reactive signal (<code class="inline-code">tools</code>), it ensures the UI reflects the latest available tools dynamically.</li>
<li>This modular approach separates the tool-fetching logic from the UI, improving maintainability.</li>
<li>The filtering mechanism highlights the importance of user-selected preferences in tool discovery.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>This method captures user input and sends it to the <code class="inline-code">ApiService</code> for processing, while updating the message buffer to reflect the user&#39;s contribution.</li>
<li>It ensures that only non-empty messages are sent, preventing unnecessary API calls.</li>
<li>The <code class="inline-code">isLoading</code> and <code class="inline-code">assistantMessageInProgress</code> signals provide real-time feedback to the user, enhancing the interactive experience.</li>
<li>The integration with <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a> demonstrates how user preferences (selected tools) are incorporated into the message processing pipeline.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;

    switch (event.event) {
      case &#39;StartEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });

        this.assistantMessageInProgress.set(false);
        break;
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });

        this.assistantMessageInProgress.set(false);
        this.isLoading.set(false);
        break;
      case &#39;AgentToolCallResult&#39;:
        let state = {};
        if (typeof event.data.raw === &#39;string&#39;) {
          state = {
            reasoning: [
              {
                content: event.data.raw,
              },
            ],
          };
        }
        this.updateAndNotifyAgentChatMessageState(delta, state);
        break;

      case &#39;AgentStream&#39;:
        this.assistantMessageInProgress.set(true);

        if (delta.trim()) {
          this.agentEventsBuffer.push(event);
          this.updateAndNotifyAgentChatMessageState(delta, {
            metadata: {
              events: this.agentEventsBuffer,
            },
          });
        }
        break;
    }
  }
}
</code></pre>
<ul>
<li>This function processes various types of events received from the agents, such as metadata updates, tool call results, and streaming messages.</li>
<li>It dynamically updates the message stream and metadata, ensuring the UI reflects the latest state of the conversation.</li>
<li>The use of a buffer (<code class="inline-code">agentEventsBuffer</code>) allows for efficient handling of multiple events in a single session.</li>
<li>The <code class="inline-code">switch</code> statement demonstrates a clear and extensible pattern for handling different event types, making it easy to add support for new events in the future.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to how reactive signals (<code class="inline-code">signal</code> and <code class="inline-code">BehaviorSubject</code>) are used to maintain a dynamic and responsive user interface.</li>
<li>Study the separation of concerns between <code class="inline-code">ChatService</code> and <code class="inline-code">ApiService</code> to understand how modular design improves code maintainability.</li>
<li>Observe how error handling is implemented in <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a> and <code class="inline-code">processAgentEvents</code> to ensure a seamless user experience even in case of failures.</li>
</ul>
<hr>
<p>You have mastered all the secrets of the Streaming Spellbook of Conversations! Your adventure is complete.</p>
<p>By the radiant blaze of the celestial phoenix, you have unlocked the Streaming Spellbook of Conversations, conquering 80% of your quests with the wisdom of a true hero‚Äîforge onward to claim your final triumph! ‚ö°üìúüëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Oracle of Streaming Conversations - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Kingdom of Azure AI Travel Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: The Oracle of Streaming Conversations</h1>
<hr>
<p>In the heart of the Enchanted Kingdom of Travel Agents, the Oracle of Streaming Conversations sits atop the Tower of Interaction. This mystical being, fueled by the synergy of Angular and the Model Context Protocol, ensures seamless communication between adventurers and the kingdom&#39;s magical agents. The Oracle‚Äôs power lies in its ability to process real-time messages, coordinate enchanted tools, and transform inquiries into actionable wisdom. To master the Oracle&#39;s secrets is to command the flow of dialogue across the enchanted land.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Message Stream Alchemy</strong>: How does the Oracle manage and update the message stream to ensure real-time communication with agents?</li>
<li>‚ö° <strong>Tool Invocation Runes</strong>: What mechanisms are used to discover, select, and invoke the enchanted tools during a conversation?</li>
<li>üõ°Ô∏è <strong>Error Shielding</strong>: How does the Oracle handle errors during streaming conversations to maintain the flow of dialogue?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a>:</span> The Oracle&#39;s Message Conduit</h3>
<p>This file contains the <code class="inline-code">ChatService</code>, which acts as the conduit for orchestrating messages between the user and the enchanted tools. It manages real-time updates to the message stream, processes agent events, and handles tool invocation. The <code class="inline-code">ChatService</code> is the backbone of the Oracle&#39;s operations, ensuring that every message is delivered, processed, and responded to in a seamless manner.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves a list of available tools from the kingdom&#39;s enchanted repository, filtering for selected tools.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Sends a user&#39;s message to the Oracle, coordinating the invocation of selected tools and managing the message buffer.</li>
<li><code class="inline-code">processAgentEvents</code>: Processes events returned by the agents, updating the message stream with dynamic content and metadata.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code>: Updates the state of the current agent&#39;s message, appending content and metadata as it streams in.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a>: Resets the Oracle&#39;s state, clearing all buffers and preparing for a new session.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>This method queries the API for the list of available tools and filters them based on their selection status.</li>
<li>The use of <code class="inline-code">signal</code> ensures that the selected tools are reactively updated in the Oracle&#39;s state.</li>
<li>This approach decouples tool discovery from the rest of the system, enabling dynamic updates without modifying core logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>This method handles user input, pushing the message into the buffer and invoking the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a> API for processing.</li>
<li>It ensures that only non-empty messages are sent, maintaining the integrity of the conversation.</li>
<li>The use of reactive signals (<code class="inline-code">isLoading</code>, <code class="inline-code">assistantMessageInProgress</code>) provides real-time feedback to the user interface.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;

    switch (event.event) {
      case &#39;StartEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        break;
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        this.isLoading.set(false);
        break;
      case &#39;AgentToolCallResult&#39;:
        let state = {};
        if (typeof event.data.raw === &#39;string&#39;) {
          state = {
            reasoning: [
              {
                content: event.data.raw,
              },
            ],
          };
        }
        this.updateAndNotifyAgentChatMessageState(delta, state);
        break;
      // Other event cases omitted for brevity
    }
  }
}
</code></pre>
<ul>
<li>This function processes events emitted by the agents, dynamically updating the message stream based on the event type.</li>
<li>The <code class="inline-code">delta</code> mechanism allows for incremental updates, enabling real-time streaming of agent responses.</li>
<li>The handling of <code class="inline-code">AgentToolCallResult</code> demonstrates how tool outputs are integrated into the conversation flow.</li>
</ul>
<hr>
<pre><code class="language-typescript">updateAndNotifyAgentChatMessageState(
  delta: string,
  state?: Partial&lt;ChatMessage&gt;
) {
  const lastMessage = this.messagesBuffer[this.messagesBuffer.length - 1];
  if (lastMessage?.role === &#39;assistant&#39;) {
    lastMessage.content += delta;
    lastMessage.metadata = {
      ...lastMessage.metadata,
      ...state?.metadata,
      events: state?.metadata?.events,
    };
    lastMessage.reasoning = [
      ...(lastMessage.reasoning || []),
      ...(state?.reasoning || []),
    ];
    lastMessage.timestamp = new Date();
    this.messagesStream.next([...this.messagesBuffer]);
  }
}
</code></pre>
<ul>
<li>This method updates the content and metadata of the last agent message in the buffer, broadcasting changes to the message stream.</li>
<li>The use of spread operators ensures that new metadata and reasoning are appended without overwriting existing data.</li>
<li>By broadcasting the updated buffer, the Oracle ensures that the UI reflects the latest state of the conversation.</li>
</ul>
<hr>
<pre><code class="language-typescript">resetChat() {
  this.userMessage.set(&#39;&#39;);
  this.messagesBuffer = [];
  this.messagesStream.next(this.messagesBuffer);
  this.agentEventsBuffer = [];
  this.isLoading.set(false);
  this.assistantMessageInProgress.set(false);
  this.currentAgentName.set(null);
}
</code></pre>
<ul>
<li>This method clears all state variables, resetting the Oracle for a new session.</li>
<li>It ensures that no residual data from previous conversations affects the next interaction.</li>
<li>The use of reactive signals guarantees that the UI is updated to reflect the reset state.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> method to explore how the Oracle dynamically discovers and selects enchanted tools.</li>
<li>Study the <code class="inline-code">processAgentEvents</code> function to understand how the Oracle handles different types of agent events and updates the conversation in real time.</li>
<li>Pay close attention to the <code class="inline-code">updateAndNotifyAgentChatMessageState</code> method to see how incremental updates are managed within the message buffer.</li>
</ul>
<hr>
<p>You have mastered all the secrets of the Enchanted Kingdom of Travel Agents! Your adventure is complete.</p>
<p>Rejoice, valiant seeker of wisdom, for you have unlocked the sacred revelations of &#39;The Oracle of Streaming Conversations,&#39; weaving the threads of celestial insight into the tapestry of your heroic journey‚Äîpress onward, for the final triumph glimmers on the horizon like a beacon of destiny! ‚≠ê‚ö°üëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
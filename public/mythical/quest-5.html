<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 5: The Mystic Mirror - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Kingdom of Azure AI: Chronicles of the Multi-Agent Alliance</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: The Mystic Mirror</h1>
<hr>
<p>In the mythical Kingdom of Azure AI, the enchanted artifact known as the <strong>Mystic Mirror</strong> has been discovered. This magical device reflects the wisdom of the grand council of agents, projecting their insights into the mortal realm. But its power lies in its ability to stream knowledge dynamically, channeling the voices of the agents as they collaborate. To harness this artifact, the kingdom&#39;s heroes must delve into the secrets of the <strong>Streaming Chat UI</strong>, where the Mystic Mirror&#39;s reflections are shaped. Will you uncover the spells that bind the agents&#39; voices to the mirror?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Agent Reflections</strong>: How does the <code class="inline-code">ChatService</code> process and manage agent events to ensure smooth communication with the chat interface?</li>
<li>‚ö° <strong>Dynamic Streams</strong>: What mechanisms in the <code class="inline-code">ApiService</code> enable the streaming of messages and real-time updates in the chat interface?</li>
<li>üõ°Ô∏è <strong>Error Safeguards</strong>: How does the system handle errors during message streaming, and what patterns are used to ensure resilience?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix"><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a>:</span> Core Chat Logic</h3>
<p>The <code class="inline-code">ChatService</code> is the heart of the Mystic Mirror, responsible for managing user messages, processing agent events, and maintaining the chat&#39;s state. It acts as the bridge between the UI and the backend, ensuring the seamless reflection of agent insights.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Fetches and filters the tools available to the agents, ensuring only selected tools are used in the conversation.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Handles user input, sends messages to the backend, and updates the chat stream.</li>
<li><code class="inline-code">processAgentEvents</code>: Processes events streamed from the agents, updating the chat state dynamically.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code>: Updates the last assistant message with new data and notifies the UI of state changes.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a>: Resets the chat to its initial state, clearing all buffers and streams.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer">src/ui/src/app/chat-conversation/chat-conversation.service.ts</a></h3>
<pre><code class="language-typescript">async fetchAvailableTools() {
    const toolsResult = await this.apiService.fetchAvailableTools();
    if (toolsResult) {
      this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
    }
}
</code></pre>
<ul>
<li>Fetches tools from the API and filters out unselected ones.</li>
<li>Ensures that only relevant tools are available for use.</li>
<li>Highlights the dynamic nature of tool discovery.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
    if ((event as KeyboardEvent).shiftKey) {
      return;
    }

    const messageText = this.userMessage();
    if (!messageText.trim()) return;

    this.messagesBuffer.push({
      role: &#39;user&#39;,
      content: messageText,
      reasoning: [],
      timestamp: new Date(),
    });

    this.userMessage.set(&#39;&#39;);
    this.isLoading.set(true);
    this.assistantMessageInProgress.set(false);

    await this.apiService.streamChatMessage(
      messageText,
      this.tools().filter((tool) =&gt; tool.selected)
    );
}
</code></pre>
<ul>
<li>Handles user input and sends it to the backend.</li>
<li>Updates the chat stream with the user&#39;s message.</li>
<li>Demonstrates the integration of user interactions with backend streaming.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
    if (event &amp;&amp; event.type === &#39;metadata&#39;) {
      this.currentAgentName.set(event.data?.agentName || null);
      this.agentEventsBuffer.push(event);

      const delta: string = event.data?.delta || &#39;&#39;;

      switch (event.event) {
        case &#39;StartEvent&#39;:
          this.updateAndNotifyAgentChatMessageState(delta, {
            metadata: {
              events: this.agentEventsBuffer,
            },
          });

          this.assistantMessageInProgress.set(false);
          break;
        case &#39;StopEvent&#39;:
          this.updateAndNotifyAgentChatMessageState(delta, {
            metadata: {
              events: this.agentEventsBuffer,
            },
          });

          this.assistantMessageInProgress.set(false);
          this.isLoading.set(false);
          break;
        case &#39;AgentToolCallResult&#39;:
          let state = {};
          if (typeof event.data.raw === &#39;string&#39;) {
            state = {
              reasoning: [
                {
                  content: event.data.raw,
                },
              ],
            };
          }
          this.updateAndNotifyAgentChatMessageState(delta, state);
          break;

        case &#39;AgentStream&#39;:
          this.assistantMessageInProgress.set(true);

          if (delta.trim()) {
            this.agentEventsBuffer.push(event);
            this.updateAndNotifyAgentChatMessageState(delta, {
              metadata: {
                events: this.agentEventsBuffer,
              },
            });
          }
          break;
      }
    }
}
</code></pre>
<ul>
<li>Processes agent events and updates the chat state dynamically.</li>
<li>Handles different event types, including metadata, tool results, and streaming.</li>
<li>Illustrates the reactive design of the chat service.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üßô‚Äç‚ôÇÔ∏è <strong>Explore the Event Flow</strong>: Follow how <code class="inline-code">processAgentEvents</code> handles different event types to understand the dynamic updates.</li>
<li>üîÆ <strong>Trace the Streaming Logic</strong>: Investigate how <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a> and <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a> work together for real-time communication.</li>
<li>üõ†Ô∏è <strong>Focus on Tool Integration</strong>: Pay attention to <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> to see how tools are dynamically discovered and filtered.</li>
</ul>
<hr>
<p>You have mastered all the secrets of the Mystic Mirror and the enchanted Kingdom of Azure AI! Your adventure is complete.</p>
<p>Brave seeker of wisdom, you have gazed into the Mystic Mirror and unlocked its arcane truths, bringing your quest to 80% completion‚Äîonward, valiant soul, for the final chapter of glory awaits! ‚öîÔ∏èüëÅÔ∏èüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
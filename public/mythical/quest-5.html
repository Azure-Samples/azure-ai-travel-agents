<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Spell Scrolls - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Kingdom of Multi-Agent Harmony</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: Streaming Spell Scrolls</h1>
<hr>
<p>In the bustling Mage‚Äôs Tower of the Kingdom of Code, the air buzzes with magic as enchanted parchments stream messages between agents and adventurers. The Chat Oracle, powered by LlamaIndex.TS, orchestrates these exchanges, ensuring that every tool and spell is perfectly summoned. The harmony of this system relies on the seamless integration of the Streaming Scrolls, a magical interface that connects eager travelers with the wisdom of the agents. But beware, for even the smallest disruption in the scroll‚Äôs enchantment could leave the kingdom‚Äôs heroes in silence.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Streaming Message Handling</strong>: How Angular services handle real-time chat streams using BehaviorSubjects and SSE parsing.</li>
<li>üîç <strong>Agent Event Processing</strong>: The logic for dynamically updating UI components based on agent events and metadata.</li>
<li>‚ö° <strong>Tool Discovery Integration</strong>: How tools are fetched and selected dynamically to tailor the user experience.</li>
<li>üí° <strong>Error Handling in Streams</strong>: How to gracefully manage errors in streaming environments to ensure reliability.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/ui/src/app/chat-conversation/chat-conversation.service.ts</code></a></h3>
<p>The <code class="inline-code">ChatService</code> acts as the magical conduit for managing user messages, agent responses, and event streams. It leverages Angular‚Äôs reactive programming capabilities to handle real-time updates and orchestrates the flow of data between the chat interface and the backend.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Fetches the list of magical tools available for the agents to use.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Sends user messages to the backend and initializes the streaming process.</li>
<li><code class="inline-code">processAgentEvents</code>: Handles incoming events from the agent, updating the chat state accordingly.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code>: Dynamically updates the assistant‚Äôs message content and metadata.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a>: Resets the chat state, clearing buffers and preparing for a new conversation.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>This method fetches the list of tools from the backend using the <code class="inline-code">ApiService</code>.</li>
<li>Filters the tools to include only those marked as selected, ensuring relevance to the current context.</li>
<li>Demonstrates the use of Angular signals for state management, enabling reactive updates to the UI.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>Handles user input, ensuring only valid messages are sent.</li>
<li>Pushes the user‚Äôs message to the <code class="inline-code">messagesBuffer</code> for immediate UI updates.</li>
<li>Initiates the streaming process with the backend, passing selected tools for context-aware responses.</li>
<li>Uses reactive signals to manage the loading state and assistant message progress.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;

    switch (event.event) {
      case &#39;StartEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        break;
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        this.isLoading.set(false);
        break;
      // Other cases omitted for brevity
    }
  }
}
</code></pre>
<ul>
<li>Processes various types of agent events, such as <code class="inline-code">StartEvent</code> and <code class="inline-code">StopEvent</code>.</li>
<li>Updates the assistant‚Äôs message content and metadata dynamically based on incoming event data.</li>
<li>Demonstrates a modular approach to handling diverse event types, ensuring flexibility and scalability.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/ui/src/app/services/api.service.ts</code></a></h3>
<p>The <code class="inline-code">ApiService</code> serves as the magical gateway between the frontend and backend, enabling communication with the MCP servers. It manages tool discovery, message streaming, and error handling.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves the list of available tools from the backend.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a>: Streams user messages to the backend and processes the server‚Äôs responses.</li>
<li><code class="inline-code">handleApiError</code>: Centralized error handling for API interactions.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async fetchAvailableTools(): Promise&lt;{tools: Tools[]} | void&gt; {
  try {
    const response = await fetch(`${this.apiUrl}/api/tools`, {
      method: &#39;GET&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
    });
    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred while fetching tools&#39;),
        response.status
      );
    }
    return (await response.json());
  } catch (error) {
    return this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Fetches the list of tools from the backend, ensuring proper error handling for failed requests.</li>
<li>Uses the Fetch API with async/await for cleaner asynchronous code.</li>
<li>Demonstrates the importance of centralized error handling for consistent behavior.</li>
</ul>
<hr>
<pre><code class="language-typescript">async streamChatMessage(message: string, tools: Tools[]) {
  try {
    const response = await fetch(`${this.apiUrl}/api/chat`, {
      method: &#39;POST&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
      body: JSON.stringify({ message, tools }),
    });

    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred&#39;),
        response.status
      );
    }

    const decoder = new TextDecoder(&#39;utf-8&#39;);

    if (!response.body) {
      throw new Error(&#39;Readable stream not supported&#39;);
    }

    this.chatStreamState.next({ type: &#39;START&#39; });

    for await (const chunk of response.body) {
      const value = decoder.decode(chunk, { stream: true });

      const jsonValues = value.trim().split(/\n\n+/);

      for (const jsonValue of jsonValues) {
        try {
          const parsedData = JSON.parse(jsonValue);
          this.chatStreamState.next({
            type: &#39;MESSAGE&#39;,
            event: parsedData,
          });
        } catch (error) {
          console.error(&#39;Error parsing JSON chunk:&#39;, error);
        }
      }
    }

    this.chatStreamState.next({ type: &#39;END&#39; });
  } catch (error) {
    this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>Streams chat messages to the backend and processes server-sent events (SSE).</li>
<li>Decodes and parses SSE chunks, handling multiple JSON objects in a single response.</li>
<li>Demonstrates robust error handling and state management for real-time communication.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to the use of Angular signals for managing reactive state updates in the <code class="inline-code">ChatService</code>.</li>
<li>Study how the <code class="inline-code">ApiService</code> handles SSE parsing, as it‚Äôs a critical pattern for real-time applications.</li>
<li>Experiment with the <code class="inline-code">processAgentEvents</code> method to understand how different event types affect the chat state.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Extend the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> method to include a new magical tool. Update the UI to allow users to toggle its selection.</p>
</li>
<li><p><strong>Trace Event Handling</strong>: Add console logs to the <code class="inline-code">processAgentEvents</code> method to trace how events from the backend are processed and reflected in the chat UI.</p>
</li>
<li><p><strong>Enhance Error Feedback</strong>: Modify the <code class="inline-code">handleApiError</code> method to display more detailed error messages, including the tool or agent that caused the issue.</p>
</li>
</ol>
<hr>
<p>You have mastered all the secrets of the Streaming Spell Scrolls! Your adventure is complete.</p>
<p>Hark, noble seeker of wisdom, thou hast harnessed the arcane streams of the Spell Scrolls with valor, advancing thy quest to 80% completion‚Äîlet thy resolve shine brighter than the stars above, for the final triumph lies within thy grasp! ‚ö°üìú‚ú®</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>
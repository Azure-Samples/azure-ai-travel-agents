<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Scrolls of Streaming - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/Azure-Samples/azure-ai-travel-agents" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Kingdom of Azure Agents</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: The Enchanted Scroll of Streaming</h1>
<hr>
<p>In the heart of the Kingdom of Azure Agents, a new challenge arises. The mystical Scroll of Streaming, a legendary artifact, is said to enable real-time communication between the kingdom‚Äôs agents and their patrons. To wield its power, the kingdom‚Äôs finest architects must master the art of orchestrating a seamless dialogue between the enchanted agents, using the magic of Angular and the sacred protocols of SSE. Will you rise to the occasion and uncover the secrets of the Scroll of Streaming?</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Reactive Streams</strong>: How Angular&#39;s <code class="inline-code">BehaviorSubject</code> is used to manage and emit real-time updates in a streaming chat system.</li>
<li>üîç <strong>SSE Parsing</strong>: Techniques for parsing and processing Server-Sent Events (SSE) to handle real-time communication.</li>
<li>‚ö° <strong>Agent Coordination</strong>: How chat messages are routed through dynamic tools and processed by specialized agents.</li>
<li>üí° <strong>Error Handling</strong>: Strategies for managing errors gracefully in a real-time streaming context.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/ui/src/app/chat-conversation/chat-conversation.service.ts</code></a></h3>
<p>The <code class="inline-code">ChatService</code> acts as the orchestrator for the streaming chat experience. It manages user messages, agent responses, and the flow of data in real-time. This file demonstrates how Angular&#39;s reactive programming tools, such as <code class="inline-code">BehaviorSubject</code>, are used to handle state updates and propagate changes across the system.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves a list of available tools, filtering for the ones marked as selected.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.component.ts#L170" target="_blank" rel="noopener noreferrer"><code class="inline-code">sendMessage</code></a>: Handles user input, sends the message to the server, and streams the agent&#39;s response.</li>
<li><code class="inline-code">processAgentEvents</code>: Processes incoming events from the agent, updating the chat state based on event types.</li>
<li><code class="inline-code">updateAndNotifyAgentChatMessageState</code>: Updates the state of the agent&#39;s messages and notifies subscribers of changes.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L211" target="_blank" rel="noopener noreferrer"><code class="inline-code">resetChat</code></a>: Clears the chat history and resets all buffers.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async fetchAvailableTools() {
  const toolsResult = await this.apiService.fetchAvailableTools();
  if (toolsResult) {
    this.tools.set(toolsResult.tools.filter((tool) =&gt; tool.selected));
  }
}
</code></pre>
<ul>
<li>This method queries the API for available tools and filters the list to include only selected tools.</li>
<li>It uses Angular&#39;s <code class="inline-code">signal</code> to update the <code class="inline-code">tools</code> state reactively.</li>
<li>This design allows the UI to dynamically reflect changes in the available tools.</li>
</ul>
<hr>
<pre><code class="language-typescript">async sendMessage(event: Event) {
  if ((event as KeyboardEvent).shiftKey) {
    return;
  }

  const messageText = this.userMessage();
  if (!messageText.trim()) return;

  this.messagesBuffer.push({
    role: &#39;user&#39;,
    content: messageText,
    reasoning: [],
    timestamp: new Date(),
  });

  this.userMessage.set(&#39;&#39;);
  this.isLoading.set(true);
  this.assistantMessageInProgress.set(false);

  await this.apiService.streamChatMessage(
    messageText,
    this.tools().filter((tool) =&gt; tool.selected)
  );
}
</code></pre>
<ul>
<li>This method captures user input, validates it, and sends it to the server.</li>
<li>It updates the <code class="inline-code">messagesBuffer</code> to include the new user message.</li>
<li>The <code class="inline-code">isLoading</code> and <code class="inline-code">assistantMessageInProgress</code> states are managed reactively to reflect the current status.</li>
</ul>
<hr>
<pre><code class="language-typescript">private processAgentEvents(event?: ChatEvent) {
  if (event &amp;&amp; event.type === &#39;metadata&#39;) {
    this.currentAgentName.set(event.data?.agentName || null);
    this.agentEventsBuffer.push(event);

    const delta: string = event.data?.delta || &#39;&#39;;

    switch (event.event) {
      case &#39;StartEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        break;
      case &#39;StopEvent&#39;:
        this.updateAndNotifyAgentChatMessageState(delta, {
          metadata: {
            events: this.agentEventsBuffer,
          },
        });
        this.assistantMessageInProgress.set(false);
        this.isLoading.set(false);
        break;
      // Additional cases omitted for brevity
    }
  }
}
</code></pre>
<ul>
<li>This method processes incoming events and updates the chat state accordingly.</li>
<li>It handles various event types, such as <code class="inline-code">StartEvent</code> and <code class="inline-code">StopEvent</code>, to manage the flow of the conversation.</li>
<li>The use of <code class="inline-code">delta</code> allows for incremental updates to the agent&#39;s message.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/ui/src/app/services/api.service.ts</code></a></h3>
<p>The <code class="inline-code">ApiService</code> serves as the bridge between the frontend and the backend, facilitating communication through HTTP and SSE. It encapsulates the logic for fetching tools and streaming chat messages.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a>: Retrieves the list of tools from the backend API.</li>
<li><a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/services/api.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">streamChatMessage</code></a>: Streams messages from the server, handling real-time updates and parsing SSE data.</li>
<li><code class="inline-code">handleApiError</code>: Centralized error handling for API interactions.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async fetchAvailableTools(): Promise&lt;{tools: Tools[]} | void&gt; {
  try {
    const response = await fetch(`${this.apiUrl}/api/tools`, {
      method: &#39;GET&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
    });
    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred while fetching tools&#39;),
        response.status
      );
    }
    return (await response.json());
  } catch (error) {
    return this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>This method fetches the list of tools from the backend and handles errors gracefully.</li>
<li>It uses the <code class="inline-code">fetch</code> API to make HTTP requests and parses the JSON response.</li>
<li>The <code class="inline-code">handleApiError</code> method is used to encapsulate error handling logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">async streamChatMessage(message: string, tools: Tools[]) {
  try {
    const response = await fetch(`${this.apiUrl}/api/chat`, {
      method: &#39;POST&#39;,
      headers: {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
      },
      body: JSON.stringify({ message, tools }),
    });

    if (!response.ok) {
      const { error } = await response.json();
      return this.handleApiError(
        new Error(error || &#39;An error occurred&#39;),
        response.status
      );
    }

    const decoder = new TextDecoder(&#39;utf-8&#39;);

    if (!response.body) {
      throw new Error(&#39;Readable stream not supported&#39;);
    }

    this.chatStreamState.next({ type: &#39;START&#39; });

    for await (const chunk of response.body) {
      const value = decoder.decode(chunk, { stream: true });

      // Split the chunk by double newlines to handle multiple JSON values
      const jsonValues = value.trim().split(/\n\n+/);

      for (const jsonValue of jsonValues) {
        try {
          const parsedData = JSON.parse(jsonValue);
          this.chatStreamState.next({
            type: &#39;MESSAGE&#39;,
            event: parsedData,
          });
        } catch (error) {
          console.error(&#39;Error parsing JSON chunk:&#39;, error);
        }
      }
    }

    this.chatStreamState.next({ type: &#39;END&#39; });
  } catch (error) {
    this.handleApiError(error, 0);
  }
}
</code></pre>
<ul>
<li>This method streams chat messages from the server, parsing SSE data in real-time.</li>
<li>It uses a <code class="inline-code">TextDecoder</code> to process the incoming stream and handles multiple JSON objects within a single chunk.</li>
<li>The <code class="inline-code">chatStreamState</code> BehaviorSubject is used to propagate updates to subscribers.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">BehaviorSubject</code> to manage state reactively and ensure subscribers receive the latest data.</li>
<li>Leverage the <code class="inline-code">TextDecoder</code> API for efficient processing of SSE streams.</li>
<li>Implement centralized error handling to simplify debugging and improve maintainability.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Event Type</strong>: Extend the <code class="inline-code">processAgentEvents</code> method to handle a new event type, such as <code class="inline-code">AgentFeedback</code>. Update the UI to display this feedback in real-time.</p>
</li>
<li><p><strong>Enhance Error Feedback</strong>: Modify the <code class="inline-code">handleApiError</code> method to include more descriptive error messages and log them to a monitoring service.</p>
</li>
<li><p><strong>Optimize Tool Selection</strong>: Add a feature to prioritize tools based on their response times or reliability, and update the <a href="https://github.com/Azure-Samples/azure-ai-travel-agents/blob/main/src/ui/src/app/chat-conversation/chat-conversation.service.ts#L68" target="_blank" rel="noopener noreferrer"><code class="inline-code">fetchAvailableTools</code></a> method accordingly.</p>
</li>
</ol>
<hr>
<p>You have mastered all the secrets of the enchanted Scroll of Streaming! Your adventure is complete.</p>
<p>With the Scrolls of Streaming now mastered, you ascend as a beacon of wisdom in the mythical realm, forging onward with valor to complete the final quest of your heroic journey‚Äî4 stars gleam in your crown, and the fifth awaits! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>